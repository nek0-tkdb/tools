<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒå±æ€§3æŠã‚¯ã‚¤ã‚º</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆè¦‹ã‚„ã™ã„ã‚ˆã†ã«ï¼‰ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 4px;
        }
        /* ç”»åƒå…¥åŠ›ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .file-input-label {
            display: block;
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: #fff;
            background-color: #4f46e5; /* indigo-600 */
            text-align: center;
            transition: background-color 0.2s, transform 0.1s;
        }
        .file-input-label:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .file-input-label:active {
            transform: scale(0.98);
        }
        .file-input-label input[type="file"] {
            display: none;
        }
        /* URLã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ */
        .copy-btn {
            background-color: #3b82f6;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            line-height: 1rem;
            transition: background-color 0.15s;
        }
        .copy-btn:hover {
            background-color: #2563eb;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-8 relative">
        <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã“ã“ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¾ã™ -->
    </div>
    
    <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒœãƒ‡ã‚£ç›´ä¸‹ã«é…ç½® -->
    <div id="custom-modal-container"></div>

    <script type="module">
        // Firebase V11ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, onSnapshot, 
            addDoc, deleteDoc, doc, setLogLevel, setDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Cloud Storage for Firebaseã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


        // =======================================================
        // 1. ç’°å¢ƒå¤‰æ•°ã¨å®šæ•°
        // =======================================================

        // Canvasç’°å¢ƒã‹ã‚‰æä¾›ã•ã‚Œã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // æ¥ç¶šå…ˆã®Firebaseè¨­å®šã‚’æ±ºå®šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
        // â˜… æ‰‹å‹•è¨­å®šã‚¨ãƒªã‚¢ã‚’å‰Šé™¤ã—ã€Canvasç’°å¢ƒãŒæä¾›ã™ã‚‹è¨­å®šæƒ…å ±ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«æˆ»ã—ã¾ã™ã€‚
        let firebaseConfig = null;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            console.error("FATAL: No Firebase configuration found.");
        }

        // å±æ€§ã®å®šç¾© (å¤‰æ›´ãªã—)
        const TYPES = [
            { key: 'fire', name: 'ç«', color: 'text-red-600', bgColor: 'bg-red-500', hoverColor: 'hover:bg-red-600', ringColor: 'focus:ring-red-500', icon: 'ğŸ”¥' },
            { key: 'water', name: 'æ°´', color: 'text-blue-600', bgColor: 'bg-blue-500', hoverColor: 'hover:bg-blue-600', ringColor: 'focus:ring-blue-500', icon: 'ğŸ’§' },
            { key: 'grass', name: 'è‰', color: 'text-green-600', bgColor: 'bg-green-500', hoverColor: 'hover:bg-green-600', ringColor: 'focus:ring-green-500', icon: 'ğŸŒ¿' },
        ];
        const TYPE_MAP = TYPES.reduce((acc, t) => ({ ...acc, [t.key]: t }), {});
        const QUIZ_LENGTH = 5;

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹
        let appState = {
            screen: 'loading', // 'loading', 'home', 'quiz', 'result', 'admin', 'add', 'edit'
            quizData: [], // å…¨å•é¡Œãƒ‡ãƒ¼ã‚¿
            currentQuiz: [], // 5å•ã®å‡ºé¡Œãƒªã‚¹ãƒˆ
            currentQuestionIndex: 0,
            score: 0,
            isAuthReady: false,
            db: null,
            auth: null,
            storage: null, // Firebase Storage ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
            userId: null,
            lastAnswerCorrect: null,
            selectedAnswer: null,
            isUploading: false, 
            editingQuestion: null, // ç·¨é›†ä¸­ã®å•é¡Œãƒ‡ãƒ¼ã‚¿
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã®çŠ¶æ…‹
            modal: { 
                isOpen: false, 
                type: 'alert',
                title: '',
                message: '', 
                onConfirm: null 
            }
        };

        const appElement = document.getElementById('app');
        const modalContainer = document.getElementById('custom-modal-container');

        // =======================================================
        // 2. FirebaseåˆæœŸåŒ–ã¨èªè¨¼ 
        // =======================================================

        /**
         * Firebaseã‚’åˆæœŸåŒ–ã—ã€èªè¨¼çŠ¶æ…‹ã‚’ç¢ºç«‹ã™ã‚‹
         */
        async function initFirebase() {
            // DEBUG: å®Ÿè¡Œé–‹å§‹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
            console.log("DEBUG: initFirebase function started."); 

            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                // DEBUG: configãŒnullã§ã‚ã‚‹ã“ã¨ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
                console.log("DEBUG: firebaseConfig is NULL."); 
                appState.screen = 'error';
                render();
                return;
            }

            // Firebase Configã®å†…å®¹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¦ã€æ¥ç¶šå…ˆã‚’ç¢ºèª
            console.log("Firebase Config (Active):", firebaseConfig);

            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                const storage = getStorage(app); // Storageã‚’åˆæœŸåŒ–
                setLogLevel('Debug'); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹

                appState.db = db;
                appState.auth = auth;
                appState.storage = storage;

                // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        appState.userId = user.uid;
                        console.log("Authenticated as:", appState.userId);

                        // èªè¨¼å®Œäº†å¾Œã€ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                        appState.isAuthReady = true;
                        fetchQuizData();
                        
                    } else {
                        // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã€ãªã‘ã‚Œã°åŒ¿åèªè¨¼ã‚’è¡Œã†
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                appState.screen = 'error';
                render();
            }
        }

        // =======================================================
        // 3. Firestoreãƒ‡ãƒ¼ã‚¿æ“ä½œ 
        // =======================================================
        const getCollectionPath = () => `artifacts/${appId}/public/data/quiz_data`;

        /**
         * Firestoreã‹ã‚‰ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å–å¾—
         */
        function fetchQuizData() {
            if (!appState.db || !appState.isAuthReady) return;

            const quizCol = collection(appState.db, getCollectionPath());
            
            // onSnapshotã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
            onSnapshot(quizCol, (snapshot) => {
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                appState.quizData = data.filter(item => TYPES.some(t => t.key === item.type));
                console.log("Quiz data updated:", appState.quizData.length, "items.");

                if (appState.screen === 'loading') {
                    appState.screen = 'home';
                }
                render();
            }, (error) => {
                console.error("Error fetching quiz data:", error);
                if (appState.screen === 'loading') {
                    appState.screen = 'home';
                }
                render();
            });
        }

        /**
         * ç”»åƒã‚’Cloud Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ãã®URLã‚’å–å¾—ã™ã‚‹ (å¤‰æ›´ãªã—)
         */
        async function uploadImage(file) {
            if (!appState.storage) throw new Error("Firebase Storage is not initialized.");
            
            const filePath = `quiz_images/${appId}/${Date.now()}-${file.name}`;
            const storageRef = ref(appState.storage, filePath);
            
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            
            return downloadURL;
        }

        /**
         * æ–°ã—ã„å•é¡Œã‚’è¿½åŠ 
         */
        async function addQuestion(name, type, file, directUrl) {
            if (!appState.db) return console.error("Database not initialized.");
            
            appState.isUploading = true;
            render();

            let imageUrl = directUrl; 
            
            try {
                if (file) {
                    imageUrl = await uploadImage(file);
                } else if (!directUrl) {
                    throw new Error("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ç”»åƒURLãŒå¿…è¦ã§ã™ã€‚");
                }
                
                await addDoc(collection(appState.db, getCollectionPath()), {
                    name,
                    type,
                    imageUrl,
                    createdAt: new Date().toISOString()
                });
                
                appState.screen = 'admin';
            } catch (error) {
                console.error("Error adding document or uploading image:", error);
                const isUnauthorized = error.message.includes('storage/unauthorized');
                if (isUnauthorized) {
                    showModal('alert', 'æ¨©é™ã‚¨ãƒ©ãƒ¼', 'Cloud Storageã¸ã®ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚è©³ç´°ã¯ç®¡ç†ç”»é¢ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚');
                } else {
                    showModal('alert', 'ã‚¨ãƒ©ãƒ¼', `å•é¡Œã®ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                }
            } finally {
                appState.isUploading = false;
                render();
            }
        }

        /**
         * æ—¢å­˜ã®å•é¡Œã‚’æ›´æ–° (NEW)
         */
        async function updateQuestion(id, name, type, imageUrl) {
            if (!appState.db) return console.error("Database not initialized.");
            
            appState.isUploading = true;
            render();

            try {
                const questionDocRef = doc(appState.db, getCollectionPath(), id);
                await setDoc(questionDocRef, {
                    name,
                    type,
                    imageUrl,
                    updatedAt: new Date().toISOString()
                }, { merge: true }); // merge: trueã§æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¸Šæ›¸ãã—ãªã„
                
                appState.screen = 'admin';
            } catch (error) {
                console.error("Error updating document:", error);
                showModal('alert', 'ã‚¨ãƒ©ãƒ¼', `å•é¡Œã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                appState.isUploading = false;
                render();
            }
        }

        /**
         * å•é¡Œã‚’å‰Šé™¤ (å¤‰æ›´ãªã—)
         */
        async function deleteQuestion(id) {
            if (!appState.db) return console.error("Database not initialized.");
            
            try {
                await deleteDoc(doc(appState.db, getCollectionPath(), id));
            } catch (error) {
                console.error("Error deleting document:", error);
                showModal('alert', 'ã‚¨ãƒ©ãƒ¼', 'å•é¡Œã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // =======================================================
        // 4. ã‚¯ã‚¤ã‚ºãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—)
        // =======================================================
        
        function startQuiz() {
            if (appState.quizData.length < QUIZ_LENGTH) {
                showModal('alert', 'å•é¡Œæ•°ä¸è¶³', `ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹ã«ã¯æœ€ä½${QUIZ_LENGTH}å•ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™ã€‚ï¼ˆç¾åœ¨: ${appState.quizData.length}å•ï¼‰`);
                appState.screen = 'admin';
                render();
                return;
            }
            const shuffled = [...appState.quizData].sort(() => 0.5 - Math.random());
            appState.currentQuiz = shuffled.slice(0, QUIZ_LENGTH);
            appState.currentQuestionIndex = 0;
            appState.score = 0;
            appState.lastAnswerCorrect = null;
            appState.selectedAnswer = null;
            appState.screen = 'quiz';
            render();
        }

        function checkAnswer(selectedType) {
            const currentQ = appState.currentQuiz[appState.currentQuestionIndex];
            const isCorrect = currentQ.type === selectedType;
            appState.lastAnswerCorrect = isCorrect;
            appState.selectedAnswer = selectedType;
            
            if (isCorrect) {
                appState.score++;
            }
            render();

            setTimeout(() => {
                appState.currentQuestionIndex++;
                appState.lastAnswerCorrect = null;
                appState.selectedAnswer = null;

                if (appState.currentQuestionIndex >= QUIZ_LENGTH) {
                    appState.screen = 'result';
                }
                render();
            }, 1000);
        }

        // =======================================================
        // 5. ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—)
        // =======================================================

        function showModal(type, title, message, onConfirm = null) {
            appState.modal = { isOpen: true, type, title, message, onConfirm };
            render();
        }

        function closeModal() {
            appState.modal = { isOpen: false, type: 'alert', title: '', message: '', onConfirm: null };
            render();
        }

        function handleModalConfirm() {
            if (appState.modal.onConfirm) {
                appState.modal.onConfirm();
            }
            closeModal();
        }

        // =======================================================
        // 6. UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° 
        // =======================================================

        /**
         * å…¨ä½“ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‡¦ç†
         */
        function render() {
            let html = '';
            switch (appState.screen) {
                case 'loading': html = renderLoadingScreen(); break;
                case 'home': html = renderHomeScreen(); break;
                case 'quiz': html = renderQuizScreen(); break;
                case 'result': html = renderResultScreen(); break;
                case 'admin': html = renderAdminScreen(); break;
                case 'add': html = renderAddQuestionScreen(); break;
                case 'edit': html = renderEditQuestionScreen(); break;
                case 'error': html = renderErrorScreen(); break;
            }
            appElement.innerHTML = html;
            renderModal();
            attachEventListeners();
        }

        /**
         * å•é¡Œç·¨é›†ç”»é¢ã¸ã®é·ç§» (NEW)
         */
        function goToEditScreen(id) {
            const question = appState.quizData.find(q => q.id === id);
            if (question) {
                appState.editingQuestion = question;
                appState.screen = 'edit';
                render();
            } else {
                showModal('alert', 'ã‚¨ãƒ©ãƒ¼', 'ç·¨é›†å¯¾è±¡ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            }
        }


        function attachEventListeners() {
            const attach = (selector, event, handler) => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    const clone = el.cloneNode(true);
                    el.parentNode.replaceChild(clone, el);
                });
                document.querySelectorAll(selector).forEach(el => el.addEventListener(event, handler));
            };

            // ç”»é¢é·ç§»ãƒœã‚¿ãƒ³
            attach('#start-quiz-btn', 'click', startQuiz);
            attach('.go-home-btn', 'click', () => { appState.screen = 'home'; render(); });
            attach('#go-admin-btn', 'click', () => { appState.screen = 'admin'; render(); });
            attach('#go-add-btn', 'click', () => { appState.screen = 'add'; render(); });
            attach('#retry-btn', 'click', startQuiz);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³
            attach('#modal-close-btn', 'click', closeModal);
            attach('#modal-cancel-btn', 'click', closeModal);
            attach('#modal-confirm-btn', 'click', handleModalConfirm);

            // ã‚¯ã‚¤ã‚ºå›ç­”ãƒœã‚¿ãƒ³
            attach('.quiz-answer-btn', 'click', (e) => {
                if (appState.lastAnswerCorrect === null) {
                    checkAnswer(e.currentTarget.dataset.type);
                }
            });

            // å•é¡Œè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ 
            const addForm = document.getElementById('add-question-form');
            if (addForm) {
                addForm.onsubmit = (e) => {
                    e.preventDefault();
                    if (appState.isUploading) return;

                    const name = document.getElementById('question-name').value;
                    const type = document.getElementById('question-type').value;
                    const fileInput = document.getElementById('question-image-file');
                    const urlInput = document.getElementById('question-image-url');

                    const file = fileInput.files[0];
                    const directUrl = urlInput.value.trim();

                    if (name && type && (file || directUrl)) {
                        addQuestion(name, type, file, directUrl);
                    } else {
                        showModal('alert', 'å…¥åŠ›ä¸è¶³', 'å•é¡Œåã€å±æ€§ã€ãã—ã¦ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«**ã¾ãŸã¯**ç”»åƒURLã®ã„ãšã‚Œã‹ãŒå¿…è¦ã§ã™ã€‚');
                    }
                };
            }
            
            // å•é¡Œç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  (NEW)
            const editForm = document.getElementById('edit-question-form');
            if (editForm && appState.editingQuestion) {
                editForm.onsubmit = (e) => {
                    e.preventDefault();
                    if (appState.isUploading) return;

                    const id = appState.editingQuestion.id;
                    const name = document.getElementById('edit-question-name').value;
                    const type = document.getElementById('edit-question-type').value;
                    const imageUrl = document.getElementById('edit-question-image-url').value.trim();
                    
                    if (name && type && imageUrl) {
                        updateQuestion(id, name, type, imageUrl);
                    } else {
                        showModal('alert', 'å…¥åŠ›ä¸è¶³', 'å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    }
                };
            }


            // å•é¡Œç·¨é›†ãƒœã‚¿ãƒ³ (NEW)
            attach('.edit-question-btn', 'click', (e) => {
                const id = e.currentTarget.dataset.id;
                goToEditScreen(id);
            });

            // å•é¡Œå‰Šé™¤ãƒœã‚¿ãƒ³ (å¤‰æ›´ãªã—)
            attach('.delete-question-btn', 'click', (e) => {
                const id = e.currentTarget.dataset.id;
                const name = e.currentTarget.dataset.name;
                showModal('confirm', 'ç¢ºèª', `æœ¬å½“ã«å•é¡Œã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`, () => {
                    deleteQuestion(id);
                });
            });

            // URLã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ (NEW)
            attach('.copy-url-btn', 'click', (e) => {
                const url = e.currentTarget.dataset.url;
                if (url) {
                    try {
                        // navigator.clipboard.writeTextãŒiframeå†…ã§åˆ¶é™ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€execCommandã‚’ä½¿ç”¨
                        const tempInput = document.createElement('textarea');
                        tempInput.value = url;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showModal('alert', 'ã‚³ãƒ”ãƒ¼å®Œäº†', 'ç”»åƒ URL ãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸã€‚');
                    } catch (err) {
                        showModal('alert', 'ã‚³ãƒ”ãƒ¼å¤±æ•—', 'URL ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã‚’æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
                    }
                }
            });
        }

        // ======================
        // 6.1 ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (å¤‰æ›´ãªã—)
        // ======================
        function renderModal() {
            if (!appState.modal.isOpen) {
                modalContainer.innerHTML = '';
                return;
            }

            const { type, title, message } = appState.modal;
            
            const buttons = type === 'confirm' ? `
                <button id="modal-cancel-btn" class="flex-1 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-200">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modal-confirm-btn" class="flex-1 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200">å‰Šé™¤ã™ã‚‹</button>
            ` : `
                <button id="modal-close-btn" class="w-full py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200">é–‰ã˜ã‚‹</button>
            `;

            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" id="custom-modal-backdrop">
                    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100 ease-out duration-300">
                        <h3 class="text-xl font-bold text-gray-900 mb-3">${title}</h3>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <div class="flex gap-3">
                            ${buttons}
                        </div>
                    </div>
                </div>
            `;
        }

        // ======================
        // 6.2 ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ (è¿½åŠ )
        // ======================
        function renderLoadingScreen() {
            return `
                <div class="flex flex-col items-center justify-center p-12">
                    <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-lg text-gray-600 font-medium">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    <p class="text-xs text-gray-400 mt-1">èªè¨¼ã¨Firestoreæ¥ç¶šã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™</p>
                </div>
            `;
        }
        
        // ======================
        // 6.3 ã‚¨ãƒ©ãƒ¼ç”»é¢ (è¿½åŠ )
        // ======================
        function renderErrorScreen() {
            return `
                <div class="text-center p-8 bg-red-100 border border-red-400 rounded-xl">
                    <h2 class="text-2xl font-bold text-red-600 mb-4">è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
                    <p class="text-gray-700">Firebaseã®åˆæœŸåŒ–ã¾ãŸã¯è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            `;
        }


        // ======================
        // 6.4 ãƒ›ãƒ¼ãƒ ç”»é¢ (è¿½åŠ )
        // ======================
        function renderHomeScreen() {
            const dataCount = appState.quizData.length;
            const startDisabled = dataCount < QUIZ_LENGTH;

            return `
                <div class="text-center">
                    <h1 class="text-4xl font-extrabold text-gray-800 mb-4 flex items-center justify-center gap-2">
                        <span>å±æ€§ã‚¯ã‚¤ã‚º</span>
                        <span class="text-red-500 text-5xl">ğŸ”¥</span>
                        <span class="text-blue-500 text-5xl">ğŸ’§</span>
                        <span class="text-green-500 text-5xl">ğŸŒ¿</span>
                    </h1>
                    <p class="text-gray-600 mb-8">ç”»åƒã‚’è¦‹ã¦ã€ã€Œç«ã€ã€Œæ°´ã€ã€Œè‰ã€ã®ã©ã®å±æ€§ã‹ã‚’å½“ã¦ã‚‹5å•ã‚¯ã‚¤ã‚ºã§ã™ã€‚</p>
                    
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner mb-8 border border-gray-200">
                        <p class="text-xl font-semibold text-gray-700">
                            ç¾åœ¨ã®å•é¡Œæ•°: <span class="text-indigo-600 font-extrabold">${dataCount}</span> å•
                            <span class="text-sm text-gray-500">ï¼ˆå¿…è¦: ${QUIZ_LENGTH}å•ï¼‰</span>
                        </p>
                    </div>

                    <button id="start-quiz-btn"
                        class="w-full md:w-2/3 px-8 py-4 bg-indigo-600 text-white font-black rounded-xl text-xl shadow-xl transition duration-300 ease-in-out ${startDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-indigo-700 hover:scale-[1.02] active:scale-100'}">
                        ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆ
                    </button>
                    
                    <button id="go-admin-btn"
                        class="mt-4 w-full md:w-2/3 px-6 py-2 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg text-sm transition duration-200 hover:bg-gray-100 hover:shadow-md">
                        å•é¡Œãƒ‡ãƒ¼ã‚¿ã®ç®¡ç† (${dataCount} ä»¶)
                    </button>
                    ${startDisabled ? `<p class="mt-4 text-red-500 font-medium text-sm">å•é¡Œæ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ç®¡ç†ç”»é¢ã‹ã‚‰å•é¡Œã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>` : ''}
                </div>
            `;
        }

        // ======================
        // 6.5 ã‚¯ã‚¤ã‚ºç”»é¢ (è¿½åŠ )
        // ======================
        function renderQuizScreen() {
            const q = appState.currentQuiz[appState.currentQuestionIndex];
            if (!q) return renderResultScreen(); // å¿µã®ãŸã‚

            const typeKeys = TYPES.map(t => t.key).sort(() => 0.5 - Math.random()); // é¸æŠè‚¢ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã³æ›¿ãˆ
            
            const typeButtons = typeKeys.map(key => {
                const type = TYPE_MAP[key];
                const isSelected = appState.selectedAnswer === key;
                const isCorrectAnswer = q.type === key;
                const isAnswered = appState.lastAnswerCorrect !== null;

                let buttonClass = 'py-3 px-2 rounded-lg text-lg transition duration-200 shadow-md quiz-answer-btn w-full';
                let contentClass = `flex flex-col items-center justify-center font-bold text-gray-800 ${type.bgColor} bg-opacity-20`;
                let ringClass = '';

                if (isAnswered) {
                    // å›ç­”å¾Œã®ã‚¹ã‚¿ã‚¤ãƒ«
                    if (isCorrectAnswer) {
                        // æ­£è§£ã®ãƒœã‚¿ãƒ³
                        buttonClass = 'py-3 px-2 rounded-lg text-lg shadow-xl ring-4 ring-green-400 bg-green-500 pointer-events-none';
                        contentClass = 'flex flex-col items-center justify-center font-bold text-white bg-green-500 bg-opacity-100';
                    } else if (isSelected && !isCorrectAnswer) {
                        // é¸æŠã—ãŸã‘ã©ä¸æ­£è§£ã®ãƒœã‚¿ãƒ³
                        buttonClass = 'py-3 px-2 rounded-lg text-lg shadow-xl ring-4 ring-red-400 bg-red-500 pointer-events-none';
                        contentClass = 'flex flex-col items-center justify-center font-bold text-white bg-red-500 bg-opacity-100';
                    } else {
                        // ãã®ä»–ï¼ˆä¸æ­£è§£ã®çŠ¶æ…‹ã§é¸ã°ãªã‹ã£ãŸãƒœã‚¿ãƒ³ï¼‰
                        buttonClass = 'py-3 px-2 rounded-lg text-lg shadow-inner bg-gray-200 text-gray-500 pointer-events-none';
                        contentClass = 'flex flex-col items-center justify-center font-bold text-gray-500 bg-gray-300 bg-opacity-50';
                    }
                } else {
                    // å›ç­”å‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
                    buttonClass += ` ${type.bgColor} hover:shadow-lg hover:scale-[1.05] active:scale-100`;
                }

                return `
                    <button data-type="${key}"
                        class="${buttonClass}"
                        ${isAnswered ? 'disabled' : ''}>
                        <span class="${contentClass} p-2 rounded-md">
                            <span class="text-4xl">${type.icon}</span>
                            <span>${type.name}</span>
                        </span>
                    </button>
                `;
            }).join('');

            // æ­£èª¤ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            let feedback = '';
            if (appState.lastAnswerCorrect !== null) {
                const typeName = TYPE_MAP[q.type].name;
                const feedbackClass = appState.lastAnswerCorrect 
                    ? 'bg-green-500 text-white shadow-xl' 
                    : 'bg-red-500 text-white shadow-xl';
                feedback = `
                    <div class="fixed inset-0 flex items-center justify-center z-40 backdrop-blur-sm">
                        <div class="p-8 rounded-full font-black text-3xl text-center transition duration-300 transform scale-100 ${feedbackClass} animate-bounce">
                            ${appState.lastAnswerCorrect ? 'â­• æ­£è§£ï¼' : `âŒ ä¸æ­£è§£ï¼ (${typeName})`}
                        </div>
                    </div>
                `;
            }

            return `
                <div>
                    ${feedback}
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold text-gray-800">å•é¡Œ ${appState.currentQuestionIndex + 1} / ${QUIZ_LENGTH}</h2>
                        <div class="text-lg font-semibold text-gray-600 bg-indigo-100 p-2 rounded-full px-4 shadow-inner">
                            ã‚¹ã‚³ã‚¢: <span class="text-indigo-600 font-extrabold">${appState.score}</span>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl shadow-lg mb-8 border border-gray-200">
                        <p class="text-xl font-bold text-gray-800 mb-4 text-center">ã“ã®ç”»åƒã«è¨­å®šã•ã‚ŒãŸå±æ€§ã‚’å½“ã¦ã¦ãã ã•ã„ã€‚</p>
                        
                        <div class="h-64 flex items-center justify-center bg-gray-200 rounded-lg overflow-hidden border-4 border-gray-300 relative">
                            <img src="${q.imageUrl}" alt="ã‚¯ã‚¤ã‚ºç”»åƒ" onerror="this.onerror=null; this.src='https://placehold.co/400x400/CCCCCC/888888?text=Image+Load+Error';" class="object-contain w-full h-full p-2">
                            <div class="absolute top-2 left-2 bg-black bg-opacity-50 text-white text-xs font-mono px-2 py-1 rounded-md">
                                NAME: ${q.name}
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 mt-6">
                        ${typeButtons}
                    </div>

                    <button class="go-home-btn mt-6 w-full py-2 text-sm text-gray-500 hover:text-gray-700 transition">
                        ã‚¯ã‚¤ã‚ºã‚’ä¸­æ–­ã—ã¦ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                    </button>
                </div>
            `;
        }

        // ======================
        // 6.6 çµæœç”»é¢ (è¿½åŠ )
        // ======================
        function renderResultScreen() {
            const isPerfect = appState.score === QUIZ_LENGTH;
            const message = isPerfect ? 'ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ‰ å…¨å•æ­£è§£ã§ã™ï¼' : `ä»Šå›ã¯æƒœã—ã‹ã£ãŸã§ã™ã­ã€‚ã‚¹ã‚³ã‚¢ã¯${QUIZ_LENGTH}å•ä¸­${appState.score}ç‚¹ã§ã—ãŸã€‚`;
            const resultClass = isPerfect ? 'bg-yellow-100 text-yellow-800 border-yellow-500' : 'bg-indigo-100 text-indigo-800 border-indigo-500';
            const buttonClass = isPerfect ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-indigo-600 hover:bg-indigo-700';

            return `
                <div class="text-center p-8">
                    <h2 class="text-4xl font-extrabold text-gray-800 mb-6">ã‚¯ã‚¤ã‚ºçµæœç™ºè¡¨</h2>
                    
                    <div class="p-6 rounded-xl border-4 ${resultClass} mb-8 shadow-2xl">
                        <p class="text-2xl font-bold mb-4">${message}</p>
                        <p class="text-7xl font-black mt-4">${appState.score} <span class="text-4xl text-gray-500"> / ${QUIZ_LENGTH}</span></p>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 justify-center">
                        <button id="retry-btn"
                            class="flex-1 px-8 py-4 ${buttonClass} text-white font-black rounded-xl text-lg shadow-lg transition duration-200 hover:scale-[1.02]">
                            ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦
                        </button>
                        <button class="go-home-btn flex-1 px-8 py-4 bg-gray-200 text-gray-800 font-bold rounded-xl text-lg shadow-lg hover:bg-gray-300 transition duration-200">
                            ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                        </button>
                    </div>
                </div>
            `;
        }

        // ======================
        // 6.7 ç®¡ç†ç”»é¢ (è¿½åŠ )
        // ======================
        function renderAdminScreen() {
            const dataList = appState.quizData.map(q => {
                const type = TYPE_MAP[q.type];
                return `
                    <div class="flex items-center justify-between p-3 border-b border-gray-100 last:border-b-0 hover:bg-gray-50 transition duration-150">
                        <div class="flex-1 min-w-0 pr-4">
                            <p class="text-sm font-semibold text-gray-800 truncate">${q.name}</p>
                            <p class="text-xs ${type.color} font-black flex items-center gap-1">
                                <span class="text-lg">${type.icon}</span> ${type.name}
                            </p>
                            <div class="flex items-center mt-1">
                                <p class="text-xs text-gray-500 truncate mr-2">${q.imageUrl}</p>
                                <button data-url="${q.imageUrl}" class="copy-url-btn flex-shrink-0">ã‚³ãƒ”ãƒ¼</button>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${q.id}" class="edit-question-btn bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-bold py-1 px-3 rounded-full transition duration-150 shadow-md active:shadow-inner">
                                ç·¨é›†
                            </button>
                            <button data-id="${q.id}" data-name="${q.name}" class="delete-question-btn bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-full transition duration-150 shadow-md active:shadow-inner">
                                å‰Šé™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Storageæ¨©é™ã«é–¢ã™ã‚‹æ³¨æ„æ›¸ã
            const securityWarning = `
                <div class="mt-8 p-4 bg-red-50 border border-red-300 rounded-lg text-sm">
                    <p class="font-bold text-red-700 mb-2">ğŸ’¡ GitHub Pages ã‚’åˆ©ç”¨ã—ã¦ç”»åƒã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹å ´åˆ</p>
                    <p class="text-gray-700 mb-2">Cloud Storage ã®è¨­å®šãŒé›£ã—ã„å ´åˆã¯ã€GitHub Pages ã‚„ Imgur ãªã©å¤–éƒ¨ã®ç”»åƒãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ã€**ç·¨é›†ç”»é¢**ã‹ã‚‰ãã® URL ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚ãã®å ´åˆã€Storage ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã¯ä¸è¦ã§ã™ã€‚</p>
                </div>
            `;

            const userIdDisplay = appState.userId ? `
                <p class="text-xs text-gray-500 mt-2">
                    ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (ãƒ‡ãƒãƒƒã‚°ç”¨): ${appState.userId}
                </p>
            ` : '';


            return `
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">å•é¡Œãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                    <p class="mb-4 text-gray-600">ç¾åœ¨ã€å…¨${appState.quizData.length}å•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                    ${userIdDisplay}

                    <button id="go-add-btn"
                        class="w-full mb-6 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-200 shadow-lg hover:shadow-xl">
                        + æ–°ã—ã„å•é¡Œã‚’è¿½åŠ 
                    </button>

                    <div class="max-h-96 overflow-y-auto bg-white border border-gray-200 rounded-xl shadow-inner divide-y">
                        ${dataList.length > 0 ? dataList : '<p class="text-center p-6 text-gray-500">ã¾ã å•é¡ŒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>'}
                    </div>
                    
                    ${securityWarning}

                    <button class="go-home-btn mt-6 w-full py-2 text-sm text-gray-500 hover:text-gray-700 transition">
                        ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                    </button>
                </div>
            `;
        }
        
        // ======================
        // 6.9 å•é¡Œç·¨é›†ç”»é¢ (è¿½åŠ )
        // ======================
        function renderEditQuestionScreen() {
            const q = appState.editingQuestion;
            if (!q) {
                appState.screen = 'admin';
                return renderAdminScreen();
            }

            const typeOptions = TYPES.map(t => `<option value="${t.key}" ${q.type === t.key ? 'selected' : ''}>${t.icon} ${t.name} (${t.key})</option>`).join('');
            
            const saveButtonContent = appState.isUploading ? `
                <svg class="animate-spin h-5 w-5 text-white mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>ä¿å­˜ä¸­...</span>
            ` : `
                å¤‰æ›´ã‚’ä¿å­˜
            `;

            return `
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">å•é¡Œã®ç·¨é›†: ${q.name}</h2>
                    
                    <form id="edit-question-form" class="space-y-5 p-6 bg-yellow-50 rounded-xl shadow-lg border border-yellow-200">
                        <!-- å•é¡Œå -->
                        <div>
                            <label for="edit-question-name" class="block text-sm font-bold text-gray-700 mb-1">å•é¡Œå</label>
                            <input type="text" id="edit-question-name" value="${q.name}" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm">
                        </div>
                        
                        <!-- å±æ€§ -->
                        <div>
                            <label for="edit-question-type" class="block text-sm font-bold text-gray-700 mb-1">å±æ€§ (ç­”ãˆ)</label>
                            <select id="edit-question-type" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm">
                                ${typeOptions}
                            </select>
                        </div>

                        <!-- ç”»åƒURL -->
                        <div class="border-t border-gray-200 pt-4">
                            <label for="edit-question-image-url" class="block text-sm font-bold text-gray-700 mb-1">ç”»åƒURL (GitHub Pages URLãªã©)</label>
                            <input type="url" id="edit-question-image-url" value="${q.imageUrl}" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm">
                            <p class="mt-1 text-xs text-gray-500">GitHub Pagesãªã©ã§å…¬é–‹ã—ãŸ**ç›´ãƒªãƒ³ã‚¯**ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
                            <div class="h-40 flex items-center justify-center bg-gray-200 rounded-lg overflow-hidden mt-3">
                                <img src="${q.imageUrl}" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" onerror="this.onerror=null; this.src='https://placehold.co/400x160/FFD700/000?text=Preview';" class="object-contain w-full h-full p-2">
                            </div>
                        </div>
                        
                        <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
                        <button type="submit"
                            class="w-full py-3 bg-indigo-600 text-white font-black rounded-lg transition duration-200 shadow-xl text-lg flex items-center justify-center ${appState.isUploading ? 'opacity-60 cursor-not-allowed' : 'hover:bg-indigo-700 hover:scale-[1.01] active:scale-100'}"
                            ${appState.isUploading ? 'disabled' : ''}>
                            ${saveButtonContent}
                        </button>
                    </form>

                    <button onclick="(() => { appState.screen = 'admin'; render(); })()" class="mt-4 w-full py-2 text-sm text-gray-500 hover:text-gray-700 transition">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ç®¡ç†ç”»é¢ã«æˆ»ã‚‹
                    </button>
                </div>
            `;
        }


        // ======================
        // 6.8 å•é¡Œè¿½åŠ ç”»é¢ (ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ç¶­æŒ)
        // ======================
        function renderAddQuestionScreen() {
            const typeOptions = TYPES.map(t => `<option value="${t.key}">${t.icon} ${t.name} (${t.key})</option>`).join('');

            const uploadButtonContent = appState.isUploading ? `
                <svg class="animate-spin h-5 w-5 text-white mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</span>
            ` : `
                å•é¡Œã‚’ç™»éŒ²
            `;

            return `
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">æ–°ã—ã„å•é¡Œã®è¿½åŠ </h2>
                    
                    <form id="add-question-form" class="space-y-5 p-6 bg-gray-50 rounded-xl shadow-lg border border-gray-200">
                        <!-- å•é¡Œå -->
                        <div>
                            <label for="question-name" class="block text-sm font-bold text-gray-700 mb-1">å•é¡Œå (ä¾‹: ç«å±±)</label>
                            <input type="text" id="question-name" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm">
                        </div>
                        
                        <!-- å±æ€§ -->
                        <div>
                            <label for="question-type" class="block text-sm font-bold text-gray-700 mb-1">å±æ€§ (ç­”ãˆ)</label>
                            <select id="question-type" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm">
                                ${typeOptions}
                            </select>
                        </div>

                        <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/URLå…¥åŠ› -->
                        <div class="border-t border-b border-gray-200 py-4">
                            <label class="block text-base font-extrabold text-gray-800 mb-3">ç”»åƒã‚½ãƒ¼ã‚¹</label>

                            <label for="question-image-file" class="file-input-label flex items-center justify-center gap-2 mb-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                <span>ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (Storage)</span>
                            </label>
                            <input type="file" id="question-image-file" accept="image/*" class="hidden">
                            <p class="text-xs text-gray-500 text-center mb-4">ï¼ˆCloud Storageã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã¾ã™ï¼‰</p>

                            <div class="flex items-center my-3">
                                <div class="flex-grow border-t border-gray-300"></div>
                                <span class="flex-shrink mx-4 text-gray-500 text-sm">ã¾ãŸã¯</span>
                                <div class="flex-grow border-t border-gray-300"></div>
                            </div>

                            <label for="question-image-url" class="block text-sm font-bold text-gray-700 mb-1">ç›´æ¥URLã‚’å…¥åŠ› (GitHub Pagesãªã©)</label>
                            <input type="url" id="question-image-url" placeholder="ç”»åƒã‚’ç›´æ¥ç¤ºã™URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm">
                            <p class="mt-1 text-xs text-gray-500">å¤–éƒ¨ã®å…¬é–‹ç”»åƒURLã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€‚</p>
                        </div>
                        
                        <!-- ç™»éŒ²ãƒœã‚¿ãƒ³ -->
                        <button type="submit"
                            class="w-full py-3 bg-indigo-600 text-white font-black rounded-lg transition duration-200 shadow-xl text-lg flex items-center justify-center ${appState.isUploading ? 'opacity-60 cursor-not-allowed' : 'hover:bg-indigo-700 hover:scale-[1.01] active:scale-100'}"
                            ${appState.isUploading ? 'disabled' : ''}>
                            ${uploadButtonContent}
                        </button>
                    </form>

                    <button id="go-admin-btn" class="mt-4 w-full py-2 text-sm text-gray-500 hover:text-gray-700 transition">
                        ç®¡ç†ç”»é¢ã«æˆ»ã‚‹
                    </button>
                </div>
            `;
        }

        // =======================================================
        // 7. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        // =======================================================

        window.onload = initFirebase;
    </script>
</body>
</html>
