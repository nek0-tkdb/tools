<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ミリしらシートメーカー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; overscroll-behavior: none; }
        
        .a4-landscape {
            width: 1123px;
            height: 794px;
            background: white;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
            display: grid;
        }
        
        .slot-box { border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; background: #fff; }
        .slot-img-container { width: 100%; aspect-ratio: 1 / 1; border-bottom: 1px solid #333; overflow: hidden; position: relative; flex-shrink: 0; background: #eee; }
        .slot-info { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .slot-name { height: 24px; border-bottom: 1px solid #ccc; background: #fafafa; flex-shrink: 0; font-size: 10px; padding-left: 4px; display: flex; align-items: center; justify-content: flex-start; text-align: left; color: #666; }
        .slot-desc { flex: 1; background: #fff; font-size: 10px; padding: 4px; color: #666; line-height: 1.2; text-align: left; }
        
        .preview-wrapper { width: 100%; overflow: hidden; display: flex; justify-content: center; }
        .preview-scale { transform: scale(0.6); transform-origin: top center; margin-bottom: -320px; }
        @media (max-width: 1200px) { .preview-scale { transform: scale(0.45); margin-bottom: -430px; } }
        @media (max-width: 768px) { .preview-scale { transform: scale(0.3); margin-bottom: -550px; } }

        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        .no-transform { transform: none !important; margin-bottom: 0 !important; }

        [v-cloak] { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-6xl mx-auto" v-cloak>
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800 cursor-pointer" @click="view = 'main'">ミリしらシートメーカー</h1>
            <div class="flex items-center gap-3">
                <span v-if="loading" class="text-xs text-gray-400">同期中...</span>
                <button @click="openAdmin" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">管理画面</button>
            </div>
        </div>

        <!-- メイン画面 -->
        <div v-if="view === 'main'" class="space-y-6">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 flex flex-wrap items-center justify-between gap-4">
                <div>
                    <p class="text-blue-800 text-sm font-bold">枠をクリックしてキャラクターを選択してください</p>
                    <span class="text-xs text-blue-600">配置済み: {{ filledCount }}/21</span>
                </div>
                <div class="flex gap-2">
                    <button v-if="filledCount >= 1" @click="view = 'preview'" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-full font-bold shadow-lg">プレビュー・保存へ</button>
                </div>
            </div>

            <div class="overflow-auto bg-gray-300 p-4 rounded-lg">
                <div class="grid gap-2 p-4 bg-white mx-auto shadow-inner grid-cols-7" style="width: 1000px; min-height: 700px;">
                    <div v-for="(slot, index) in slots" :key="index" 
                         @click="startSelecting(index)"
                         class="border-2 border-dashed border-gray-300 flex flex-col cursor-pointer hover:bg-blue-50 hover:border-blue-300 relative group overflow-hidden bg-gray-50">
                        <div class="w-full aspect-square bg-gray-200 relative overflow-hidden">
                            <div v-if="slot" class="w-full h-full relative">
                                <img :src="slot.imageUrl" class="absolute max-w-none" :style="getSlotImgStyle(slot)" crossorigin="anonymous">
                            </div>
                            <div v-else class="w-full h-full flex items-center justify-center text-gray-400">
                                <span class="text-xl">+</span>
                            </div>
                        </div>
                        <div class="flex-1 bg-white border-t border-gray-100 flex flex-col">
                            <div class="h-6 border-b border-gray-100 flex items-center px-1 text-[8px] text-gray-400">名前：</div>
                            <div class="flex-1 p-1 text-[8px] text-gray-400">性格/特徴：</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- キャラクター選択 -->
        <div v-if="view === 'char-select'" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h3 class="font-bold">キャラクターを選択</h3>
                    <button @click="view = 'main'" class="text-2xl">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <div v-for="(charImages, name) in charData" :key="name" 
                         @click="selectCharacter(name)"
                         class="cursor-pointer border hover:border-blue-500 p-2 rounded text-center transition hover:shadow-md bg-gray-50">
                        <div class="w-full aspect-square bg-gray-200 mb-2 rounded overflow-hidden">
                            <img :src="charImages[0]" class="w-full h-full object-cover" crossorigin="anonymous">
                        </div>
                        <div class="text-xs font-bold truncate">{{ name }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 画像選択 -->
        <div v-if="view === 'image-select'" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h3 class="font-bold">{{ currentSelectedCharName }} の画像を選択</h3>
                    <button @click="view = 'char-select'" class="text-blue-600 text-sm">戻る</button>
                </div>
                <div class="p-6 overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <div v-for="url in charData[currentSelectedCharName]" :key="url" 
                         @click="selectImage(url)"
                         class="cursor-pointer border-4 border-transparent hover:border-blue-500 rounded overflow-hidden aspect-square">
                        <img :src="url" class="w-full h-full object-cover" crossorigin="anonymous">
                    </div>
                </div>
            </div>
        </div>

        <!-- 位置調整 -->
        <div v-if="view === 'crop-select'" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl w-full max-w-lg overflow-hidden shadow-2xl">
                <div class="p-4 bg-gray-50 border-b font-bold flex justify-between items-center">
                    <span>画像をドラッグして位置調整</span>
                    <button @click="view = 'image-select'" class="text-gray-400">&times;</button>
                </div>
                <div class="p-6">
                    <div class="bg-gray-100 aspect-square w-full max-w-[320px] mx-auto overflow-hidden relative border-2 border-blue-500 cursor-grab active:cursor-grabbing select-none"
                         ref="cropContainer"
                         @pointerdown="startDragging"
                         @pointermove="doDragging"
                         @pointerup="stopDragging">
                        <img :src="currentSelectedImageUrl" class="absolute max-w-none pointer-events-none" :style="currentCropImgStyle" crossorigin="anonymous">
                    </div>
                    <div class="mt-8 space-y-6">
                        <div>
                            <input type="range" v-model.number="crop.zoom" min="1" max="5" step="0.01" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div class="flex gap-4">
                            <button @click="resetCrop" class="flex-1 py-2 text-sm text-gray-500 border border-gray-200 rounded hover:bg-gray-50">中央に戻す</button>
                            <button @click="finishSlot" class="flex-[2] bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">配置を決定</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- プレビュー -->
        <div v-if="view === 'preview'" class="text-center pb-20">
            <div class="flex flex-wrap justify-center gap-4 mb-8 sticky top-4 z-10">
                <button @click="downloadPDF" class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg">PDF保存</button>
                <button @click="downloadPNG" class="bg-indigo-600 text-white px-8 py-3 rounded-full font-bold shadow-lg">PNG保存</button>
                <button @click="view = 'main'" class="bg-gray-200 text-gray-800 px-8 py-3 rounded-full font-bold">戻る</button>
            </div>
            <div class="preview-wrapper">
                <div id="preview-container" class="preview-scale">
                    <div id="miri-shira-sheet" class="a4-landscape" :style="sheetGridStyle">
                        <div v-for="(slot, index) in slots" :key="index" class="slot-box">
                            <div class="slot-img-container">
                                <img v-if="slot" :src="slot.imageUrl" class="absolute max-w-none" :style="getSlotImgStyle(slot)" crossorigin="anonymous">
                            </div>
                            <div class="slot-info">
                                <div class="slot-name">名前：</div>
                                <div class="slot-desc">性格/特徴：</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 管理画面 -->
        <div v-if="view === 'admin'" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl w-full">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">データ管理（クラウド）</h2>
                    <button @click="view = 'main'" class="text-gray-500 text-2xl">&times;</button>
                </div>
                <div v-if="!isAdminAuthenticated">
                    <input type="password" v-model="adminPassword" @keyup.enter="checkPassword" class="w-full border p-2 rounded mb-4" placeholder="パスワードを入力してください">
                    <button @click="checkPassword" class="w-full bg-black text-white py-2 rounded font-bold">ログイン</button>
                </div>
                <div v-else>
                    <textarea v-model="csvInput" rows="10" class="w-full border p-3 rounded font-mono text-xs mb-4" placeholder="キャラ名,画像URL"></textarea>
                    <button @click="importCSV" :disabled="saving" class="w-full bg-green-600 text-white py-3 rounded font-bold disabled:opacity-50">
                        {{ saving ? '保存中...' : 'クラウドに保存' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // ESM 対応の Vue ビルドをインポートするように修正
        import { createApp, ref, computed, onMounted, watch } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

        // ★ ご自身のFirebaseコンソールの内容に書き換えてください
        const firebaseConfig = {
            apiKey: "AIzaSyBwflCp99P6kWbeoy52_5glAhulVP7TRmI",
            authDomain: "milli-835f0.firebaseapp.com",
            projectId: "milli-835f0",
            storageBucket: "milli-835f0.firebasestorage.app",
            messagingSenderId: "895963869242",
            appId: "1:895963869242:web:3d40e32de3b54b535cc503",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "mirishira-app-01"; // アプリを識別するID（任意）

        createApp({
            setup() {
                const view = ref('main');
                const charData = ref({});
                const slots = ref(Array(21).fill(null));
                const user = ref(null);
                const loading = ref(true);
                const saving = ref(false);
                const crop = ref({ zoom: 1, x: 0, y: 0 });
                const currentSlotIndex = ref(null);
                const currentSelectedCharName = ref('');
                const currentSelectedImageUrl = ref('');
                const cropContainer = ref(null);
                const isDragging = ref(false);
                const lastPos = ref({ x: 0, y: 0 });
                const adminPassword = ref('');
                const isAdminAuthenticated = ref(false);
                const csvInput = ref('');

                onMounted(async () => {
                    await signInAnonymously(auth);
                    onAuthStateChanged(auth, (u) => { user.value = u; });
                });

                watch(user, (u) => {
                    if (u) {
                        const charDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'characters');
                        onSnapshot(charDocRef, (snap) => {
                            if (snap.exists()) {
                                charData.value = snap.data().list || {};
                                let csvStr = '';
                                for (const name in charData.value) {
                                    charData.value[name].forEach(url => { csvStr += `${name},${url}\n`; });
                                }
                                csvInput.value = csvStr.trim();
                            }
                            loading.value = false;
                        });
                    }
                });

                const startSelecting = (index) => { currentSlotIndex.value = index; view.value = 'char-select'; };
                const selectCharacter = (name) => { currentSelectedCharName.value = name; view.value = 'image-select'; };
                const selectImage = (url) => { currentSelectedImageUrl.value = url; crop.value = { zoom: 1, x: 0, y: 0 }; view.value = 'crop-select'; };
                const finishSlot = () => { slots.value[currentSlotIndex.value] = { imageUrl: currentSelectedImageUrl.value, ...crop.value }; view.value = 'main'; };
                const getSlotImgStyle = (s) => ({ width: `${s.zoom * 100}%`, height: 'auto', left: `${50 + s.x}%`, top: `${50 + s.y}%`, transform: 'translate(-50%, -50%)', position: 'absolute', maxWidth: 'none' });
                const currentCropImgStyle = computed(() => getSlotImgStyle(crop.value));
                const startDragging = (e) => { isDragging.value = true; lastPos.value = { x: e.clientX, y: e.clientY }; e.target.setPointerCapture(e.pointerId); };
                const doDragging = (e) => {
                    if (!isDragging.value || !cropContainer.value) return;
                    const rect = cropContainer.value.getBoundingClientRect();
                    crop.value.x += ((e.clientX - lastPos.value.x) / rect.width) * 100;
                    crop.value.y += ((e.clientY - lastPos.value.y) / rect.height) * 100;
                    lastPos.value = { x: e.clientX, y: e.clientY };
                };
                const stopDragging = () => { isDragging.value = false; };
                const resetCrop = () => { crop.value = { zoom: 1, x: 0, y: 0 }; };
                const openAdmin = () => { view.value = 'admin'; };
                const checkPassword = () => { if (adminPassword.value === '252') isAdminAuthenticated.value = true; else alert('パスワードが違います'); };
                const importCSV = async () => {
                    saving.value = true;
                    const newData = {};
                    csvInput.value.split('\n').forEach(line => {
                        const [name, url] = line.split(',').map(s => s.trim());
                        if (name && url) {
                            if (!newData[name]) newData[name] = [];
                            newData[name].push(url);
                        }
                    });
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters'), { list: newData });
                        view.value = 'main';
                    } finally { saving.value = false; }
                };
                const downloadPDF = async () => {
                    const canvas = await generateCanvas();
                    const pdf = new jspdf.jsPDF({ orientation: 'landscape', unit: 'px', format: [1123, 794] });
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 1123, 794);
                    pdf.save('mirishira.pdf');
                };
                const downloadPNG = async () => {
                    const canvas = await generateCanvas();
                    const link = document.createElement('a');
                    link.download = 'mirishira.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                };
                const generateCanvas = async () => {
                    const sheet = document.getElementById('miri-shira-sheet');
                    const wrapper = document.getElementById('preview-container');
                    wrapper.classList.add('no-transform');
                    const canvas = await html2canvas(sheet, { scale: 2, useCORS: true, width: 1123, height: 794 });
                    wrapper.classList.remove('no-transform');
                    return canvas;
                };

                return {
                    view, charData, slots, loading, saving, crop, currentSelectedCharName, currentSelectedImageUrl, cropContainer,
                    startSelecting, selectCharacter, selectImage, finishSlot, getSlotImgStyle, currentCropImgStyle,
                    startDragging, doDragging, stopDragging, resetCrop, openAdmin, checkPassword, importCSV, downloadPDF, downloadPNG,
                    filledCount: computed(() => slots.value.filter(s => s !== null).length),
                    sheetGridStyle: { gridTemplateColumns: 'repeat(7, 1fr)', gridTemplateRows: 'repeat(3, 1fr)', gap: '4px', padding: '10px' },
                    adminPassword, isAdminAuthenticated, csvInput
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
