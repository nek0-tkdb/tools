<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ミリしらシートメーカー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF生成用ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; }
        .a4-landscape {
            width: 1123px;
            height: 794px;
            background: white;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
            display: grid;
        }
        .slot-box { border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; background: #fff; }
        .slot-img-container { height: 60%; width: 100%; border-bottom: 1px solid #333; overflow: hidden; position: relative; }
        .slot-info { flex: 1; display: flex; flex-direction: column; padding: 2px; }
        .slot-name { height: 30%; border-bottom: 1px solid #ccc; background: #fafafa; }
        .slot-desc { flex: 1; background: #fff; }
        
        /* プレビュー画面の縮小表示用 */
        .preview-scale { transform: scale(0.6); transform-origin: top center; margin-bottom: -300px; }
        @media (max-width: 1200px) { .preview-scale { transform: scale(0.4); margin-bottom: -450px; } }
        @media (max-width: 768px) { .preview-scale { transform: scale(0.3); margin-bottom: -550px; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <!-- ナビゲーション -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800" @click="view = 'start'" class="cursor-pointer">ミリしらシートメーカー</h1>
            <button @click="openAdmin" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">管理画面</button>
        </div>

        <!-- 1. スタート画面: レイアウト選択 -->
        <div v-if="view === 'start'" class="bg-white p-8 rounded-xl shadow-lg text-center">
            <h2 class="text-xl mb-6 font-bold">作成するシートのレイアウトを選んでください</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div @click="selectLayout('7x3')" class="border-4 border-transparent hover:border-blue-500 cursor-pointer p-4 rounded-lg bg-gray-50 transition">
                    <div class="w-full aspect-[1.41] border-2 border-gray-400 mb-2 grid grid-cols-7 grid-rows-3 gap-1 p-1">
                        <div v-for="i in 21" class="bg-gray-300"></div>
                    </div>
                    <p class="font-bold">7枠 × 3行 (横長)</p>
                </div>
                <div @click="selectLayout('3x7')" class="border-4 border-transparent hover:border-blue-500 cursor-pointer p-4 rounded-lg bg-gray-50 transition">
                    <div class="w-full aspect-[1.41] border-2 border-gray-400 mb-2 grid grid-cols-3 grid-rows-7 gap-1 p-1">
                        <div v-for="i in 21" class="bg-gray-300"></div>
                    </div>
                    <p class="font-bold">3枠 × 7行 (縦長)</p>
                </div>
            </div>
        </div>

        <!-- 2. キャラ選択メイン画面 -->
        <div v-if="view === 'main'" class="space-y-6">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <p class="text-blue-800 text-sm">枠をクリックしてキャラクターを配置してください（全21枠）</p>
                <div class="mt-2 flex gap-4 items-center">
                    <span class="text-sm font-bold">配置済み: {{ filledCount }}/21</span>
                    <button v-if="filledCount === 21" @click="view = 'preview'" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-full font-bold shadow-lg ml-auto">プレビュー・保存へ</button>
                    <button @click="view = 'start'" class="text-gray-500 text-sm underline ml-auto" v-else>レイアウトを選び直す</button>
                </div>
            </div>

            <!-- 編集用グリッド (A4比率を維持して表示) -->
            <div class="overflow-auto bg-gray-300 p-4 rounded-lg">
                <div :class="['grid gap-2 p-4 bg-white mx-auto shadow-inner', layout === '7x3' ? 'grid-cols-7' : 'grid-cols-3']" style="width: 1000px; min-height: 700px;">
                    <div v-for="(slot, index) in slots" :key="index" 
                         @click="startSelecting(index)"
                         class="border-2 border-dashed border-gray-300 aspect-[3/4] flex items-center justify-center cursor-pointer hover:bg-blue-50 hover:border-blue-300 relative group overflow-hidden bg-gray-50">
                        
                        <div v-if="slot" class="w-full h-full">
                            <img :src="slot.imageUrl" class="w-full h-full object-cover" :style="slot.cropStyle">
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center text-white text-xs transition">変更する</div>
                        </div>
                        <div v-else class="text-gray-400 text-center p-2">
                            <div class="text-2xl mb-1">+</div>
                            <div class="text-[10px]">{{ index + 1 }}人目を選択</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. キャラクター選択モーダル -->
        <div v-if="view === 'char-select'" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="p-4 border-bottom flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h3 class="font-bold">キャラクターを選択 ({{ currentSlotIndex + 1 }}枠目)</h3>
                    <button @click="view = 'main'" class="text-2xl">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <div v-for="(char, name) in charData" :key="name" 
                         @click="selectCharacter(name)"
                         class="cursor-pointer border hover:border-blue-500 p-2 rounded text-center transition hover:shadow-md bg-gray-50">
                        <div class="w-full aspect-square bg-gray-200 mb-2 rounded overflow-hidden">
                            <img :src="char[0]" class="w-full h-full object-cover">
                        </div>
                        <div class="text-xs font-bold truncate">{{ name }}</div>
                    </div>
                    <div v-if="Object.keys(charData).length === 0" class="col-span-full py-12 text-center text-gray-500">
                        キャラクターが登録されていません。<br>右上の「管理画面」からデータを登録してください。
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. 画像選択モーダル -->
        <div v-if="view === 'image-select'" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="p-4 border-bottom flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h3 class="font-bold">{{ currentSelectedCharName }} の画像を選択</h3>
                    <button @click="view = 'char-select'" class="text-blue-600">戻る</button>
                </div>
                <div class="p-6 overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <div v-for="url in charData[currentSelectedCharName]" :key="url" 
                         @click="selectImage(url)"
                         class="cursor-pointer border-4 border-transparent hover:border-blue-500 rounded overflow-hidden aspect-square">
                        <img :src="url" class="w-full h-full object-cover">
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. クロップ調整モーダル -->
        <div v-if="view === 'crop-select'" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl w-full max-w-lg overflow-hidden">
                <div class="p-4 bg-gray-50 border-b font-bold">表示位置の調整</div>
                <div class="p-6">
                    <div class="bg-gray-200 aspect-[3/4] w-48 mx-auto overflow-hidden relative border-2 border-blue-500">
                        <img :src="currentSelectedImageUrl" 
                             :style="{ transform: `scale(${crop.zoom}) translate(${crop.x}%, ${crop.y}%)`, transition: 'none' }"
                             class="absolute top-0 left-0 w-full h-full object-cover origin-center">
                    </div>
                    
                    <div class="mt-6 space-y-4">
                        <div>
                            <label class="text-xs block mb-1 uppercase font-bold text-gray-500">ズーム</label>
                            <input type="range" v-model="crop.zoom" min="1" max="3" step="0.1" class="w-full">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs block mb-1 uppercase font-bold text-gray-500">左右位置</label>
                                <input type="range" v-model="crop.x" min="-50" max="50" step="1" class="w-full">
                            </div>
                            <div>
                                <label class="text-xs block mb-1 uppercase font-bold text-gray-500">上下位置</label>
                                <input type="range" v-model="crop.y" min="-50" max="50" step="1" class="w-full">
                            </div>
                        </div>
                    </div>
                    
                    <button @click="finishSlot" class="w-full bg-blue-600 text-white mt-8 py-3 rounded-lg font-bold">決定</button>
                </div>
            </div>
        </div>

        <!-- 6. プレビュー画面 -->
        <div v-if="view === 'preview'" class="text-center pb-20">
            <div class="flex flex-wrap justify-center gap-4 mb-8">
                <button @click="downloadPDF" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full font-bold shadow-lg flex items-center gap-2">
                    <span>PDFをダウンロード</span>
                </button>
                <button @click="view = 'main'" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-8 py-3 rounded-full font-bold">編集に戻る</button>
                <button @click="resetApp" class="bg-red-50 hover:bg-red-100 text-red-600 px-8 py-3 rounded-full font-bold border border-red-200">最初から作り直す</button>
            </div>

            <div class="preview-scale">
                <!-- 実際にPDF化されるコンポーネント -->
                <div id="miri-shira-sheet" class="a4-landscape" :style="sheetGridStyle">
                    <div v-for="(slot, index) in slots" :key="index" class="slot-box">
                        <div class="slot-img-container">
                            <img v-if="slot" :src="slot.imageUrl" :style="slot.cropStyle" class="absolute inset-0 w-full h-full object-cover">
                        </div>
                        <div class="slot-info">
                            <div class="slot-name"></div>
                            <div class="slot-desc"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 7. 管理画面 (パスワード保護) -->
        <div v-if="view === 'admin'" class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">データ管理画面</h2>
                <button @click="view = 'start'" class="text-gray-500">閉じる</button>
            </div>

            <div v-if="!isAdminAuthenticated">
                <label class="block mb-2 font-bold">パスワードを入力してください</label>
                <input type="password" v-model="adminPassword" @keyup.enter="checkPassword" class="w-full border p-2 rounded mb-4" placeholder="Password...">
                <button @click="checkPassword" class="w-full bg-black text-white py-2 rounded font-bold">ログイン</button>
            </div>

            <div v-else>
                <div class="mb-6">
                    <label class="block mb-2 font-bold text-sm">CSVデータを貼り付け (キャラ名,画像URL)</label>
                    <p class="text-[10px] text-gray-500 mb-2">※同じキャラ名で複数行ある場合は、そのキャラのバリエーション画像として登録されます。</p>
                    <textarea v-model="csvInput" rows="10" class="w-full border p-3 rounded font-mono text-xs mb-4" placeholder="キャラクターA,https://example.com/img1.jpg&#10;キャラクターA,https://example.com/img2.jpg&#10;キャラクターB,https://example.com/img3.jpg"></textarea>
                    <button @click="importCSV" class="w-full bg-green-600 text-white py-3 rounded font-bold hover:bg-green-700">データを更新して保存</button>
                </div>
                
                <div class="border-t pt-4">
                    <h3 class="font-bold mb-2">登録中のキャラ数: {{ Object.keys(charData).length }}</h3>
                    <div class="max-h-40 overflow-y-auto text-xs bg-gray-50 p-2 rounded">
                        <div v-for="(urls, name) in charData" class="flex justify-between py-1 border-b last:border-0">
                            <span>{{ name }}</span>
                            <span class="text-gray-400">{{ urls.length }}枚</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Vue.js CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const view = ref('start'); // start, main, char-select, image-select, crop-select, preview, admin
                const layout = ref('7x3'); // 7x3 or 3x7
                const charData = ref({}); // { name: [url1, url2, ...] }
                const slots = ref(Array(21).fill(null));
                
                // 選択中の一時データ
                const currentSlotIndex = ref(null);
                const currentSelectedCharName = ref('');
                const currentSelectedImageUrl = ref('');
                const crop = ref({ zoom: 1, x: 0, y: 0 });

                // 管理画面用
                const isAdminAuthenticated = ref(false);
                const adminPassword = ref('');
                const csvInput = ref('');

                // 初期化: localStorageからデータ読み込み
                onMounted(() => {
                    const savedData = localStorage.getItem('mirishira_chars');
                    if (savedData) {
                        charData.ref = JSON.parse(savedData);
                        charData.value = charData.ref; // Vueのリアクティブ更新
                        
                        // CSVテキストエリアの初期値を作成
                        let csvStr = '';
                        for (const name in charData.value) {
                            charData.value[name].forEach(url => {
                                csvStr += `${name},${url}\n`;
                            });
                        }
                        csvInput.value = csvStr.trim();
                    } else {
                        // サンプルデータ
                        const sample = {
                            "サンプルキャラA": ["https://images.unsplash.com/photo-1541963463532-d68292c34b19?w=400&h=600&fit=crop"],
                            "サンプルキャラB": ["https://images.unsplash.com/photo-1503023345310-bd7c1de61c7d?w=400&h=600&fit=crop"]
                        };
                        charData.value = sample;
                    }
                });

                const selectLayout = (val) => {
                    layout.value = val;
                    view.value = 'main';
                };

                const startSelecting = (index) => {
                    currentSlotIndex.value = index;
                    view.value = 'char-select';
                };

                const selectCharacter = (name) => {
                    currentSelectedCharName.value = name;
                    view.value = 'image-select';
                };

                const selectImage = (url) => {
                    currentSelectedImageUrl.value = url;
                    // デフォルトのクロップ設定
                    crop.value = { zoom: 1, x: 0, y: 0 };
                    view.value = 'crop-select';
                };

                const finishSlot = () => {
                    slots.value[currentSlotIndex.value] = {
                        charName: currentSelectedCharName.value,
                        imageUrl: currentSelectedImageUrl.value,
                        cropStyle: {
                            transform: `scale(${crop.value.zoom}) translate(${crop.value.x}%, ${crop.value.y}%)`
                        }
                    };
                    view.value = 'main';
                };

                const filledCount = computed(() => slots.value.filter(s => s !== null).length);

                const sheetGridStyle = computed(() => {
                    return layout.value === '7x3' 
                        ? { gridTemplateColumns: 'repeat(7, 1fr)', gridTemplateRows: 'repeat(3, 1fr)', gap: '4px', padding: '10px' }
                        : { gridTemplateColumns: 'repeat(3, 1fr)', gridTemplateRows: 'repeat(7, 1fr)', gap: '4px', padding: '10px' };
                });

                // 管理画面ロジック
                const openAdmin = () => { view.value = 'admin'; };
                const checkPassword = () => {
                    if (adminPassword.value === '252') {
                        isAdminAuthenticated.value = true;
                    } else {
                        alert('パスワードが違います');
                    }
                };

                const importCSV = () => {
                    const lines = csvInput.value.split('\n');
                    const newData = {};
                    lines.forEach(line => {
                        const parts = line.split(',');
                        if (parts.length >= 2) {
                            const name = parts[0].trim();
                            const url = parts[1].trim();
                            if (name && url) {
                                if (!newData[name]) newData[name] = [];
                                newData[name].push(url);
                            }
                        }
                    });
                    if (Object.keys(newData).length > 0) {
                        charData.value = newData;
                        localStorage.setItem('mirishira_chars', JSON.stringify(newData));
                        alert('データを保存しました');
                        isAdminAuthenticated.value = false;
                        adminPassword.value = '';
                        view.value = 'start';
                    } else {
                        alert('有効なデータが見つかりませんでした。フォーマットを確認してください。');
                    }
                };

                const downloadPDF = async () => {
                    const element = document.getElementById('miri-shira-sheet');
                    const canvas = await html2canvas(element, {
                        scale: 2, // 高解像度
                        useCORS: true,
                        allowTaint: true
                    });
                    
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'px',
                        format: [1123, 794] // A4横 ピクセル
                    });

                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 1123, 794);
                    pdf.save('mirishira-sheet.pdf');
                };

                const resetApp = () => {
                    if (confirm('最初から作り直しますか？（配置した画像が消えます）')) {
                        slots.value = Array(21).fill(null);
                        view.value = 'start';
                    }
                };

                return {
                    view, layout, charData, slots, currentSlotIndex, currentSelectedCharName, currentSelectedImageUrl, crop,
                    isAdminAuthenticated, adminPassword, csvInput,
                    selectLayout, startSelecting, selectCharacter, selectImage, finishSlot,
                    filledCount, sheetGridStyle, openAdmin, checkPassword, importCSV, downloadPDF, resetApp
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
