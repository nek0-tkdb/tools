<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ミリしらシートメーカー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; overscroll-behavior: none; }
        
        /* A4横の物理サイズ設定 */
        .a4-landscape {
            width: 1123px;
            height: 794px;
            background: white;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
            display: grid;
        }
        
        .slot-box { border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; background: #fff; }
        .slot-img-container { width: 100%; aspect-ratio: 1 / 1; border-bottom: 1px solid #333; overflow: hidden; position: relative; flex-shrink: 0; background: #eee; }
        .slot-info { flex: 1; display: flex; flex-direction: column; padding: 2px; min-height: 0; }
        .slot-name { height: 25px; border-bottom: 1px solid #ccc; background: #fafafa; flex-shrink: 0; }
        .slot-desc { flex: 1; background: #fff; }
        
        /* プレビュー縮小用（画面表示時のみ） */
        .preview-wrapper { width: 100%; overflow: hidden; display: flex; justify-content: center; }
        .preview-scale { transform: scale(0.6); transform-origin: top center; margin-bottom: -320px; }
        @media (max-width: 1200px) { .preview-scale { transform: scale(0.45); margin-bottom: -430px; } }
        @media (max-width: 768px) { .preview-scale { transform: scale(0.3); margin-bottom: -550px; } }

        /* ドラッグ操作時のカーソル */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }

        /* キャプチャ時に一時的にスタイルをリセットするためのクラス */
        .no-transform { transform: none !important; margin-bottom: 0 !important; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <!-- ナビゲーション -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800 cursor-pointer" @click="view = 'start'">ミリしらシートメーカー</h1>
            <button @click="openAdmin" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">管理画面</button>
        </div>

        <!-- 1. レイアウト選択 -->
        <div v-if="view === 'start'" class="bg-white p-8 rounded-xl shadow-lg text-center">
            <h2 class="text-xl mb-6 font-bold">レイアウトを選んでください</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div @click="selectLayout('7x3')" class="border-4 border-transparent hover:border-blue-500 cursor-pointer p-4 rounded-lg bg-gray-50 transition">
                    <div class="w-full aspect-[1.41] border-2 border-gray-400 mb-2 grid grid-cols-7 grid-rows-3 gap-1 p-1">
                        <div v-for="i in 21" class="bg-gray-300"></div>
                    </div>
                    <p class="font-bold">7枠 × 3行 (横長)</p>
                </div>
                <div @click="selectLayout('3x7')" class="border-4 border-transparent hover:border-blue-500 cursor-pointer p-4 rounded-lg bg-gray-50 transition">
                    <div class="w-full aspect-[1.41] border-2 border-gray-400 mb-2 grid grid-cols-3 grid-rows-7 gap-1 p-1">
                        <div v-for="i in 21" class="bg-gray-300"></div>
                    </div>
                    <p class="font-bold">3枠 × 7行 (縦長)</p>
                </div>
            </div>
        </div>

        <!-- 2. メイン編集画面 -->
        <div v-if="view === 'main'" class="space-y-6">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 flex flex-wrap items-center justify-between gap-4">
                <div>
                    <p class="text-blue-800 text-sm font-bold">枠をクリックしてキャラクターを選択してください</p>
                    <span class="text-xs text-blue-600">配置済み: {{ filledCount }}/21</span>
                </div>
                <div class="flex gap-2">
                    <button v-if="filledCount >= 1" @click="view = 'preview'" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-full font-bold shadow-lg">プレビュー・保存へ</button>
                    <button @click="view = 'start'" class="text-gray-500 text-xs underline">レイアウト変更</button>
                </div>
            </div>

            <div class="overflow-auto bg-gray-300 p-4 rounded-lg">
                <div :class="['grid gap-2 p-4 bg-white mx-auto shadow-inner', layout === '7x3' ? 'grid-cols-7' : 'grid-cols-3']" style="width: 1000px; min-height: 700px;">
                    <div v-for="(slot, index) in slots" :key="index" 
                         @click="startSelecting(index)"
                         class="border-2 border-dashed border-gray-300 flex flex-col cursor-pointer hover:bg-blue-50 hover:border-blue-300 relative group overflow-hidden bg-gray-50">
                        
                        <div class="w-full aspect-square bg-gray-200 relative overflow-hidden">
                            <div v-if="slot" class="w-full h-full relative">
                                <img :src="slot.imageUrl" 
                                     class="absolute max-w-none" 
                                     :style="getSlotImgStyle(slot)"
                                     crossorigin="anonymous">
                            </div>
                            <div v-else class="w-full h-full flex items-center justify-center text-gray-400">
                                <span class="text-xl">+</span>
                            </div>
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center text-white text-[10px] transition text-center p-1">
                                {{ slot ? '変更' : (index + 1) + '人目を選択' }}
                            </div>
                        </div>
                        <div class="flex-1 p-1 bg-white border-t border-gray-100 flex flex-col gap-1">
                            <div class="h-2 bg-gray-100 rounded w-3/4"></div>
                            <div class="h-2 bg-gray-50 rounded w-full"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. キャラクター選択モーダル -->
        <div v-if="view === 'char-select'" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h3 class="font-bold">キャラクターを選択</h3>
                    <button @click="view = 'main'" class="text-2xl">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <div v-for="(char, name) in charData" :key="name" 
                         @click="selectCharacter(name)"
                         class="cursor-pointer border hover:border-blue-500 p-2 rounded text-center transition hover:shadow-md bg-gray-50">
                        <div class="w-full aspect-square bg-gray-200 mb-2 rounded overflow-hidden">
                            <img :src="char[0]" class="w-full h-full object-cover" crossorigin="anonymous">
                        </div>
                        <div class="text-xs font-bold truncate">{{ name }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. 画像選択モーダル -->
        <div v-if="view === 'image-select'" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h3 class="font-bold">{{ currentSelectedCharName }} の画像を選択</h3>
                    <button @click="view = 'char-select'" class="text-blue-600 text-sm">戻る</button>
                </div>
                <div class="p-6 overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <div v-for="url in charData[currentSelectedCharName]" :key="url" 
                         @click="selectImage(url)"
                         class="cursor-pointer border-4 border-transparent hover:border-blue-500 rounded overflow-hidden aspect-square">
                        <img :src="url" class="w-full h-full object-cover" crossorigin="anonymous">
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. クロップ調整モーダル -->
        <div v-if="view === 'crop-select'" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl w-full max-w-lg overflow-hidden shadow-2xl">
                <div class="p-4 bg-gray-50 border-b font-bold flex justify-between items-center">
                    <span>画像をドラッグして位置調整</span>
                    <button @click="view = 'image-select'" class="text-gray-400">&times;</button>
                </div>
                <div class="p-6">
                    <div class="bg-gray-100 aspect-square w-full max-w-[320px] mx-auto overflow-hidden relative border-2 border-blue-500 cursor-grab active:cursor-grabbing select-none"
                         ref="cropContainer"
                         @pointerdown="startDragging"
                         @pointermove="doDragging"
                         @pointerup="stopDragging"
                         @pointerleave="stopDragging">
                        
                        <img :src="currentSelectedImageUrl" 
                             class="absolute max-w-none pointer-events-none"
                             :style="currentCropImgStyle"
                             crossorigin="anonymous">
                    </div>
                    
                    <div class="mt-8 space-y-6">
                        <div>
                            <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                                <span>ズーム (拡大)</span>
                                <span class="bg-blue-100 text-blue-700 px-2 rounded">x{{ crop.zoom.toFixed(2) }}</span>
                            </div>
                            <input type="range" v-model.number="crop.zoom" min="1" max="5" step="0.01" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div class="flex gap-4">
                            <button @click="resetCrop" class="flex-1 py-2 text-sm text-gray-500 border border-gray-200 rounded hover:bg-gray-50">中央に戻す</button>
                            <button @click="finishSlot" class="flex-[2] bg-blue-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-blue-700">配置を決定</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. プレビュー画面 -->
        <div v-if="view === 'preview'" class="text-center pb-20">
            <div class="flex flex-wrap justify-center gap-4 mb-8 sticky top-4 z-10">
                <button @click="downloadPDF" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full font-bold shadow-lg flex items-center gap-2">
                    <span>PDF保存</span>
                </button>
                <button @click="downloadPNG" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-full font-bold shadow-lg flex items-center gap-2">
                    <span>PNG保存</span>
                </button>
                <button @click="view = 'main'" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-8 py-3 rounded-full font-bold">編集に戻る</button>
                <button @click="resetApp" class="bg-red-50 hover:bg-red-100 text-red-600 px-6 py-3 rounded-full text-sm font-bold border border-red-200">全リセット</button>
            </div>

            <div class="preview-wrapper">
                <div id="preview-container" class="preview-scale">
                    <div id="miri-shira-sheet" class="a4-landscape" :style="sheetGridStyle">
                        <div v-for="(slot, index) in slots" :key="index" class="slot-box">
                            <div class="slot-img-container">
                                <img v-if="slot" :src="slot.imageUrl" 
                                     class="absolute max-w-none"
                                     :style="getSlotImgStyle(slot)"
                                     crossorigin="anonymous">
                            </div>
                            <div class="slot-info">
                                <div class="slot-name"></div>
                                <div class="slot-desc"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 7. 管理画面 -->
        <div v-if="view === 'admin'" class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">データ管理</h2>
                <button @click="view = 'start'" class="text-gray-500">閉じる</button>
            </div>

            <div v-if="!isAdminAuthenticated">
                <label class="block mb-2 font-bold">パスワード</label>
                <input type="password" v-model="adminPassword" @keyup.enter="checkPassword" class="w-full border p-2 rounded mb-4" placeholder="Password...">
                <button @click="checkPassword" class="w-full bg-black text-white py-2 rounded font-bold">ログイン</button>
            </div>

            <div v-else>
                <div class="mb-6">
                    <label class="block mb-2 font-bold text-sm">CSV (キャラ名,画像URL)</label>
                    <textarea v-model="csvInput" rows="10" class="w-full border p-3 rounded font-mono text-xs mb-4" placeholder="キャラクターA,https://..."></textarea>
                    <button @click="importCSV" class="w-full bg-green-600 text-white py-3 rounded font-bold hover:bg-green-700">保存して終了</button>
                </div>
            </div>
        </div>

    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const view = ref('start');
                const layout = ref('7x3');
                const charData = ref({});
                const slots = ref(Array(21).fill(null));
                const cropContainer = ref(null);
                
                const currentSlotIndex = ref(null);
                const currentSelectedCharName = ref('');
                const currentSelectedImageUrl = ref('');
                
                const crop = ref({ zoom: 1, x: 0, y: 0 });
                const isDragging = ref(false);
                const lastPos = ref({ x: 0, y: 0 });

                const isAdminAuthenticated = ref(false);
                const adminPassword = ref('');
                const csvInput = ref('');

                onMounted(() => {
                    const savedData = localStorage.getItem('mirishira_chars');
                    if (savedData) {
                        charData.value = JSON.parse(savedData);
                        updateCsvInput();
                    }
                });

                const updateCsvInput = () => {
                    let csvStr = '';
                    for (const name in charData.value) {
                        charData.value[name].forEach(url => {
                            csvStr += `${name},${url}\n`;
                        });
                    }
                    csvInput.value = csvStr.trim();
                };

                const selectLayout = (val) => {
                    layout.value = val;
                    view.value = 'main';
                };

                const startSelecting = (index) => {
                    currentSlotIndex.value = index;
                    view.value = 'char-select';
                };

                const selectCharacter = (name) => {
                    currentSelectedCharName.value = name;
                    view.value = 'image-select';
                };

                const selectImage = (url) => {
                    currentSelectedImageUrl.value = url;
                    resetCrop();
                    view.value = 'crop-select';
                };

                const resetCrop = () => {
                    crop.value = { zoom: 1, x: 0, y: 0 };
                };

                const startDragging = (e) => {
                    isDragging.value = true;
                    lastPos.value = { x: e.clientX, y: e.clientY };
                    e.target.setPointerCapture(e.pointerId);
                };

                const doDragging = (e) => {
                    if (!isDragging.value || !cropContainer.value) return;
                    const rect = cropContainer.value.getBoundingClientRect();
                    const deltaX = e.clientX - lastPos.value.x;
                    const deltaY = e.clientY - lastPos.value.y;
                    
                    crop.value.x += (deltaX / rect.width) * 100;
                    crop.value.y += (deltaY / rect.height) * 100;
                    lastPos.value = { x: e.clientX, y: e.clientY };
                };

                const stopDragging = () => { isDragging.value = false; };

                // 計算が正確に反映されるように transform ではなく left/top の直接指定に変更
                const getSlotImgStyle = (s) => {
                    return {
                        width: `${s.zoom * 100}%`,
                        height: 'auto',
                        left: `${50 + s.x}%`,
                        top: `${50 + s.y}%`,
                        transform: 'translate(-50%, -50%)',
                        maxWidth: 'none'
                    };
                };

                const currentCropImgStyle = computed(() => {
                    return {
                        width: `${crop.value.zoom * 100}%`,
                        height: 'auto',
                        left: `${50 + crop.value.x}%`,
                        top: `${50 + crop.value.y}%`,
                        transform: 'translate(-50%, -50%)',
                        maxWidth: 'none'
                    };
                });

                const finishSlot = () => {
                    slots.value[currentSlotIndex.value] = {
                        imageUrl: currentSelectedImageUrl.value,
                        zoom: crop.value.zoom,
                        x: crop.value.x,
                        y: crop.value.y
                    };
                    view.value = 'main';
                };

                const filledCount = computed(() => slots.value.filter(s => s !== null).length);

                const sheetGridStyle = computed(() => {
                    return layout.value === '7x3' 
                        ? { gridTemplateColumns: 'repeat(7, 1fr)', gridTemplateRows: 'repeat(3, 1fr)', gap: '4px', padding: '10px' }
                        : { gridTemplateColumns: 'repeat(3, 1fr)', gridTemplateRows: 'repeat(7, 1fr)', gap: '4px', padding: '10px' };
                });

                const openAdmin = () => { view.value = 'admin'; };
                const checkPassword = () => {
                    if (adminPassword.value === '252') { isAdminAuthenticated.value = true; } 
                    else { alert('パスワードが違います'); }
                };

                const importCSV = () => {
                    const lines = csvInput.value.split('\n');
                    const newData = {};
                    lines.forEach(line => {
                        const parts = line.split(',');
                        if (parts.length >= 2) {
                            const name = parts[0].trim();
                            const url = parts[1].trim();
                            if (name && url) {
                                if (!newData[name]) newData[name] = [];
                                newData[name].push(url);
                            }
                        }
                    });
                    charData.value = newData;
                    localStorage.setItem('mirishira_chars', JSON.stringify(newData));
                    view.value = 'start';
                };

                // 書き出しロジック
                const generateCanvas = async () => {
                    const sheet = document.getElementById('miri-shira-sheet');
                    const wrapper = document.getElementById('preview-container');
                    
                    // キャプチャ用に一時的に縮小表示を解除
                    wrapper.classList.add('no-transform');
                    
                    const canvas = await html2canvas(sheet, {
                        scale: 2, // 高解像度出力
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        width: 1123,
                        height: 794,
                        logging: false
                    });
                    
                    wrapper.classList.remove('no-transform');
                    return canvas;
                };

                const downloadPDF = async () => {
                    const canvas = await generateCanvas();
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [1123, 794] });
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 1123, 794);
                    pdf.save('mirishira-sheet.pdf');
                };

                const downloadPNG = async () => {
                    const canvas = await generateCanvas();
                    const link = document.createElement('a');
                    link.download = 'mirishira-sheet.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                };

                const resetApp = () => {
                    if (confirm('最初から作り直しますか？')) {
                        slots.value = Array(21).fill(null);
                        view.value = 'start';
                    }
                };

                return {
                    view, layout, charData, slots, currentSlotIndex, currentSelectedCharName, currentSelectedImageUrl, crop,
                    isAdminAuthenticated, adminPassword, csvInput, cropContainer,
                    selectLayout, startSelecting, selectCharacter, selectImage, finishSlot,
                    filledCount, sheetGridStyle, openAdmin, checkPassword, importCSV, downloadPDF, downloadPNG, resetApp,
                    startDragging, doDragging, stopDragging, currentCropImgStyle, getSlotImgStyle, resetCrop
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
