<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像属性3択クイズ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-fire { background-color: #ef4444; }
        .bg-water { background-color: #3b82f6; }
        .bg-grass { background-color: #22c55e; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-900">

    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col">
        <header class="bg-slate-800 text-white p-4 text-center font-bold text-xl shadow-md">
            属性3択クイズ
        </header>

        <main class="flex-grow p-6">
            <section id="screen-home">
                <div class="mb-8">
                    <h2 class="text-lg font-bold border-b-2 border-slate-800 mb-4">お知らせ（新着カード）</h2>
                    <div id="latest-cards" class="space-y-2 text-sm text-gray-600">
                        </div>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700">出題数を選択</label>
                        <input type="range" id="quiz-count-range" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div class="text-center mt-2 font-bold text-slate-700"><span id="quiz-count-display">5</span>問</div>
                    </div>
                    <button onclick="startQuiz()" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-4 rounded-xl shadow-lg transition duration-200 transform hover:scale-105">
                        クイズスタート
                    </button>
                </div>
            </section>

            <section id="screen-quiz" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <span id="quiz-progress" class="text-sm font-bold text-slate-500">Q 1/5</span>
                    <button onclick="showHome()" class="text-xs text-red-500 underline">中断する</button>
                </div>
                <div class="bg-gray-200 aspect-square rounded-xl mb-6 overflow-hidden flex items-center justify-center border-4 border-white shadow-inner">
                    <img id="quiz-image" src="" alt="Quiz Image" class="w-full h-full object-cover">
                </div>
                <div id="quiz-info" class="text-center mb-6">
                    <h3 id="card-name" class="font-bold text-xl mb-1">カード名</h3>
                    <p id="card-series" class="text-sm text-gray-500">シリーズ名</p>
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="handleAnswer('赤')" class="bg-fire text-white py-4 rounded-lg font-bold shadow-md hover:opacity-90 active:scale-95 transition">赤（火）</button>
                    <button onclick="handleAnswer('青')" class="bg-water text-white py-4 rounded-lg font-bold shadow-md hover:opacity-90 active:scale-95 transition">青（水）</button>
                    <button onclick="handleAnswer('緑')" class="bg-grass text-white py-4 rounded-lg font-bold shadow-md hover:opacity-90 active:scale-95 transition">緑（草）</button>
                </div>
            </section>

            <section id="screen-result" class="hidden text-center">
                <h2 class="text-3xl font-black mb-2 text-slate-800">RESULT</h2>
                <div class="text-5xl font-bold text-slate-800 mb-6">
                    <span id="score-correct">0</span> / <span id="score-total">0</span>
                </div>
                <div id="history-list" class="text-left bg-gray-50 p-4 rounded-lg mb-6 max-h-60 overflow-y-auto space-y-2 border"></div>
                <div class="space-y-4">
                    <button onclick="shareOnX()" class="w-full bg-black text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2">Xで結果をシェア</button>
                    <button onclick="showHome()" class="w-full border-2 border-slate-800 text-slate-800 py-3 rounded-lg font-bold">ホームに戻る</button>
                </div>
            </section>
        </main>
    </div>

    <script>
        let allCards = [];
        let currentQuizSet = [];
        let currentIndex = 0;
        let score = 0;
        let resultsHistory = [];

        window.onload = async () => {
            await loadCSV();
            setupRange();
        };

        async function loadCSV() {
            try {
                // ファイル名を quiz_data.csv に変更
                const response = await fetch('./quiz_data.csv');
                if (!response.ok) throw new Error('CSV file not found');
                const text = await response.text();
                
                // ヘッダー（キャラ名,カード名,シリーズ,属性,画像URL,登録日）を考慮
                const rows = text.trim().split('\n').slice(1); 
                allCards = rows.map((row, index) => {
                    const [charName, cardName, series, attribute, imageUrl, createdAt] = row.split(',');
                    return { 
                        id: index, 
                        charName: charName?.trim(), 
                        cardName: cardName?.trim(), 
                        series: series?.trim(), 
                        attribute: attribute?.trim(), 
                        imageUrl: imageUrl?.trim(), 
                        createdAt: createdAt?.trim() 
                    };
                });

                updateLatestInfo();
            } catch (err) {
                console.error('CSV Load Error:', err);
                document.getElementById('latest-cards').innerText = "データの読み込みに失敗しました。";
            }
        }

        function updateLatestInfo() {
            const latestContainer = document.getElementById('latest-cards');
            const latest = [...allCards].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 3);
            latestContainer.innerHTML = latest.map(c => 
                `<div class="flex justify-between border-b border-gray-100 py-1">
                    <span>${c.charName} / ${c.cardName}</span>
                    <span class="text-[10px] text-gray-400">${c.createdAt}</span>
                </div>`
            ).join('');
        }

        function setupRange() {
            const range = document.getElementById('quiz-count-range');
            const display = document.getElementById('quiz-count-display');
            range.max = Math.max(allCards.length, 1);
            range.value = Math.min(5, allCards.length);
            display.innerText = range.value;
            range.addEventListener('input', (e) => { display.innerText = e.target.value; });
        }

        function startQuiz() {
            const count = parseInt(document.getElementById('quiz-count-range').value);
            currentQuizSet = [...allCards].sort(() => 0.5 - Math.random()).slice(0, count);
            currentIndex = 0; score = 0; resultsHistory = [];
            showScreen('screen-quiz');
            showNextQuestion();
        }

        function showNextQuestion() {
            if (currentIndex >= currentQuizSet.length) { showResult(); return; }
            const card = currentQuizSet[currentIndex];
            document.getElementById('quiz-progress').innerText = `Q ${currentIndex + 1} / ${currentQuizSet.length}`;
            document.getElementById('quiz-image').src = card.imageUrl;
            document.getElementById('card-name').innerText = card.cardName;
            document.getElementById('card-series').innerText = card.series;
        }

        function handleAnswer(choice) {
            const card = currentQuizSet[currentIndex];
            const isCorrect = card.attribute === choice;
            if (isCorrect) score++;
            resultsHistory.push({ name: card.cardName, correctAttr: card.attribute, userChoice: choice, isCorrect: isCorrect });
            currentIndex++;
            showNextQuestion();
        }

        function showResult() {
            showScreen('screen-result');
            document.getElementById('score-correct').innerText = score;
            document.getElementById('score-total').innerText = currentQuizSet.length;
            const historyContainer = document.getElementById('history-list');
            historyContainer.innerHTML = resultsHistory.map(h => `
                <div class="flex justify-between text-sm items-center border-b pb-1">
                    <span class="${h.isCorrect ? 'text-green-600 font-bold' : 'text-red-500'}">
                        ${h.isCorrect ? '○' : '×'} ${h.name}
                    </span>
                    <span class="text-xs text-gray-500">正解: ${h.correctAttr}</span>
                </div>
            `).join('');
        }

        function shareOnX() {
            const text = `属性3択クイズに挑戦しました！\n正解数: ${score}/${currentQuizSet.length}\n#属性クイズ`;
            const url = encodeURIComponent(window.location.href);
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${url}`, '_blank');
        }

        function showScreen(id) {
            ['screen-home', 'screen-quiz', 'screen-result'].forEach(s => {
                document.getElementById(s).classList.toggle('hidden', s !== id);
            });
        }

        function showHome() { showScreen('screen-home'); updateLatestInfo(); }
    </script>
</body>
</html>
