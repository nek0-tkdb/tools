<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁîªÂÉèÂ±ûÊÄß3Êäû„ÇØ„Ç§„Ç∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding-bottom: 30px;
            min-height: 100vh;
        }
        .app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            text-align: center;
            padding: 5px;
            font-size: 10px;
            color: #6b7280;
            background-color: #e5e7eb;
            z-index: 999;
        }
        img {
            pointer-events: none;
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
    <script type="module">
        // ÁîªÂÉè„ÅÆ‰øùË≠∑
        document.addEventListener('contextmenu', e => e.target.tagName === 'IMG' && e.preventDefault());
        document.addEventListener('dragstart', e => e.target.tagName === 'IMG' && e.preventDefault());

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
        const CSV_FILE_PATH = 'quiz_data.csv';
        const SHARE_URL = window.location.href;

        window.QuizApp = {
            questions: [],
            selectedCharacters: [],
            currentScreen: 'home',
            quizSettings: { totalQuestions: 10 },
            currentQuiz: {
                active: false,
                currentQuestionIndex: 0,
                score: 0,
                quizQuestions: [],
                answerHistory: []
            },
            ATTRIBUTES: {
                fire: { name: 'Ëµ§', color: 'bg-red-500 hover:bg-red-600 border-red-700' },
                water: { name: 'Èùí', color: 'bg-blue-500 hover:bg-blue-600 border-blue-700' },
                grass: { name: 'Á∑ë', color: 'bg-green-500 hover:bg-green-600 border-green-700' }
            },
            ATTRIBUTE_MAP: { 'Ëµ§': 'fire', 'Èùí': 'water', 'Á∑ë': 'grass' },

            async init() {
                this.loadSettings();
                await this.loadCsvData();
                this.renderApp();
            },

            loadSettings() {
                const stored = localStorage.getItem('quizSettings');
                if (stored) this.quizSettings = JSON.parse(stored);
            },

            async loadCsvData() {
                try {
                    const response = await fetch(CSV_FILE_PATH);
                    if (!response.ok) throw new Error('CSV file not found');
                    const text = await response.text();
                    this.questions = this.parseCsv(text);
                } catch (error) {
                    console.error("Data load failed:", error);
                    this.showMessage("CSV„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ", 'error');
                }
            },

            parseCsv(text) {
                return text.trim().split('\n').map((line, index) => {
                    const parts = line.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
                    // ÊúüÂæÖ„Åô„ÇãÂΩ¢Âºè: „Ç≠„É£„É©Âêç,„Ç´„Éº„ÉâÂêç,„Ç∑„É™„Éº„Ç∫,Â±ûÊÄß(Ëµ§/Èùí/Á∑ë),ÁîªÂÉèURL
                    if (parts.length < 5) return null;
                    return {
                        id: `csv-${index}`,
                        charName: parts[0],
                        cardName: parts[1],
                        series: parts[2],
                        correctAttribute: this.ATTRIBUTE_MAP[parts[3]] || 'fire',
                        imageUrl: parts[4]
                    };
                }).filter(q => q !== null);
            },

            setScreen(screen) {
                this.currentScreen = screen;
                this.renderApp();
            },

            showMessage(text, type = 'info') {
                const alertDiv = document.getElementById('message-alert');
                alertDiv.textContent = text;
                alertDiv.className = `p-3 mb-4 rounded-xl text-white font-bold transition-opacity duration-300 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} opacity-100 fixed top-0 left-1/2 -translate-x-1/2 mt-4 z-50`;
                setTimeout(() => alertDiv.classList.add('opacity-0'), 3000);
            },

            startQuiz() {
                let available = [...this.questions];
                if (this.selectedCharacters.length > 0) {
                    available = available.filter(q => this.selectedCharacters.includes(q.charName));
                }
                if (available.length === 0) {
                    this.showMessage("Âá∫È°åÂèØËÉΩ„Å™ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ", 'error');
                    return;
                }
                
                const shuffled = available.sort(() => Math.random() - 0.5);
                const count = Math.min(this.quizSettings.totalQuestions, shuffled.length);
                
                this.currentQuiz = {
                    active: true,
                    currentQuestionIndex: 0,
                    score: 0,
                    quizQuestions: shuffled.slice(0, count),
                    answerHistory: []
                };
                this.setScreen('quiz');
            },

            submitAnswer(selected) {
                const quiz = this.currentQuiz;
                const currentQ = quiz.quizQuestions[quiz.currentQuestionIndex];
                const isCorrect = currentQ.correctAttribute === selected;
                
                quiz.answerHistory.push({ question: currentQ, selected, correct: isCorrect });
                if (isCorrect) {
                    quiz.score++;
                    this.showMessage("Ê≠£Ëß£ÔºÅ", 'success');
                } else {
                    this.showMessage(`ÊÆãÂøµÔºÅÊ≠£Ëß£„ÅØ ${this.ATTRIBUTES[currentQ.correctAttribute].name}`, 'error');
                }

                setTimeout(() => {
                    quiz.currentQuestionIndex++;
                    if (quiz.currentQuestionIndex >= quiz.quizQuestions.length) {
                        this.setScreen('results');
                    } else {
                        this.renderApp();
                    }
                }, 1000);
            },

            renderApp() {
                const container = document.getElementById('app-container');
                let content = '';
                switch (this.currentScreen) {
                    case 'home': content = this.renderHome(); break;
                    case 'quiz': content = this.renderQuiz(); break;
                    case 'cardList': content = this.renderCardList(); break;
                    case 'charSelect': content = this.renderCharSelect(); break;
                    case 'results': content = this.renderResults(); break;
                }
                container.innerHTML = `<div class="max-w-4xl mx-auto w-full p-4 sm:p-8">${content}</div>`;
                this.attachEvents();
            },

            renderHome() {
                return `
                    <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                        <h1 class="text-3xl font-extrabold text-gray-900 mb-8">Â±ûÊÄßÂΩì„Å¶„ÇØ„Ç§„Ç∫</h1>
                        <div class="mb-6 space-y-4">
                            <div class="flex items-center justify-center gap-4">
                                <label class="text-sm font-medium">Âá∫È°åÊï∞:</label>
                                <input type="number" id="total-q-input" value="${this.quizSettings.totalQuestions}" min="1" class="w-20 p-2 border rounded-lg text-center">
                                <button id="save-settings-btn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm">‰øùÂ≠ò</button>
                            </div>
                            <button id="nav-char-select-btn" class="w-full py-3 border-2 rounded-xl hover:bg-gray-50">
                                üéØ Âá∫È°å„Ç≠„É£„É©„ÇíÈÅ∏Êäû (${this.selectedCharacters.length || '„Åô„Åπ„Å¶'})
                            </button>
                            <button id="start-quiz-btn" class="w-full py-4 bg-indigo-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700">
                                „ÇØ„Ç§„Ç∫„Çπ„Çø„Éº„Éà
                            </button>
                            <div class="grid grid-cols-2 gap-4">
                                <button id="nav-card-list-btn" class="py-3 border rounded-xl text-gray-600 hover:bg-gray-50 text-sm">„Ç´„Éº„Éâ‰∏ÄË¶ß</button>
                                <button onclick="window.location.reload()" class="py-3 border rounded-xl text-gray-600 hover:bg-gray-50 text-sm">„Éá„Éº„Çø„ÇíÊõ¥Êñ∞</button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400">ÂïèÈ°åÊï∞: ${this.questions.length}‰ª∂</p>
                    </div>
                `;
            },

            renderQuiz() {
                const quiz = this.currentQuiz;
                const q = quiz.quizQuestions[quiz.currentQuestionIndex];
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between mb-4 border-b pb-2">
                            <span class="font-bold">ÂïèÈ°å ${quiz.currentQuestionIndex + 1} / ${quiz.quizQuestions.length}</span>
                            <span class="text-indigo-600 font-bold">Ê≠£Ëß£Êï∞: ${quiz.score}</span>
                        </div>
                        <div class="text-center mb-4">
                            <p class="text-lg font-bold">${q.cardName}</p>
                            <p class="text-sm text-gray-500">${q.charName} / ${q.series}</p>
                        </div>
                        <div class="aspect-square bg-gray-100 rounded-xl overflow-hidden mb-6">
                            <img src="${q.imageUrl}" class="w-full h-full object-contain">
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            ${Object.entries(this.ATTRIBUTES).map(([id, data]) => `
                                <button data-attr="${id}" class="choice-btn py-4 ${data.color} text-white font-bold rounded-xl shadow-md transition-transform active:scale-95">
                                    ${data.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            renderResults() {
                const quiz = this.currentQuiz;
                const percent = Math.round((quiz.score / quiz.quizQuestions.length) * 100);
                return `
                    <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                        <h2 class="text-3xl font-bold mb-4">ÁµêÊûúÁô∫Ë°®</h2>
                        <p class="text-6xl font-black text-indigo-600 mb-2">${quiz.score} / ${quiz.quizQuestions.length}</p>
                        <p class="text-xl text-gray-600 mb-8">Ê≠£Á≠îÁéá: ${percent}%</p>
                        <div class="space-y-3">
                            <button onclick="QuizApp.setScreen('home')" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl">„Éõ„Éº„É†„Å´Êàª„Çã</button>
                            <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(`„ÇØ„Ç§„Ç∫ÁµêÊûú: ${quiz.score}ÂïèÊ≠£Ëß£ÔºÅÊ≠£Á≠îÁéá${percent}%„Åß„Åó„ÅüÔºÅ\n${SHARE_URL}`)}" target="_blank" class="block w-full py-3 bg-black text-white font-bold rounded-xl">X„Åß„Ç∑„Çß„Ç¢</a>
                        </div>
                    </div>
                `;
            },

            renderCardList() {
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">„Ç´„Éº„Éâ‰∏ÄË¶ß (${this.questions.length})</h2>
                        <div class="max-h-[60vh] overflow-y-auto space-y-2 mb-6">
                            ${this.questions.map(q => `
                                <div class="flex items-center gap-3 p-2 border rounded-lg text-sm">
                                    <img src="${q.imageUrl}" class="w-12 h-12 object-cover rounded">
                                    <div class="flex-1 min-w-0">
                                        <p class="font-bold truncate">${q.cardName}</p>
                                        <p class="text-xs text-gray-400">${q.charName}</p>
                                    </div>
                                    <span class="px-2 py-1 rounded text-white text-[10px] ${this.ATTRIBUTES[q.correctAttribute].color.split(' ')[0]}">
                                        ${this.ATTRIBUTES[q.correctAttribute].name}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="QuizApp.setScreen('home')" class="w-full py-3 border-2 rounded-xl">Êàª„Çã</button>
                    </div>
                `;
            },

            renderCharSelect() {
                const chars = [...new Set(this.questions.map(q => q.charName))].filter(Boolean).sort();
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">Âá∫È°å„Ç≠„É£„É©ÈÅ∏Êäû</h2>
                        <div class="grid grid-cols-2 gap-2 max-h-[50vh] overflow-y-auto mb-6">
                            ${chars.map(name => `
                                <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="checkbox" value="${name}" class="char-cb" ${this.selectedCharacters.includes(name) ? 'checked' : ''}>
                                    <span class="text-sm truncate">${name}</span>
                                </label>
                            `).join('')}
                        </div>
                        <div class="flex gap-2">
                            <button id="apply-char-btn" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl">Á¢∫ÂÆö</button>
                            <button onclick="QuizApp.setScreen('home')" class="flex-1 py-3 border-2 rounded-xl">„Ç≠„É£„É≥„Çª„É´</button>
                        </div>
                    </div>
                `;
            },

            attachEvents() {
                document.getElementById('start-quiz-btn')?.addEventListener('click', () => this.startQuiz());
                document.getElementById('nav-card-list-btn')?.addEventListener('click', () => this.setScreen('cardList'));
                document.getElementById('nav-char-select-btn')?.addEventListener('click', () => this.setScreen('charSelect'));
                document.getElementById('save-settings-btn')?.addEventListener('click', () => {
                    this.quizSettings.totalQuestions = parseInt(document.getElementById('total-q-input').value) || 10;
                    localStorage.setItem('quizSettings', JSON.stringify(this.quizSettings));
                    this.showMessage("Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
                });
                document.querySelectorAll('.choice-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.submitAnswer(btn.dataset.attr));
                });
                document.getElementById('apply-char-btn')?.addEventListener('click', () => {
                    this.selectedCharacters = Array.from(document.querySelectorAll('.char-cb:checked')).map(cb => cb.value);
                    this.setScreen('home');
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => window.QuizApp.init());
    </script>
</head>
<body>
    <div id="message-alert" class="fixed top-0 left-1/2 -translate-x-1/2 mt-4 p-3 rounded-xl text-white font-bold opacity-0 transition-opacity duration-300 z-50"></div>
    <div id="app-container" class="min-h-screen flex items-center justify-center">
        <div class="text-center p-4">
            <div class="animate-spin h-8 w-8 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>
            <p class="mt-4 text-gray-600">CSV„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
        </div>
    </div>
    <div class="app-footer">X: nek0n0tem0</div>
</body>
</html>
