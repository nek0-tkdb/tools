<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁîªÂÉèÂ±ûÊÄß3Êäû„ÇØ„Ç§„Ç∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding-bottom: 30px;
            min-height: 100vh;
        }
        .app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            text-align: center;
            padding: 5px;
            font-size: 10px;
            color: #6b7280;
            background-color: #e5e7eb;
            z-index: 999;
        }
        img {
            pointer-events: none;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
    </style>
    <script>
        // Âè≥„ÇØ„É™„ÉÉ„ÇØ„Éª„Éâ„É©„ÉÉ„Ç∞Á¶ÅÊ≠¢
        document.addEventListener('contextmenu', e => e.target.tagName === 'IMG' && e.preventDefault());
        document.addEventListener('dragstart', e => e.target.tagName === 'IMG' && e.preventDefault());

        const CSV_FILE = 'quiz_data.csv';

        window.QuizApp = {
            questions: [],
            recentQuestions: [],
            selectedCharacters: [],
            currentScreen: 'home',
            quizSettings: { totalQuestions: 3 },
            currentQuiz: { active: false, currentQuestionIndex: 0, score: 0, quizQuestions: [], answerHistory: [] },
            
            ATTRIBUTES: {
                fire: { name: 'Ëµ§', color: 'bg-red-500 hover:bg-red-600 border-red-700' },
                water: { name: 'Èùí', color: 'bg-blue-500 hover:bg-blue-600 border-blue-700' },
                grass: { name: 'Á∑ë', color: 'bg-green-500 hover:bg-green-600 border-green-700' }
            },
            
            ATTRIBUTE_MAP: { 'Ëµ§': 'fire', 'Èùí': 'water', 'Á∑ë': 'grass' },

            async init() {
                this.loadSettings();
                await this.loadCsvData();
                this.renderApp();
            },

            loadSettings() {
                const stored = localStorage.getItem('quizSettings');
                if (stored) this.quizSettings = JSON.parse(stored);
            },

            saveSettings() {
                localStorage.setItem('quizSettings', JSON.stringify(this.quizSettings));
            },

            async loadCsvData() {
                try {
                    const response = await fetch(CSV_FILE);
                    if (!response.ok) throw new Error('CSV file not found');
                    const text = await response.text();
                    
                    // ÊîπË°å„ÅßÂàÜÂâ≤ÔºàWindows/Mac‰∏°ÂØæÂøúÔºâ
                    const lines = text.trim().split(/\r?\n/).slice(1); 

                    this.questions = lines.map((line, index) => {
                        // „Ç´„É≥„Éû„ÅßÂàÜÂâ≤„Åó„ÄÅÂâçÂæå„ÅÆÁ©∫ÁôΩ„Åä„Çà„Å≥„ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„ÉÜ„Éº„Ç∑„Éß„É≥„ÇíÂæπÂ∫ïÂâäÈô§
                        const parts = line.split(',').map(s => {
                            let val = s.trim();
                            // ÊúÄÂàù„Å®ÊúÄÂæå„Åå " „Å™„ÇâÂâäÈô§
                            if (val.startsWith('"') && val.endsWith('"')) {
                                val = val.substring(1, val.length - 1);
                            }
                            // CSVÂÜÖ„Åß„ÅÆ„Ç®„Çπ„Ç±„Éº„Éó„Åï„Çå„Åü„ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„ÉÜ„Éº„Ç∑„Éß„É≥ "" „Çí " „Å´Êàª„Åô
                            return val.replace(/""/g, '"');
                        });

                        const [charName, cardName, series, attrName, imageUrl, regDate] = parts;
                        
                        return {
                            id: index,
                            charName: charName || '',
                            cardName: cardName || 'ÁÑ°È°å„ÅÆ„Ç´„Éº„Éâ',
                            series: series || '',
                            correctAttribute: this.ATTRIBUTE_MAP[attrName] || 'fire',
                            imageUrl: imageUrl || '',
                            createdAt: regDate ? new Date(regDate) : new Date()
                        };
                    });

                    this.updateRecentQuestions();
                } catch (e) {
                    console.error("Error loading CSV:", e);
                    alert("„Éá„Éº„Çø„ÅÆË™≠„ÅøÂèñ„Çä„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éï„Ç°„Ç§„É´Âêç„Åå quiz_data.csv „Åß„ÅÇ„Çã„Åì„Å®„ÄÅHTML„Å®Âêå„ÅòÂ†¥ÊâÄ„Å´„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                }
            },

            updateRecentQuestions() {
                this.recentQuestions = [...this.questions]
                    .sort((a, b) => b.createdAt - a.createdAt)
                    .slice(0, 3);
            },

            setScreen(screen) {
                this.currentScreen = screen;
                this.renderApp();
            },

            renderSelectedCharactersInfo() {
                if (this.selectedCharacters.length === 0) return '';
                const charList = this.selectedCharacters.map(char => 
                    `<span class="inline-block px-2 py-1 text-xs bg-indigo-100 text-indigo-700 rounded-full mr-1 mb-1">${char}</span>`
                ).join('');
                return `<div class="mt-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-xs font-medium text-gray-600 mb-2">Âá∫È°åÂØæË±°:</p>
                            <div class="flex flex-wrap">${charList}</div>
                        </div>`;
            },

            startQuiz() {
                let available = [...this.questions];
                if (this.selectedCharacters.length > 0) {
                    available = available.filter(q => this.selectedCharacters.includes(q.charName));
                }
                
                if (available.length === 0) {
                    alert("ÂØæË±°„ÅÆ„Ç´„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
                    return;
                }

                available.sort(() => Math.random() - 0.5);
                const count = Math.min(this.quizSettings.totalQuestions, available.length);

                this.currentQuiz = {
                    active: true,
                    currentQuestionIndex: 0,
                    score: 0,
                    quizQuestions: available.slice(0, count),
                    answerHistory: []
                };
                this.setScreen('quiz');
            },

            submitAnswer(attr) {
                const quiz = this.currentQuiz;
                const currentQ = quiz.quizQuestions[quiz.currentQuestionIndex];
                const isCorrect = currentQ.correctAttribute === attr;
                
                quiz.answerHistory.push({ question: currentQ, selected: attr, correct: isCorrect });
                if (isCorrect) quiz.score++;

                setTimeout(() => {
                    quiz.currentQuestionIndex++;
                    if (quiz.currentQuestionIndex >= quiz.quizQuestions.length) {
                        quiz.active = false;
                        this.setScreen('results');
                    } else {
                        this.renderApp();
                    }
                }, 800);
            },

            renderApp() {
                const container = document.getElementById('app-container');
                let html = '';
                switch (this.currentScreen) {
                    case 'home': html = this.renderHome(); break;
                    case 'quiz': html = this.renderQuiz(); break;
                    case 'cardList': html = this.renderCardList(); break;
                    case 'charSelect': html = this.renderCharSelect(); break;
                    case 'results': html = this.renderResults(); break;
                }
                container.innerHTML = `<div class="max-w-4xl mx-auto w-full p-4 sm:p-8">${html}</div>`;
                this.attachEventListeners();
            },

            renderHome() {
                let recentHtml = '';
                if (this.recentQuestions.length > 0) {
                    const items = this.recentQuestions.map(q => `<div class="text-sm text-gray-700 py-1">${q.cardName}Ôºà${q.charName || '‰∏çÊòé'}Ôºâ</div>`).join('');
                    recentHtml = `<div class="bg-white rounded-xl shadow-md p-4 mb-4 border border-gray-200"><h3 class="text-base font-bold mb-2">üì¢ Êñ∞ÁùÄ„Ç´„Éº„Éâ</h3>${items}</div>`;
                }

                return `
                    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                        <h1 class="text-3xl font-extrabold mb-6">Â±ûÊÄßÂΩì„Å¶„ÇØ„Ç§„Ç∫</h1>
                        <div class="mb-6 border-b pb-4">
                            <label class="block text-sm font-medium mb-2">Âá∫È°åÊï∞ (${this.quizSettings.totalQuestions}Âïè)</label>
                            <div class="flex gap-2">
                                <input type="number" id="total-questions-home" value="${this.quizSettings.totalQuestions}" min="1" class="flex-grow p-3 border rounded-xl" />
                                <button id="save-settings-btn" class="bg-indigo-500 text-white px-6 rounded-xl font-bold">‰øùÂ≠ò</button>
                            </div>
                        </div>
                        <div class="mb-6 border-b pb-4">
                            <button id="nav-char-select-btn" class="w-full py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-100">üéØ „Ç≠„É£„É©„ÇíÈÅ∏Êäû„Åó„Å¶Áµû„ÇäËæº„ÇÄ</button>
                            ${this.renderSelectedCharactersInfo()}
                        </div>
                        <div class="space-y-4">
                            <button id="start-quiz-btn" class="w-full text-xl py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:scale-[1.02] transition">„ÇØ„Ç§„Ç∫„Çπ„Çø„Éº„Éà</button>
                            ${recentHtml}
                            <button id="nav-card-list-btn" class="w-full py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-100">ÂÖ®„Ç´„Éº„Éâ‰∏ÄË¶ß (${this.questions.length}Êûö)</button>
                            <button onclick="history.back();" class="w-full bg-gray-200 py-3 rounded-xl font-semibold">‚Üê Êàª„Çã</button>
                        </div>
                    </div>`;
            },

            renderQuiz() {
                const quiz = this.currentQuiz;
                const currentQ = quiz.quizQuestions[quiz.currentQuestionIndex];
                const choices = ['fire', 'water', 'grass'].sort(() => Math.random() - 0.5);

                return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <h2 class="text-xl font-bold">ÂïèÈ°å ${quiz.currentQuestionIndex + 1} / ${quiz.quizQuestions.length}</h2>
                            <p class="text-indigo-600 font-bold">„Çπ„Ç≥„Ç¢: ${quiz.score}</p>
                        </div>
                        <div class="text-center mb-4 text-sm text-gray-600">
                             <p class="font-bold text-lg text-black">${currentQ.cardName}</p>
                             <p>${currentQ.charName || '---'} / ${currentQ.series || '---'}</p>
                        </div>
                        <div class="relative aspect-square bg-gray-200 rounded-xl overflow-hidden mb-6 shadow-inner">
                            <img src="${currentQ.imageUrl}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/600x600?text=No+Image'">
                        </div>
                        <div class="space-y-4">
                            ${choices.map(attr => `<button data-attribute="${attr}" class="quiz-choice-btn w-full py-4 rounded-xl text-white font-bold uppercase shadow-lg border-b-4 ${this.ATTRIBUTES[attr].color}">${this.ATTRIBUTES[attr].name}</button>`).join('')}
                        </div>
                    </div>`;
            },

            renderResults() {
                const quiz = this.currentQuiz;
                const percent = Math.round((quiz.score / quiz.quizQuestions.length) * 100);
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                        <h2 class="text-3xl font-extrabold text-indigo-600 mb-4">ÁµêÊûú</h2>
                        <div class="mb-8">
                            <p class="text-6xl font-black">${quiz.score} / ${quiz.quizQuestions.length}</p>
                            <p class="text-xl text-gray-600 mt-2">Ê≠£Á≠îÁéá: ${percent}%</p>
                        </div>
                        <button id="back-home-btn" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">„Éõ„Éº„É†„Å∏Êàª„Çã</button>
                    </div>`;
            },

            renderCardList() {
                const charNames = [...new Set(this.questions.map(q => q.charName).filter(n => n))].sort();
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-6 border-b pb-2">„Ç´„Éº„Éâ‰∏ÄË¶ß</h2>
                        <select id="char-filter" class="w-full p-2 border rounded-lg mb-4">
                            <option value="">„Åô„Åπ„Å¶„ÅÆ„Ç≠„É£„É©„ÇíË°®Á§∫</option>
                            ${charNames.map(n => `<option value="${n}">${n}</option>`).join('')}
                        </select>
                        <ul id="card-list-container" class="divide-y border rounded-xl overflow-hidden">
                            ${this.questions.map(q => `
                                <li class="card-list-item p-4 flex items-center gap-3" data-char="${q.charName}">
                                    <img src="${q.imageUrl}" class="w-16 h-16 object-cover rounded-lg">
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium truncate">${q.cardName}</p>
                                        <p class="text-xs text-gray-500">${q.charName || '---'}</p>
                                    </div>
                                    <span class="px-3 py-1 text-xs font-bold rounded-full text-white ${this.ATTRIBUTES[q.correctAttribute].color.split(' ')[0]}">${this.ATTRIBUTES[q.correctAttribute].name}</span>
                                </li>`).join('')}
                        </ul>
                        <button id="back-home-btn" class="w-full mt-6 py-3 border-2 border-gray-300 rounded-xl">„Éõ„Éº„É†„Å´Êàª„Çã</button>
                    </div>`;
            },

            renderCharSelect() {
                const allChars = [...new Set(this.questions.map(q => q.charName).filter(n => n))].sort();
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-6 border-b pb-2">Âá∫È°å„Ç≠„É£„É©ÈÅ∏Êäû</h2>
                        <div class="flex gap-2 mb-4">
                            <button id="select-all-btn" class="flex-1 py-2 border-2 border-indigo-600 text-indigo-600 rounded-lg text-sm font-bold">ÂÖ®ÈÅ∏Êäû</button>
                            <button id="deselect-all-btn" class="flex-1 py-2 border-2 border-gray-300 text-gray-600 rounded-lg text-sm font-bold">ÂÖ®Ëß£Èô§</button>
                        </div>
                        <div class="space-y-2 max-h-96 overflow-y-auto mb-6">
                            ${allChars.map(name => `
                                <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" value="${name}" class="char-checkbox w-5 h-5 mr-3" ${this.selectedCharacters.includes(name) || this.selectedCharacters.length === 0 ? 'checked' : ''}>
                                    <span>${name}</span>
                                </label>`).join('')}
                        </div>
                        <button id="apply-char-btn" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-md">ÈÅ∏Êäû„ÇíÁ¢∫ÂÆö</button>
                    </div>`;
            },

            attachEventListeners() {
                document.getElementById('start-quiz-btn')?.addEventListener('click', () => this.startQuiz());
                document.getElementById('nav-card-list-btn')?.addEventListener('click', () => this.setScreen('cardList'));
                document.getElementById('nav-char-select-btn')?.addEventListener('click', () => this.setScreen('charSelect'));
                document.querySelectorAll('#back-home-btn').forEach(b => b.addEventListener('click', () => this.setScreen('home')));

                document.getElementById('save-settings-btn')?.addEventListener('click', () => {
                    const val = parseInt(document.getElementById('total-questions-home').value);
                    if (val > 0) {
                        this.quizSettings.totalQuestions = val;
                        this.saveSettings();
                        alert("Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ");
                    }
                });

                document.querySelectorAll('.quiz-choice-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.submitAnswer(e.currentTarget.dataset.attribute));
                });

                document.getElementById('char-filter')?.addEventListener('change', (e) => {
                    const val = e.target.value;
                    document.querySelectorAll('.card-list-item').forEach(item => {
                        item.style.display = (val === '' || item.dataset.char === val) ? 'flex' : 'none';
                    });
                });

                document.getElementById('select-all-btn')?.addEventListener('click', () => document.querySelectorAll('.char-checkbox').forEach(c => c.checked = true));
                document.getElementById('deselect-all-btn')?.addEventListener('click', () => document.querySelectorAll('.char-checkbox').forEach(c => c.checked = false));
                document.getElementById('apply-char-btn')?.addEventListener('click', () => {
                    const selected = Array.from(document.querySelectorAll('.char-checkbox:checked')).map(c => c.value);
                    this.selectedCharacters = selected;
                    this.setScreen('home');
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => window.QuizApp.init());
    </script>
</head>
<body>
    <div id="app-container" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin h-10 w-10 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>
            <p class="mt-4 text-gray-600">CSVË™≠„ÅøËæº„Åø‰∏≠...</p>
        </div>
    </div>
    <div class="app-footer">X: nek0n0tem0</div>
</body>
</html>
