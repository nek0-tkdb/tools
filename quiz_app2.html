<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒå±æ€§3æŠã‚¯ã‚¤ã‚º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding-bottom: 30px;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            text-align: center;
            padding: 5px;
            font-size: 10px;
            color: #6b7280;
            background-color: #e5e7eb;
            z-index: 999;
        }
        img {
            pointer-events: none;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .fixed-card-img {
            width: 270px;
            height: 200px;
            object-fit: contain;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
        }
        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®èª¿æ•´ï¼šè¤‡æ•°è¡Œãƒ†ã‚­ã‚¹ãƒˆã«å¯¾å¿œ */
        #feedback-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 0.75rem;
            pointer-events: none;
            padding: 1rem;
        }
        .confetti {
            position: fixed;
            top: -20px;
            z-index: 9999;
            pointer-events: none;
            animation: fall linear forwards;
        }
        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    </style>
    <script>
        document.addEventListener('contextmenu', e => e.target.tagName === 'IMG' && e.preventDefault());
        document.addEventListener('dragstart', e => e.target.tagName === 'IMG' && e.preventDefault());

        const CSV_FILE = 'quiz_data2.csv';
        const APP_URL = 'https://nek0-tkdb.github.io/tools/quiz_app2.html';

        window.QuizApp = {
            questions: [],
            selectedCharacters: [],
            currentScreen: 'home',
            quizSettings: { totalQuestions: 3 },
            currentQuiz: { active: false, currentQuestionIndex: 0, score: 0, quizQuestions: [], answerHistory: [] },
            
            ATTRIBUTES: {
                fire: { name: 'èµ¤', color: 'bg-red-500 hover:bg-red-600 border-red-700', text: 'text-red-600' },
                water: { name: 'é’', color: 'bg-blue-500 hover:bg-blue-600 border-blue-700', text: 'text-blue-600' },
                grass: { name: 'ç·‘', color: 'bg-green-500 hover:bg-green-600 border-green-700', text: 'text-green-600' }
            },
            
            ATTRIBUTE_MAP: { 'èµ¤': 'fire', 'é’': 'water', 'ç·‘': 'grass' },

            async init() {
                this.loadSettings();
                await this.loadCsvData();
                this.renderApp();
            },

            loadSettings() {
                const stored = localStorage.getItem('quizSettings');
                if (stored) this.quizSettings = JSON.parse(stored);
            },

            async loadCsvData() {
                try {
                    const response = await fetch(CSV_FILE);
                    if (!response.ok) throw new Error('CSV not found');
                    const text = await response.text();
                    const lines = text.trim().split(/\r?\n/).slice(1); 

                    this.questions = lines.map((line, index) => {
                        const parts = line.split(',').map(s => {
                            let val = s.trim();
                            if (val.startsWith('"') && val.endsWith('"')) val = val.substring(1, val.length - 1);
                            return val.replace(/""/g, '"');
                        });
                        const [char, card, series, attr, url, date] = parts;
                        return {
                            id: index,
                            charName: char || '',
                            cardName: card || 'ç„¡é¡Œã®ã‚«ãƒ¼ãƒ‰',
                            series: series || '',
                            correctAttribute: this.ATTRIBUTE_MAP[attr] || 'fire',
                            imageUrl: url || '',
                            createdAt: date ? new Date(date) : new Date()
                        };
                    });
                } catch (e) { console.error(e); }
            },

            setScreen(screen) {
                this.currentScreen = screen;
                this.renderApp();
            },

            startQuiz() {
                let available = [...this.questions];
                if (this.selectedCharacters.length > 0) {
                    available = available.filter(q => this.selectedCharacters.includes(q.charName));
                }
                if (available.length === 0) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");

                available.sort(() => Math.random() - 0.5);
                const count = Math.min(this.quizSettings.totalQuestions, available.length);

                this.currentQuiz = {
                    active: true,
                    currentQuestionIndex: 0,
                    score: 0,
                    quizQuestions: available.slice(0, count),
                    answerHistory: []
                };
                this.setScreen('quiz');
            },

            triggerConfetti() {
                const colors = ['#FFD700', '#FF6347', '#32CD32', '#1E90FF', '#FF69B4', '#00CED1'];
                const shapes = ['â˜…', 'â˜…', 'â˜…', 'â˜†'];
                const confettiCount = 100;
                const container = document.body;

                for (let i = 0; i < confettiCount; i++) {
                    const el = document.createElement('div');
                    el.className = 'confetti';
                    el.innerText = shapes[Math.floor(Math.random() * shapes.length)];
                    el.style.left = Math.random() * 100 + 'vw';
                    el.style.color = colors[Math.floor(Math.random() * colors.length)];
                    el.style.fontSize = Math.random() * 20 + 15 + 'px';
                    el.style.animationDuration = Math.random() * 2 + 1.5 + 's';
                    el.style.animationDelay = Math.random() * 0.5 + 's';
                    container.appendChild(el);
                    setTimeout(() => el.remove(), 3000);
                }
            },

            submitAnswer(attr) {
                const quiz = this.currentQuiz;
                const currentQ = quiz.quizQuestions[quiz.currentQuestionIndex];
                const isCorrect = currentQ.correctAttribute === attr;
                const corAttrData = this.ATTRIBUTES[currentQ.correctAttribute];
                
                quiz.answerHistory.push({ question: currentQ, selected: attr, correct: isCorrect });
                
                const overlay = document.getElementById('feedback-overlay');
                const btns = document.querySelectorAll('.quiz-choice-btn');
                btns.forEach(b => b.disabled = true);
                
                // æ­£èª¤åˆ¤å®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã‚«ãƒ¼ãƒ‰åã€æ­£è§£å±æ€§ã‚’è¡¨ç¤º
                overlay.innerHTML = `
                    <div class="text-4xl font-black mb-2">${isCorrect ? 'æ­£è§£ï¼' : 'ä¸æ­£è§£...'}</div>
                    <div class="text-sm text-gray-800 font-bold mb-1">${currentQ.cardName}</div>
                    <div class="text-lg font-bold">æ­£è§£: <span class="${corAttrData.text}">${corAttrData.name}</span></div>
                `;

                overlay.style.display = 'flex';
                if (isCorrect) {
                    quiz.score++;
                    overlay.style.color = '#10B981';
                    overlay.style.backgroundColor = 'rgba(209, 250, 229, 0.9)';
                    this.triggerConfetti();
                } else {
                    overlay.style.color = '#EF4444';
                    overlay.style.backgroundColor = 'rgba(254, 226, 226, 0.9)';
                }

                setTimeout(() => {
                    quiz.currentQuestionIndex++;
                    if (quiz.currentQuestionIndex >= quiz.quizQuestions.length) {
                        quiz.active = false;
                        this.setScreen('results');
                    } else {
                        this.renderApp();
                    }
                }, 2000); // æƒ…å ±é‡ãŒå¢—ãˆãŸã®ã§ã€ç¢ºèªæ™‚é–“ã‚’å°‘ã—é•·ã‚ï¼ˆ2ç§’ï¼‰ã«è¨­å®š
            },

            renderApp() {
                const container = document.getElementById('app-container');
                let html = '';
                switch (this.currentScreen) {
                    case 'home': html = this.renderHome(); break;
                    case 'quiz': html = this.renderQuiz(); break;
                    case 'cardList': html = this.renderCardList(); break;
                    case 'charSelect': html = this.renderCharSelect(); break;
                    case 'results': html = this.renderResults(); break;
                }
                container.innerHTML = `<div class="max-w-4xl mx-auto w-full p-4 sm:p-8">${html}</div>`;
                this.attachEventListeners();
            },

            renderHome() {
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                        <h1 class="text-3xl font-extrabold mb-6">å±æ€§å½“ã¦ã‚¯ã‚¤ã‚º</h1>
                        <div class="mb-6 border-b pb-4">
                            <label class="block text-sm font-medium mb-2">å‡ºé¡Œæ•° (${this.quizSettings.totalQuestions}å•)</label>
                            <input type="number" id="total-questions-home" value="${this.quizSettings.totalQuestions}" min="1" class="p-3 border rounded-xl w-32 text-center">
                        </div>
                        <div class="space-y-4">
                            <button id="start-quiz-btn" class="w-full text-xl py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:scale-[1.02] transition">ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                            <button id="nav-char-select-btn" class="w-full py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-100">ğŸ¯ ã‚­ãƒ£ãƒ©ã‚’é¸æŠ (${this.selectedCharacters.length === 0 ? 'å…¨ã‚­ãƒ£ãƒ©' : this.selectedCharacters.length + 'å'})</button>
                            <button id="nav-card-list-btn" class="w-full py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-100">ã‚«ãƒ¼ãƒ‰ä¸€è¦§ (${this.questions.length}æš)</button>
                        </div>
                    </div>`;
            },

            renderQuiz() {
                const quiz = this.currentQuiz;
                const choices = ['fire', 'water', 'grass'].sort(() => Math.random() - 0.5);
                const currentQ = quiz.quizQuestions[quiz.currentQuestionIndex];

                return `
                    <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center">
                        <div class="w-full relative overflow-hidden">
                            <div id="feedback-overlay"></div>
                            <div class="flex justify-between items-center mb-4 border-b pb-3">
                                <h2 class="text-xl font-bold">å•é¡Œ ${quiz.currentQuestionIndex + 1} / ${quiz.quizQuestions.length}</h2>
                                <button id="abort-quiz-btn" class="text-sm text-gray-500 hover:underline">ä¸­æ–­ã—ã¦æˆ»ã‚‹</button>
                            </div>
                            <div class="text-center mb-6">
                                 <p class="text-gray-500 text-sm italic">ç”»åƒã‹ã‚‰å±æ€§ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„</p>
                            </div>
                            
                            <div class="flex justify-center mb-6">
                                <img src="${currentQ.imageUrl}" class="fixed-card-img shadow-md">
                            </div>

                            <div class="grid grid-cols-1 gap-4 w-full">
                                ${choices.map(attr => `<button data-attribute="${attr}" class="quiz-choice-btn py-4 rounded-xl text-white font-bold shadow-md border-b-4 transition hover:scale-[1.02] ${this.ATTRIBUTES[attr].color}">${this.ATTRIBUTES[attr].name}</button>`).join('')}
                            </div>
                        </div>
                    </div>`;
            },

            renderResults() {
                const quiz = this.currentQuiz;
                const shareText = encodeURIComponent(`å±æ€§å½“ã¦ã‚¯ã‚¤ã‚ºã®çµæœï¼š${quiz.quizQuestions.length}å•ä¸­${quiz.score}ç‚¹ã§ã—ãŸï¼\n#ç”»åƒå±æ€§ã‚¯ã‚¤ã‚º\n${APP_URL}`);
                const xShareUrl = `https://twitter.com/intent/tweet?text=${shareText}`;

                const historyHtml = quiz.answerHistory.map((h, i) => {
                    const selAttr = this.ATTRIBUTES[h.selected];
                    const corAttr = this.ATTRIBUTES[h.question.correctAttribute];
                    
                    return `
                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg border ${h.correct ? 'border-green-200' : 'border-red-200'}">
                        <div class="w-20 h-16 flex-shrink-0 bg-gray-200 rounded overflow-hidden">
                            <img src="${h.question.imageUrl}" class="w-full h-full object-contain">
                        </div>
                        <div class="flex-1 text-left min-w-0">
                            <p class="font-bold text-sm truncate">${h.question.cardName}</p>
                            <p class="text-[10px] text-gray-500 truncate">${h.question.charName} / ${h.question.series}</p>
                            <div class="text-xs mt-1">
                                <span class="mr-3">é¸ã‚“ã : <b class="${selAttr.text}">${selAttr.name}</b></span>
                                <span>æ­£è§£: <b class="${corAttr.text}">${corAttr.name}</b></span>
                            </div>
                        </div>
                        <div class="flex flex-col items-center min-w-[60px]">
                            <div class="text-xl">${h.correct ? 'âœ…' : 'âŒ'}</div>
                            <div class="text-[10px] font-bold ${h.correct ? 'text-green-600' : 'text-red-600'}">${h.correct ? 'æ­£è§£' : 'ä¸æ­£è§£'}</div>
                        </div>
                    </div>
                `}).join('');

                return `
                    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                        <h2 class="text-2xl font-bold mb-4">çµæœç™ºè¡¨</h2>
                        <p class="text-5xl font-black mb-6 text-indigo-600">${quiz.score} / ${quiz.quizQuestions.length}</p>
                        
                        <div class="flex gap-2 mb-8">
                            <button id="back-home-btn" class="flex-1 py-3 border-2 border-gray-300 rounded-xl font-bold hover:bg-gray-100">ãƒ›ãƒ¼ãƒ ã¸</button>
                            <a href="${xShareUrl}" target="_blank" class="flex-1 py-3 bg-black text-white rounded-xl font-bold flex items-center justify-center hover:bg-gray-800 transition">Xã§ã‚·ã‚§ã‚¢</a>
                        </div>

                        <div class="text-left">
                            <h3 class="font-bold mb-4 border-l-4 border-indigo-500 pl-2">å›ç­”å±¥æ­´</h3>
                            <div class="space-y-3">
                                ${historyHtml}
                            </div>
                        </div>
                    </div>`;
            },

            renderCardList() {
                const charNames = [...new Set(this.questions.map(q => q.charName).filter(n => n))].sort();
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-2">ã‚«ãƒ¼ãƒ‰ä¸€è¦§</h2>
                        <p class="text-sm text-gray-600 mb-6">è¡¨ç¤ºä¸­: <span id="filtered-count" class="font-bold text-indigo-600">${this.questions.length}</span> / å…¨${this.questions.length}ä»¶</p>
                        <select id="char-filter" class="w-full p-3 border rounded-lg mb-6"><option value="">ã™ã¹ã¦ã®ã‚­ãƒ£ãƒ©ã‚’è¡¨ç¤º</option>${charNames.map(n => `<option value="${n}">${n}</option>`).join('')}</select>
                        <ul class="divide-y border rounded-xl overflow-hidden h-96 overflow-y-auto">
                            ${this.questions.map(q => `
                                <li class="card-list-item p-4 flex items-center gap-3 hover:bg-gray-50" data-char="${q.charName}">
                                    <div class="w-16 h-12 flex-shrink-0 bg-gray-200 rounded overflow-hidden">
                                        <img src="${q.imageUrl}" class="w-full h-full object-contain">
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium truncate">${q.cardName}</p>
                                        <p class="text-xs text-gray-500">${q.charName}</p>
                                    </div>
                                    <span class="px-3 py-1 text-xs font-bold rounded-full text-white ${this.ATTRIBUTES[q.correctAttribute].color.split(' ')[0]}">${this.ATTRIBUTES[q.correctAttribute].name}</span>
                                </li>`).join('')}
                        </ul>
                        <button id="back-home-btn" class="w-full mt-6 py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-100">æˆ»ã‚‹</button>
                    </div>`;
            },

            attachEventListeners() {
                document.getElementById('start-quiz-btn')?.addEventListener('click', () => this.startQuiz());
                document.getElementById('nav-card-list-btn')?.addEventListener('click', () => this.setScreen('cardList'));
                document.getElementById('nav-char-select-btn')?.addEventListener('click', () => this.setScreen('charSelect'));
                document.querySelectorAll('#back-home-btn').forEach(b => b.addEventListener('click', () => this.setScreen('home')));
                document.getElementById('abort-quiz-btn')?.addEventListener('click', () => confirm('ã‚¯ã‚¤ã‚ºã‚’ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿ') && this.setScreen('home'));

                document.getElementById('total-questions-home')?.addEventListener('change', (e) => {
                    this.quizSettings.totalQuestions = parseInt(e.target.value) || 3;
                    localStorage.setItem('quizSettings', JSON.stringify(this.quizSettings));
                });

                document.querySelectorAll('.quiz-choice-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.submitAnswer(e.currentTarget.dataset.attribute));
                });

                document.getElementById('char-filter')?.addEventListener('change', (e) => {
                    const val = e.target.value;
                    let count = 0;
                    document.querySelectorAll('.card-list-item').forEach(item => {
                        const isVisible = (val === '' || item.dataset.char === val);
                        item.style.display = isVisible ? 'flex' : 'none';
                        if (isVisible) count++;
                    });
                    document.getElementById('filtered-count').innerText = count;
                });

                document.getElementById('select-all-btn')?.addEventListener('click', () => document.querySelectorAll('.char-checkbox').forEach(c => c.checked = true));
                document.getElementById('deselect-all-btn')?.addEventListener('click', () => document.querySelectorAll('.char-checkbox').forEach(c => c.checked = false));
                document.getElementById('apply-char-btn')?.addEventListener('click', () => {
                    this.selectedCharacters = Array.from(document.querySelectorAll('.char-checkbox:checked')).map(c => c.value);
                    this.setScreen('home');
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => window.QuizApp.init());
    </script>
</head>
<body>
    <div id="app-container" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin h-8 w-8 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>
            <p class="mt-4 text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>
    <div class="app-footer">X: nek0n0tem0</div>
</body>
</html>
