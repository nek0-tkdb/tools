<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±æ€§ãƒã‚¹ã‚¿ãƒ¼ - ç”»åƒå±æ€§3æŠã‚¯ã‚¤ã‚º</title>
    <!-- Tailwind CSS CDNã‚’ãƒ­ãƒ¼ãƒ‰ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        /* å±æ€§ãƒœã‚¿ãƒ³ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¨è‰² */
        .type-button {
            transition: all 0.2s ease-in-out;
            @apply flex-1 py-4 text-xl font-bold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5;
        }
        .type-fire { @apply bg-red-600 text-white hover:bg-red-700; }
        .type-water { @apply bg-blue-600 text-white hover:bg-blue-700; }
        .type-grass { @apply bg-green-600 text-white hover:bg-green-700; }
        .disabled-button { @apply opacity-50 cursor-not-allowed; }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆç®¡ç†ç”»é¢ç”¨ï¼‰ */
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .scrollable-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .scrollable-content::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="app" class="w-full max-w-4xl bg-white rounded-2xl shadow-2xl p-6 md:p-10">

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ -->
        <header class="mb-8 border-b pb-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-gray-800">å±æ€§ãƒã‚¹ã‚¿ãƒ¼</h1>
            <div class="flex space-x-2">
                <button id="nav-quiz" class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition">ã‚¯ã‚¤ã‚º</button>
                <button id="nav-admin" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition">ç®¡ç†</button>
            </div>
        </header>

        <!-- èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼IDè¡¨ç¤º -->
        <div class="text-sm text-gray-500 mb-4 p-2 bg-gray-100 rounded-lg">
            <p>èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="auth-status" class="font-medium text-red-500">èªè¨¼ä¸­...</span></p>
            <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (ãƒ‡ãƒ¼ã‚¿ä¿å­˜å…ˆ): <span id="user-id" class="font-mono text-xs break-all"></span></p>
        </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ (ã‚¨ãƒ©ãƒ¼ã‚„æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸) -->
        <div id="message-area" class="mb-4 hidden p-3 rounded-lg text-sm font-medium"></div>
        
        <!-- èªè¨¼å¾…æ©Ÿä¸­ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-70 flex items-center justify-center hidden z-10 rounded-2xl">
            <div class="text-center p-8 rounded-xl shadow-2xl bg-indigo-50">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent mx-auto mb-4"></div>
                <p class="text-xl font-semibold text-indigo-700">èªè¨¼ã¨ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
                <p class="text-sm text-gray-500 mt-2">ï¼ˆFirebaseè¨­å®šãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼‰</p>
            </div>
        </div>


        <!-- ã‚¯ã‚¤ã‚ºç”»é¢ (View: quiz) -->
        <section id="view-quiz" class="space-y-6">
            <div id="quiz-settings" class="mb-6 p-4 bg-gray-50 rounded-xl shadow-inner">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">ã‚¯ã‚¤ã‚ºè¨­å®š</h2>
                <div class="flex items-center space-x-4">
                    <label for="num-questions" class="text-gray-600">å‡ºé¡Œæ•°:</label>
                    <input type="number" id="num-questions" value="10" min="1" max="50" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="start-quiz-btn" class="px-6 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition">ã‚¯ã‚¤ã‚ºé–‹å§‹</button>
                </div>
                <p id="total-items-count" class="mt-2 text-sm text-gray-500"></p>
            </div>

            <div id="quiz-area" class="hidden">
                <p class="text-lg font-medium text-gray-700 mb-4">
                    å•é¡Œ <span id="current-question-index">1</span> / <span id="total-questions">10</span>
                </p>

                <!-- ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="relative mb-6 bg-gray-100 rounded-xl overflow-hidden shadow-inner flex items-center justify-center p-4" style="height: 300px;">
                    <img id="question-image" src="" alt="å‡ºé¡Œç”»åƒ" class="max-h-full max-w-full object-contain rounded-lg shadow-md" onerror="this.onerror=null; this.src='https://placehold.co/400x300/e5e7eb/4b5563?text=ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';">
                    <!-- è§£ç­”è¡¨ç¤ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
                    <div id="answer-overlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-70 text-4xl font-black text-white rounded-xl transition-opacity duration-300 opacity-0 pointer-events-none">
                        <span id="answer-text"></span>
                    </div>
                </div>

                <!-- é¸æŠè‚¢ãƒœã‚¿ãƒ³ -->
                <div id="choice-buttons" class="flex space-x-4">
                    <button data-type="fire" class="type-button type-fire">ğŸ”¥ ç«å±æ€§</button>
                    <button data-type="water" class="type-button type-water">ğŸ’§ æ°´å±æ€§</button>
                    <button data-type="grass" class="type-button type-grass">ğŸŒ¿ è‰å±æ€§</button>
                </div>

                <!-- æ¬¡ã¸ãƒœã‚¿ãƒ³ -->
                <div class="mt-6 flex justify-end">
                    <button id="next-question-btn" class="px-6 py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition disabled-button" disabled>æ¬¡ã¸</button>
                </div>
            </div>

            <!-- çµæœç”»é¢ -->
            <div id="result-area" class="hidden text-center p-8 bg-white rounded-xl shadow-lg">
                <h2 class="text-4xl font-extrabold text-indigo-600 mb-4">ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼</h2>
                <p class="text-2xl font-semibold text-gray-700 mb-6">ã‚ãªãŸã®ã‚¹ã‚³ã‚¢:</p>
                <div class="text-6xl font-black text-green-600 mb-8">
                    <span id="final-score">0</span> / <span id="max-score">0</span>
                </div>
                <button id="restart-quiz-btn" class="px-8 py-3 bg-indigo-500 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-600 transition">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
            </div>
        </section>

        <!-- ç®¡ç†ç”»é¢ (View: admin) -->
        <section id="view-admin" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">å•é¡Œç®¡ç†ç”»é¢</h2>

            <!-- CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
            <div class="mb-8 p-5 bg-yellow-50 rounded-xl shadow-md">
                <h3 class="text-xl font-semibold mb-3 text-yellow-800">CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (ä¸€æ‹¬ç™»éŒ²ãƒ»æ›´æ–°)</h3>
                <p class="text-sm text-yellow-700 mb-3">â€» æ—¢å­˜ã®å•é¡Œã¯å…¨ã¦ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚</p>
                <input type="file" id="csv-file-input" accept=".csv" class="mb-3 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-100 file:text-yellow-700 hover:file:bg-yellow-200" disabled>
                <button id="upload-csv-btn" class="px-4 py-2 bg-yellow-600 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-700 transition disabled-button" disabled>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            </div>

            <!-- æ–°è¦å•é¡Œç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="item-form-container" class="mb-8 p-5 bg-gray-100 rounded-xl shadow-md">
                <h3 class="text-xl font-semibold mb-3 text-gray-800" id="form-title">æ–°è¦å•é¡Œç™»éŒ²</h3>
                <input type="hidden" id="item-id-to-edit">
                <div class="space-y-3">
                    <div>
                        <label for="image-url-input" class="block text-sm font-medium text-gray-700">ç”»åƒURL (GitHub Pagesãªã©)</label>
                        <input type="url" id="image-url-input" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" disabled>
                    </div>
                    <div>
                        <label for="correct-type-input" class="block text-sm font-medium text-gray-700">æ­£è§£å±æ€§</label>
                        <select id="correct-type-input" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" disabled>
                            <option value="fire">ç«å±æ€§ (fire)</option>
                            <option value="water">æ°´å±æ€§ (water)</option>
                            <option value="grass">è‰å±æ€§ (grass)</option>
                        </select>
                    </div>
                    <div class="flex space-x-2">
                        <button id="save-item-btn" class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition disabled-button" disabled>ç™»éŒ²/æ›´æ–°</button>
                        <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 transition hidden">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
            </div>

            <!-- å•é¡Œãƒªã‚¹ãƒˆ -->
            <div class="mb-4">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">ç™»éŒ²æ¸ˆã¿å•é¡Œä¸€è¦§ (<span id="admin-item-count">0</span>ä»¶)</h3>
                <div id="item-list-container" class="bg-gray-50 p-4 rounded-xl shadow-inner max-h-96 scrollable-content overflow-y-auto">
                    <!-- ãƒªã‚¹ãƒˆã¯ onSnapshot ã§æ›´æ–°ã•ã‚Œã¾ã™ -->
                    <p id="list-loading-message" class="text-gray-500 text-center py-4">èªè¨¼ã¨ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚’å¾…æ©Ÿä¸­...</p>
                    <table class="min-w-full divide-y divide-gray-200 hidden">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç”»åƒURL</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å±æ€§</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="item-list" class="bg-white divide-y divide-gray-200">
                            <!-- å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <!-- Firebase SDKã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, 
            query, writeBatch, runTransaction, getDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // 1. FirebaseåˆæœŸè¨­å®šã¨èªè¨¼
        // =================================================================================
        
        // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰Firebaseè¨­å®šã¨èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Canvasç’°å¢ƒå¤–ã§å®Ÿè¡Œã•ã‚ŒãŸå ´åˆï¼ˆ__firebase_configãŒå­˜åœ¨ã—ãªã„å ´åˆï¼‰ã«å‚™ãˆã€
        // ãƒ€ãƒŸãƒ¼ã®Firebaseè¨­å®šã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã§ãã‚‹ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç”¨æ„ã—ã¾ã™ã€‚
        let firebaseConfig;
        let isConfigPlaceholder = false;

        if (typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0) {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            // !!! æ³¨æ„ !!!
            // GitHub Pagesãªã©ã§å…¬é–‹ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®ãƒ€ãƒŸãƒ¼è¨­å®šã‚’
            // ã”è‡ªèº«ã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šå€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
            // ã“ã‚ŒãŒãªã„ã¨ã€Firestoreã¸ã®èª­ã¿æ›¸ãã¯ã§ãã¾ã›ã‚“ã€‚
            isConfigPlaceholder = true;
            console.warn("Canvasç’°å¢ƒå¤–ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚Firebaseè¨­å®šãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
            displayMessage("ã€é‡è¦ã€‘Firebaseè¨­å®šãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ç®¡ç†æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å†…ã®firebaseConfigã‚’å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚", 'error');
            firebaseConfig = {
                apiKey: "AIzaSyCF2mISZbPAAnajQKUsb6Bx-09skAkYaJs", // å®Ÿéš›ã®APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã‚‹
                authDomain: "ssrproject1208.firebaseapp.com", // å®Ÿéš›ã®Auth Domainã«ç½®ãæ›ãˆã‚‹
                projectId: "ssrproject1208", // å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã«ç½®ãæ›ãˆã‚‹ (å¿…é ˆ)
                storageBucket: "ssrproject1208.firebasestorage.app",
                messagingSenderId: "693929077122",
                appId: "1:693929077122:web:010621739e9ece7be1479b",
                measurementId: "G-XQB6ZWQ3NL"
            };
        }
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // Firestoreã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã‚’å®šç¾© (å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜)
        const COLLECTION_PATH = `artifacts/${appId}/public/data/quiz_items`;
        
        // èªè¨¼ä¸­ã«ç®¡ç†UIã‚’ç„¡åŠ¹åŒ–ã™ã‚‹é–¢æ•°
        function disableAdminUI(isDisabled) {
            document.getElementById('csv-file-input').disabled = isDisabled;
            document.getElementById('upload-csv-btn').disabled = isDisabled;
            document.getElementById('image-url-input').disabled = isDisabled;
            document.getElementById('correct-type-input').disabled = isDisabled;
            document.getElementById('save-item-btn').disabled = isDisabled;
            
            document.getElementById('upload-csv-btn').classList.toggle('disabled-button', isDisabled);
            document.getElementById('save-item-btn').classList.toggle('disabled-button', isDisabled);

            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                // UIãŒæº–å‚™ã§ãã‚‹ã¾ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
                overlay.classList.toggle('hidden', !isDisabled);
            }
            
            const listMessage = document.getElementById('list-loading-message');
            const listTable = document.getElementById('item-list-container').querySelector('table');

            if (isDisabled) {
                 if (listMessage) listMessage.classList.remove('hidden');
                 if (listTable) listTable.classList.add('hidden');
            } else {
                 if (listMessage) listMessage.classList.add('hidden');
                 if (listTable) listTable.classList.remove('hidden');
            }
        }


        /**
         * Firebaseã¨èªè¨¼ã®åˆæœŸåŒ–
         */
        async function initializeFirebase() {
            // ã¾ãšUIã‚’ç„¡åŠ¹åŒ–ã—ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã™ã‚‹
            disableAdminUI(true);

            try {
                // projectIdãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆï¼ˆGitHub Pagesãªã©ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã‚’å¿˜ã‚ŒãŸå ´åˆï¼‰ã®ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
                if (!firebaseConfig.projectId || firebaseConfig.projectId === "YOUR-PROJECT-ID") {
                    console.error("è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼: Firebase 'projectId' ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                    document.getElementById('auth-status').textContent = 'èªè¨¼å¤±æ•— (è¨­å®šä¸è¶³)';
                    document.getElementById('auth-status').classList.remove('text-green-600');
                    document.getElementById('auth-status').classList.add('text-red-500');
                    disableAdminUI(false); // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºå¾Œã€UIã¯æœ‰åŠ¹åŒ–ï¼ˆãŸã ã—æ©Ÿèƒ½ã¯å‹•ã‹ãªã„ï¼‰
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // èªè¨¼ãŒå®Œäº†ã™ã‚‹ã¾ã§ã€ã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹Promise
                const authReadyPromise = new Promise((resolve) => {
                    let unsubscribe = () => {}; // ãƒªã‚¹ãƒŠãƒ¼è§£é™¤ç”¨ã®ãƒ€ãƒŸãƒ¼é–¢æ•°
                    let timeoutId;

                    // 10ç§’ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
                    timeoutId = setTimeout(() => {
                        unsubscribe();
                        console.error("Firebaseèªè¨¼ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 10ç§’ä»¥å†…ã«èªè¨¼ãŒå®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                        resolve({ success: false, reason: 'timeout' });
                    }, 10000); // 10ç§’

                    unsubscribe = onAuthStateChanged(auth, async (user) => {
                        clearTimeout(timeoutId); // èªè¨¼ãŒå®Œäº†ã—ãŸã‚‰ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è§£é™¤
                        
                        if (user) {
                            // èªè¨¼æˆåŠŸæ™‚
                            userId = user.uid;
                            document.getElementById('user-id').textContent = userId;
                            document.getElementById('auth-status').textContent = 'èªè¨¼æ¸ˆã¿ (ã‚«ã‚¹ã‚¿ãƒ /åŒ¿å)';
                            document.getElementById('auth-status').classList.remove('text-red-500');
                            document.getElementById('auth-status').classList.add('text-green-600');
                            unsubscribe(); // ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
                            resolve({ success: true });
                        } else {
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ãªã„å ´åˆã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’è©¦ã¿ã‚‹ (ã“ã®å‡¦ç†ã¯ä¸€å›ã®ã¿å®Ÿè¡Œ)
                            if (!auth.currentUser) {
                                try {
                                    if (initialAuthToken) {
                                        // Canvasç’°å¢ƒ: ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã§ãƒ­ã‚°ã‚¤ãƒ³
                                        await signInWithCustomToken(auth, initialAuthToken);
                                    } else {
                                        // GitHub Pagesãªã©: åŒ¿åã§ãƒ­ã‚°ã‚¤ãƒ³
                                        await signInAnonymously(auth);
                                    }
                                    // ã‚µã‚¤ãƒ³ã‚¤ãƒ³æˆåŠŸå¾Œã€onAuthStateChangedãŒå†åº¦å‘¼ã°ã‚Œã‚‹ã®ã§ã€ã“ã“ã§ã¯å¾…ã¤
                                } catch (e) {
                                    // ã‚µã‚¤ãƒ³ã‚¤ãƒ³å¤±æ•—æ™‚
                                    clearTimeout(timeoutId);
                                    console.error("ã‚µã‚¤ãƒ³ã‚¤ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼:", e);
                                    document.getElementById('auth-status').textContent = 'èªè¨¼å¤±æ•—';
                                    document.getElementById('auth-status').classList.remove('text-green-600');
                                    document.getElementById('auth-status').classList.add('text-red-500');
                                    unsubscribe(); // ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
                                    resolve({ success: false, reason: 'sign_in_failed' });
                                }
                            }
                        }
                    });
                });

                // èªè¨¼å®Œäº†ï¼ˆã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰ã‚’å¾…ã¤
                const result = await authReadyPromise;
                
                isAuthReady = true;
                disableAdminUI(false); // UIã‚’æœ‰åŠ¹åŒ–

                if (result.success) {
                    // èªè¨¼ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿Firestoreã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
                    setupListeners();
                    updateTotalItemCount();
                } else if (result.reason === 'timeout') {
                    displayMessage('ã€è­¦å‘Šã€‘èªè¨¼ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚Firebaseè¨­å®šãŒæ­£ã—ã„ã‹ã€ã¾ãŸã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                } else if (result.reason === 'sign_in_failed') {
                    displayMessage('ã€ã‚¨ãƒ©ãƒ¼ã€‘åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firebaseã®èªè¨¼è¨­å®šï¼ˆåŒ¿åèªè¨¼ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                }

            } catch (error) {
                console.error("FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
                displayMessage(`FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                isAuthReady = true;
                disableAdminUI(false); // UIã‚’æœ‰åŠ¹åŒ–
            }
        }

        // =================================================================================
        // 2. ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // =================================================================================

        let quizItems = []; // å…¨å•é¡Œãƒªã‚¹ãƒˆ
        let currentQuiz = []; // ç¾åœ¨ã®ã‚¯ã‚¤ã‚ºã§å‡ºé¡Œã•ã‚Œã‚‹å•é¡Œã®ã‚µãƒ–ã‚»ãƒƒãƒˆ
        let currentQuestionIndex = 0;
        let score = 0;
        let isQuestionActive = false;
        
        const views = {
            quiz: document.getElementById('view-quiz'),
            admin: document.getElementById('view-admin')
        };
        const elements = {
            messageArea: document.getElementById('message-area'),
            totalItemsCount: document.getElementById('total-items-count'),
            adminItemCount: document.getElementById('admin-item-count'),
            startQuizBtn: document.getElementById('start-quiz-btn'),
            numQuestionsInput: document.getElementById('num-questions'),
            quizSettings: document.getElementById('quiz-settings'),
            quizArea: document.getElementById('quiz-area'),
            resultArea: document.getElementById('result-area'),
            questionImage: document.getElementById('question-image'),
            answerOverlay: document.getElementById('answer-overlay'),
            answerText: document.getElementById('answer-text'),
            choiceButtons: document.getElementById('choice-buttons'),
            nextQuestionBtn: document.getElementById('next-question-btn'),
            finalScore: document.getElementById('final-score'),
            maxScore: document.getElementById('max-score'),
            restartQuizBtn: document.getElementById('restart-quiz-btn'),
            itemList: document.getElementById('item-list'),
            saveItemBtn: document.getElementById('save-item-btn'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            itemIdToEdit: document.getElementById('item-id-to-edit'),
            imageUrlInput: document.getElementById('image-url-input'),
            correctTypeInput: document.getElementById('correct-type-input'),
            formTitle: document.getElementById('form-title'),
            csvFileInput: document.getElementById('csv-file-input'),
            uploadCsvBtn: document.getElementById('upload-csv-btn'),
            currentQuestionIndexSpan: document.getElementById('current-question-index'),
            totalQuestionsSpan: document.getElementById('total-questions')
        };
        
        /**
         * ãƒ“ãƒ¥ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
         * @param {string} viewName - 'quiz' ã¾ãŸã¯ 'admin'
         */
        function switchView(viewName) {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.getElementById('nav-quiz').classList.toggle('bg-indigo-500', viewName === 'quiz');
            document.getElementById('nav-quiz').classList.toggle('bg-gray-200', viewName !== 'quiz');
            document.getElementById('nav-quiz').classList.toggle('text-white', viewName === 'quiz');
            document.getElementById('nav-quiz').classList.toggle('text-gray-800', viewName !== 'quiz');

            document.getElementById('nav-admin').classList.toggle('bg-indigo-500', viewName === 'admin');
            document.getElementById('nav-admin').classList.toggle('bg-gray-200', viewName !== 'admin');
            document.getElementById('nav-admin').classList.toggle('text-white', viewName === 'admin');
            document.getElementById('nav-admin').classList.toggle('text-gray-800', viewName !== 'admin');
        }
        
        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
         * @param {string} msg - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         * @param {'success' | 'error' | 'info'} type - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¨®é¡
         */
        function displayMessage(msg, type) {
            elements.messageArea.textContent = msg;
            elements.messageArea.className = 'mb-4 p-3 rounded-lg text-sm font-medium'; // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            elements.messageArea.classList.remove('hidden');
            
            if (type === 'success') {
                elements.messageArea.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                elements.messageArea.classList.add('bg-red-100', 'text-red-800');
            } else {
                elements.messageArea.classList.add('bg-blue-100', 'text-blue-800');
            }
            
            // 5ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            setTimeout(() => {
                elements.messageArea.classList.add('hidden');
            }, 5000);
        }

        // =================================================================================
        // 3. Firestoreãƒ‡ãƒ¼ã‚¿æ“ä½œ (CRUD & CSV)
        // =================================================================================

        /**
         * Firestoreã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’ç›£è¦–ã—ã€quizItemsã‚’æ›´æ–°ã™ã‚‹
         */
        function setupListeners() {
            // Firebaseè¨­å®šãŒãƒ€ãƒŸãƒ¼ã®å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ãªã„
            if (isConfigPlaceholder) {
                document.getElementById('auth-status').textContent = 'è¨­å®šä¸è¶³ (èª­ã¿æ›¸ãä¸å¯)';
                document.getElementById('auth-status').classList.remove('text-green-600');
                document.getElementById('auth-status').classList.add('text-red-500');
                return;
            }
            
            // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (!auth.currentUser) return;

            const q = query(collection(db, COLLECTION_PATH));
            
            onSnapshot(q, (snapshot) => {
                const items = [];
                snapshot.forEach((doc) => {
                    items.push({ id: doc.id, ...doc.data() });
                });
                quizItems = items;
                updateAdminList(quizItems);
                updateTotalItemCount();
                
                // ã‚¯ã‚¤ã‚ºãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãªã„å ´åˆã€å•é¡Œãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ã‚¯ã‚¤ã‚ºè¨­å®šã‚‚æ›´æ–°
                if (elements.quizArea.classList.contains('hidden') && elements.resultArea.classList.contains('hidden')) {
                    checkQuizReadiness();
                }
                
                // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ä»¥å¤–ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                if (isAuthReady) {
                    displayMessage(`å•é¡Œãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ (${quizItems.length}ä»¶)`);
                }
            }, (error) => {
                console.error("Firestoreãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:", error);
                displayMessage(`å•é¡Œã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}ã€‚Firebaseè¨­å®šã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 'error');
            });
        }
        
        /**
         * ç¾åœ¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å•é¡Œæ•°ã‚’æ›´æ–°
         */
        function updateTotalItemCount() {
            const count = quizItems.length;
            elements.totalItemsCount.textContent = `ç¾åœ¨ ${count} ä»¶ã®å•é¡ŒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
            elements.adminItemCount.textContent = count;
            checkQuizReadiness();
        }

        /**
         * å•é¡Œãƒªã‚¹ãƒˆã®ä»¶æ•°ã«åŸºã¥ã„ã¦ã‚¯ã‚¤ã‚ºé–‹å§‹ãƒœã‚¿ãƒ³ã®æ´»æ€§åŒ–ã‚’ãƒã‚§ãƒƒã‚¯
         */
        function checkQuizReadiness() {
             if (quizItems.length === 0) {
                elements.startQuizBtn.disabled = true;
                elements.startQuizBtn.textContent = 'å•é¡Œãªã— (ç®¡ç†ç”»é¢ã§è¿½åŠ ã—ã¦ãã ã•ã„)';
                elements.startQuizBtn.classList.add('disabled-button');
            } else {
                elements.startQuizBtn.disabled = false;
                elements.startQuizBtn.textContent = 'ã‚¯ã‚¤ã‚ºé–‹å§‹';
                elements.startQuizBtn.classList.remove('disabled-button');
            }
        }

        /**
         * å•é¡Œã‚’ä¿å­˜ï¼ˆæ–°è¦ç™»éŒ²ã¾ãŸã¯æ›´æ–°ï¼‰
         */
        async function saveItem() {
            if (isConfigPlaceholder) {
                return displayMessage('ã€ã‚¨ãƒ©ãƒ¼ã€‘Firebaseè¨­å®šãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚', 'error');
            }
            if (!isAuthReady || !auth.currentUser) { // auth.currentUserã®ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
                return displayMessage('èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
            }

            const id = elements.itemIdToEdit.value;
            const imageUrl = elements.imageUrlInput.value.trim();
            const correctType = elements.correctTypeInput.value;

            if (!imageUrl) {
                return displayMessage('ç”»åƒURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
            }

            const newItem = {
                image_url: imageUrl,
                correct_type: correctType,
            };

            try {
                if (id) {
                    // æ›´æ–°
                    await setDoc(doc(db, COLLECTION_PATH, id), newItem);
                    displayMessage('å•é¡Œã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'success');
                } else {
                    // æ–°è¦ç™»éŒ²
                    await addDoc(collection(db, COLLECTION_PATH), newItem);
                    displayMessage('æ–°ã—ã„å•é¡Œã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚', 'success');
                }
                resetForm();
            } catch (error) {
                console.error("å•é¡Œã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
                displayMessage(`å•é¡Œã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }

        /**
         * å•é¡Œã‚’ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ­ãƒ¼ãƒ‰
         * @param {string} id - å•é¡ŒID
         */
        function editItem(id) {
            if (isConfigPlaceholder) {
                return displayMessage('ã€ã‚¨ãƒ©ãƒ¼ã€‘Firebaseè¨­å®šãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚', 'error');
            }
            if (!isAuthReady || !auth.currentUser) {
                return displayMessage('èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ç·¨é›†æ©Ÿèƒ½ã¯èªè¨¼å¾Œã«åˆ©ç”¨å¯èƒ½ã§ã™ã€‚', 'error');
            }
            
            const item = quizItems.find(i => i.id === id);
            if (item) {
                elements.itemIdToEdit.value = item.id;
                elements.imageUrlInput.value = item.image_url;
                elements.correctTypeInput.value = item.correct_type;
                elements.formTitle.textContent = 'å•é¡Œç·¨é›†';
                elements.saveItemBtn.textContent = 'æ›´æ–°';
                elements.cancelEditBtn.classList.remove('hidden');
                switchView('admin'); // ç·¨é›†ã®ãŸã‚ã«ç®¡ç†ç”»é¢ã«ç§»å‹•
            }
        }

        /**
         * å•é¡Œã‚’å‰Šé™¤
         * @param {string} id - å•é¡ŒID
         */
        async function deleteItem(id) {
            if (isConfigPlaceholder) {
                return displayMessage('ã€ã‚¨ãƒ©ãƒ¼ã€‘Firebaseè¨­å®šãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚', 'error');
            }
            if (!isAuthReady || !auth.currentUser) {
                 return displayMessage('èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚å‰Šé™¤æ©Ÿèƒ½ã¯èªè¨¼å¾Œã«åˆ©ç”¨å¯èƒ½ã§ã™ã€‚', 'error');
            }
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä»£ã‚ã‚Šã«ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨
            if (!window.confirm('æœ¬å½“ã«ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                await deleteDoc(doc(db, COLLECTION_PATH, id));
                displayMessage('å•é¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
            } catch (error) {
                console.error("å•é¡Œã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
                displayMessage(`å•é¡Œã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }

        /**
         * ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
         */
        function resetForm() {
            elements.itemIdToEdit.value = '';
            elements.imageUrlInput.value = '';
            elements.correctTypeInput.value = 'fire';
            elements.formTitle.textContent = 'æ–°è¦å•é¡Œç™»éŒ²';
            elements.saveItemBtn.textContent = 'ç™»éŒ²/æ›´æ–°';
            elements.cancelEditBtn.classList.add('hidden');
        }

        /**
         * ç®¡ç†ç”»é¢ã®å•é¡Œãƒªã‚¹ãƒˆã‚’æ›´æ–°
         * @param {Array<Object>} items - å•é¡Œãƒªã‚¹ãƒˆ
         */
        function updateAdminList(items) {
            const listTable = document.getElementById('item-list-container').querySelector('table');
            const listMessage = document.getElementById('list-loading-message');

            if (isAuthReady && !isConfigPlaceholder) {
                if (listMessage) listMessage.classList.add('hidden');
                if (listTable) listTable.classList.remove('hidden');
            } else if (isAuthReady && isConfigPlaceholder) {
                 if (listMessage) listMessage.textContent = 'ã€ã‚¨ãƒ©ãƒ¼ã€‘Firebaseè¨­å®šãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚';
                 if (listMessage) listMessage.classList.remove('hidden');
                 if (listTable) listTable.classList.add('hidden');
                 return;
            }


            elements.itemList.innerHTML = '';
            if (items.length === 0) {
                elements.itemList.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-500">å•é¡Œã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td></tr>`;
                return;
            }

            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-4 py-2 text-sm text-gray-500 font-mono text-xs break-all">${item.id.substring(0, 4)}...</td>
                    <td class="px-4 py-2 text-sm text-gray-900 font-mono text-xs break-all">${item.image_url}</td>
                    <td class="px-4 py-2 text-sm text-gray-900">${item.correct_type}</td>
                    <td class="px-4 py-2 text-sm font-medium space-x-2">
                        <button onclick="editItem('${item.id}')" class="text-indigo-600 hover:text-indigo-900">ç·¨é›†</button>
                        <button onclick="deleteItem('${item.id}')" class="text-red-600 hover:text-red-900">å‰Šé™¤</button>
                    </td>
                `;
                elements.itemList.appendChild(tr);
            });
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é–¢æ•°ã‚’å…¬é–‹ (HTML onclickã‹ã‚‰å‘¼ã³å‡ºã™ãŸã‚)
            window.editItem = editItem;
            window.deleteItem = deleteItem;
        }

        /**
         * CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€å•é¡Œã‚’ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
         */
        async function uploadCsv() {
            if (isConfigPlaceholder) {
                return displayMessage('ã€ã‚¨ãƒ©ãƒ¼ã€‘Firebaseè¨­å®šãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚', 'error');
            }
            if (!isAuthReady || !auth.currentUser) {
                return displayMessage('èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯èªè¨¼å¾Œã«åˆ©ç”¨å¯èƒ½ã§ã™ã€‚', 'error');
            }
            
            const file = elements.csvFileInput.files[0];
            if (!file) {
                return displayMessage('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
            }
            
            elements.uploadCsvBtn.disabled = true;
            elements.uploadCsvBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
            elements.uploadCsvBtn.classList.add('disabled-button');


            try {
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim() !== '');
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ— (image_url,correct_typeã‚’æƒ³å®š)
                const dataLines = lines.slice(1);
                const newItems = [];
                let errorCount = 0;

                dataLines.forEach((line, index) => {
                    const parts = line.split(',');
                    // CSVã®åŒºåˆ‡ã‚Šæ–‡å­—ãŒã‚«ãƒ³ãƒã§ã‚ã‚‹ã“ã¨ã‚’æƒ³å®š
                    if (parts.length < 2) {
                        console.warn(`CSVãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: è¡Œ ${index + 2} ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`);
                        errorCount++;
                        return;
                    }
                    
                    const imageUrl = parts[0].trim();
                    const correctType = parts[1].trim().toLowerCase(); // å¤§æ–‡å­—ãƒ»å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„
                    
                    if (imageUrl && ['fire', 'water', 'grass'].includes(correctType)) {
                        newItems.push({
                            image_url: imageUrl,
                            correct_type: correctType
                        });
                    } else {
                        console.warn(`CSVãƒ‡ãƒ¼ã‚¿ä¸æ­£: è¡Œ ${index + 2} (URL: ${imageUrl}, Type: ${correctType})`);
                        errorCount++;
                    }
                });

                if (newItems.length === 0) {
                    displayMessage('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«æœ‰åŠ¹ãªå•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
                    return;
                }
                
                // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‰Šé™¤ã—ã€æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
                await runTransaction(db, async (transaction) => {
                    // 1. æ—¢å­˜ã®å…¨ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’å–å¾— (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã§å–å¾—ã—ãŸquizItemsã‚’ä½¿ç”¨)
                    quizItems.forEach(item => {
                        const docRef = doc(db, COLLECTION_PATH, item.id);
                        transaction.delete(docRef);
                    });
                    
                    // 2. æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                    newItems.forEach(item => {
                        const newDocRef = doc(collection(db, COLLECTION_PATH)); // æ–°ã—ã„IDã‚’ç”Ÿæˆ
                        transaction.set(newDocRef, item);
                    });
                });

                displayMessage(`CSVã‹ã‚‰ ${newItems.length} ä»¶ã®å•é¡Œã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚${errorCount > 0 ? `(${errorCount}ä»¶ã®ä¸æ­£ãƒ‡ãƒ¼ã‚¿ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ)` : ''}`, 'success');

            } catch (error) {
                console.error("CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", error);
                displayMessage(`CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
            } finally {
                elements.uploadCsvBtn.disabled = false;
                elements.uploadCsvBtn.textContent = 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
                elements.uploadCsvBtn.classList.remove('disabled-button');
                elements.csvFileInput.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ã‚¯ãƒªã‚¢
            }
        }

        // =================================================================================
        // 4. ã‚¯ã‚¤ã‚ºãƒ­ã‚¸ãƒƒã‚¯
        // =================================================================================

        /**
         * é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ (Fisher-Yates)
         * @param {Array<Object>} array - ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹é…åˆ—
         * @returns {Array<Object>} ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚ŒãŸæ–°ã—ã„é…åˆ—
         */
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        /**
         * ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹
         */
        function startQuiz() {
            if (quizItems.length === 0) {
                return displayMessage('å•é¡ŒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†ç”»é¢ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚', 'error');
            }

            const numQuestions = parseInt(elements.numQuestionsInput.value, 10);
            if (isNaN(numQuestions) || numQuestions <= 0) {
                return displayMessage('æœ‰åŠ¹ãªå‡ºé¡Œæ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚', 'error');
            }

            // å‡ºé¡Œæ•°ã«åŸºã¥ã„ã¦å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
            const shuffledItems = shuffleArray(quizItems);
            currentQuiz = shuffledItems.slice(0, Math.min(numQuestions, quizItems.length));

            // çŠ¶æ…‹ã‚’åˆæœŸåŒ–
            currentQuestionIndex = 0;
            score = 0;

            // UIã‚’æ›´æ–°
            elements.quizSettings.classList.add('hidden');
            elements.resultArea.classList.add('hidden');
            elements.quizArea.classList.remove('hidden');
            elements.totalQuestionsSpan.textContent = currentQuiz.length;

            loadQuestion();
        }

        /**
         * æ¬¡ã®å•é¡Œã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
         */
        function loadQuestion() {
            if (currentQuestionIndex >= currentQuiz.length) {
                // ã‚¯ã‚¤ã‚ºçµ‚äº†
                showResult();
                return;
            }
            
            isQuestionActive = true;
            const currentItem = currentQuiz[currentQuestionIndex];

            // UIã‚’ãƒªã‚»ãƒƒãƒˆ
            elements.currentQuestionIndexSpan.textContent = currentQuestionIndex + 1;
            elements.questionImage.src = currentItem.image_url;
            elements.questionImage.classList.remove('hidden');
            elements.answerOverlay.classList.add('opacity-0');
            elements.answerOverlay.classList.remove('bg-green-600', 'bg-red-600');
            elements.answerText.textContent = '';
            elements.nextQuestionBtn.disabled = true;
            elements.nextQuestionBtn.classList.add('disabled-button');

            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã€ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            elements.choiceButtons.querySelectorAll('button').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('disabled-button', 'ring-4', 'ring-offset-2');
                // æ­£è§£/ä¸æ­£è§£ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                btn.style.opacity = '1';
                btn.style.transform = 'translateY(0)';
            });
        }

        /**
         * è§£ç­”ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
         * @param {string} selectedType - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸå±æ€§
         * @param {HTMLButtonElement} button - é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³è¦ç´ 
         */
        function checkAnswer(selectedType, button) {
            if (!isQuestionActive) return; // äºŒé‡å›ç­”é˜²æ­¢

            isQuestionActive = false;
            const currentItem = currentQuiz[currentQuestionIndex];
            const isCorrect = (selectedType === currentItem.correct_type);
            
            // ãƒœã‚¿ãƒ³ã‚’å…¨ã¦ç„¡åŠ¹åŒ–
            elements.choiceButtons.querySelectorAll('button').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('disabled-button');
                btn.style.opacity = '0.5';
            });
            
            // æ­£è§£ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const correctButton = elements.choiceButtons.querySelector(`[data-type="${currentItem.correct_type}"]`);
            correctButton.style.opacity = '1';
            correctButton.classList.add('ring-4', 'ring-offset-2', 'ring-green-500');

            if (isCorrect) {
                score++;
                elements.answerText.textContent = 'æ­£è§£ï¼ âœ…';
                elements.answerOverlay.classList.add('bg-green-600');
            } else {
                elements.answerText.textContent = 'ä¸æ­£è§£ âŒ';
                elements.answerOverlay.classList.add('bg-red-600');
                // é–“é•ã£ãŸé¸æŠè‚¢ã‚’èµ¤ããƒã‚¤ãƒ©ã‚¤ãƒˆ
                button.classList.add('ring-4', 'ring-offset-2', 'ring-red-500');
            }

            elements.answerOverlay.classList.remove('opacity-0');
            elements.nextQuestionBtn.disabled = false;
            elements.nextQuestionBtn.classList.remove('disabled-button');
        }

        /**
         * æ¬¡ã®å•é¡Œã«é€²ã‚€
         */
        function nextQuestion() {
            elements.answerOverlay.classList.add('opacity-0');
            elements.nextQuestionBtn.disabled = true;
            elements.nextQuestionBtn.classList.add('disabled-button');
            currentQuestionIndex++;
            loadQuestion();
        }

        /**
         * çµæœç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
         */
        function showResult() {
            elements.quizArea.classList.add('hidden');
            elements.resultArea.classList.remove('hidden');
            elements.finalScore.textContent = score;
            elements.maxScore.textContent = currentQuiz.length;
        }

        /**
         * ã‚¯ã‚¤ã‚ºè¨­å®šç”»é¢ã«æˆ»ã‚‹
         */
        function resetQuiz() {
            elements.quizArea.classList.add('hidden');
            elements.resultArea.classList.add('hidden');
            elements.quizSettings.classList.remove('hidden');
        }

        // =================================================================================
        // 5. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        // =================================================================================

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();

            // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('nav-quiz').addEventListener('click', () => switchView('quiz'));
            document.getElementById('nav-admin').addEventListener('click', () => switchView('admin'));

            // ã‚¯ã‚¤ã‚ºæ©Ÿèƒ½
            elements.startQuizBtn.addEventListener('click', startQuiz);
            elements.nextQuestionBtn.addEventListener('click', nextQuestion);
            elements.restartQuizBtn.addEventListener('click', resetQuiz);

            elements.choiceButtons.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.type) {
                    checkAnswer(e.target.dataset.type, e.target);
                }
            });

            // ç®¡ç†æ©Ÿèƒ½ (å•é¡ŒCRUD)
            elements.saveItemBtn.addEventListener('click', saveItem);
            elements.cancelEditBtn.addEventListener('click', resetForm);
            
            // ç®¡ç†æ©Ÿèƒ½ (CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
            elements.uploadCsvBtn.addEventListener('click', uploadCsv);
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        // window.editItem, window.deleteItem ã¯ updateAdminListå†…ã§è¨­å®šæ¸ˆã¿
    </script>
</body>
</html>
