<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¼ãƒ‰å±æ€§å½“ã¦ã‚¯ã‚¤ã‚º</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .screen {
            display: none;
            min-height: calc(100vh - 50px); /* ãƒ•ãƒƒã‚¿ãƒ¼ã‚’é™¤ãé«˜ã• */
            padding-bottom: 80px; /* ãƒ•ãƒƒã‚¿ãƒ¼ã¨ã®è¢«ã‚Šã‚’é¿ã‘ã‚‹ */
        }
        .screen.active {
            display: flex;
            flex-direction: column;
        }
        .card-image {
            width: 100%;
            max-width: 300px;
            height: auto;
            aspect-ratio: 2 / 3;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
        }
        .attribute-button {
            transition: all 0.2s;
            font-weight: bold;
            padding: 1.5rem 1rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .attribute-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .result-item:nth-child(even) {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="app-container" class="max-w-md mx-auto bg-white shadow-xl min-h-screen">

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="p-4 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
            <h1 class="text-2xl font-extrabold text-indigo-700">å±æ€§ã‚¯ã‚¤ã‚º</h1>
            <div id="header-buttons" class="space-x-2">
                <button id="back-to-index-btn" class="text-gray-500 hover:text-indigo-600 p-2 rounded-full transition duration-150">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </header>

        <!-- 1. ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ -->
        <div id="home-screen" class="screen active p-6 pt-10 gap-6">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">ã‚«ãƒ¼ãƒ‰å±æ€§å½“ã¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼</h2>

            <!-- ã‚¯ã‚¤ã‚ºè¨­å®š -->
            <div class="bg-indigo-50 p-6 rounded-xl shadow-inner">
                <label for="quiz-count" class="block text-lg font-medium text-indigo-700 mb-3">
                    å‡ºé¡Œæ•°ã‚’è¨­å®š
                </label>
                <input type="number" id="quiz-count" value="3" min="1" class="w-full text-center text-3xl p-3 border-2 border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-md">
                <p class="text-sm text-gray-500 mt-2 text-center">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å•é¡Œæ•°: <span id="total-questions">0</span>å•</p>
            </div>

            <!-- ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
            <button id="start-quiz-btn" class="w-full bg-indigo-600 text-white py-4 mt-6 text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆ (å…¨3å•)
            </button>
            <p id="loading-message" class="text-center text-sm text-gray-500 mt-2" style="display: none;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>


            <!-- ãŠçŸ¥ã‚‰ã›ã‚¨ãƒªã‚¢ -->
            <div class="mt-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-bullhorn text-amber-500 mr-2"></i> ğŸ“¢ ãŠçŸ¥ã‚‰ã› (æ–°ç€ã‚«ãƒ¼ãƒ‰æƒ…å ±)
                </h3 >
                <div id="news-container" class="bg-white border border-gray-200 rounded-xl shadow-md p-4 space-y-2">
                    <!-- æ–°ç€ã‚«ãƒ¼ãƒ‰æƒ…å ±ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                    <p class="text-gray-500 italic">æ–°ç€æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
            </div>

            <!-- ç®¡ç†è€…ç”»é¢ãƒœã‚¿ãƒ³ -->
            <button id="go-to-admin-btn" class="w-full mt-6 text-indigo-600 border border-indigo-200 py-3 rounded-xl hover:bg-indigo-50 transition duration-150">
                ç®¡ç†è€…ç”»é¢ã¸
            </button>
        </div>

        <!-- 2. å•é¡Œç”»é¢ -->
        <div id="quiz-screen" class="screen p-6 pt-10 gap-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-indigo-700">ç¬¬ <span id="current-q-num">1</span> å• / å…¨ <span id="total-q-num">3</span> å•</h2>
                <button id="abort-quiz-btn" class="text-sm text-gray-500 hover:text-red-500 transition duration-150">
                    <i class="fas fa-times mr-1"></i>ä¸­æ–­
                </button>
            </div>

            <!-- ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="card-display" class="bg-gray-100 p-4 rounded-xl shadow-lg flex-grow flex flex-col justify-center items-center">
                <img id="quiz-card-image" src="https://placehold.co/300x450/cccccc/333333?text=Loading..." alt="å‡ºé¡Œã‚«ãƒ¼ãƒ‰ç”»åƒ" class="card-image transition-opacity duration-300">
                <p id="card-name-text" class="text-xl font-semibold text-gray-700 mt-4 text-center">[ã‚«ãƒ¼ãƒ‰å]</p>
                <p id="card-series-text" class="text-sm text-gray-500 mt-1 text-center">[ã‚·ãƒªãƒ¼ã‚º]</p>
            </div>

            <!-- å›ç­”ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
            <div id="answer-buttons" class="mt-6 space-y-3">
                <button data-attr="èµ¤" class="attribute-button w-full bg-red-500 text-white hover:bg-red-600">
                    <i class="fas fa-fire mr-2"></i> èµ¤
                </button>
                <button data-attr="é’" class="attribute-button w-full bg-blue-500 text-white hover:bg-blue-600">
                    <i class="fas fa-water mr-2"></i> é’
                </button>
                <button data-attr="ç·‘" class="attribute-button w-full bg-green-500 text-white hover:bg-green-600">
                    <i class="fas fa-leaf mr-2"></i> ç·‘
                </button>
            </div>

            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="quiz-feedback" class="mt-4 text-center p-3 rounded-lg font-extrabold text-xl" style="display: none;">
                <!-- æ­£èª¤çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
            
        </div>

        <!-- 3. çµæœç”»é¢ -->
        <div id="result-screen" class="screen p-6 pt-10 gap-6">
            <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">ã‚¯ã‚¤ã‚ºçµæœ</h2>

            <!-- çµæœã‚µãƒãƒªãƒ¼ -->
            <div class="bg-white border-4 border-indigo-400 p-6 rounded-xl shadow-2xl text-center">
                <p class="text-xl font-semibold text-gray-600">ã‚¹ã‚³ã‚¢:</p>
                <p id="result-summary" class="text-4xl font-extrabold text-indigo-600 mt-2">
                    å…¨éƒ¨ã§0å•ä¸­0å•æ­£è§£ã§ã—ãŸã€‚
                </p>
            </div>

            <!-- ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ -->
            <button id="share-x-btn" class="w-full bg-black text-white py-3 mt-6 text-lg font-bold rounded-xl shadow-lg hover:bg-gray-800 transition duration-150 flex items-center justify-center">
                <i class="fab fa-twitter mr-2"></i> çµæœã‚’Xã«ã‚·ã‚§ã‚¢ï¼
            </button>

            <!-- å›ç­”å±¥æ­´ -->
            <h3 class="text-xl font-bold text-gray-700 mt-8 mb-4 border-b pb-2">å›ç­”å±¥æ­´</h3>
            <div id="history-container" class="space-y-2 border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                <!-- å›ç­”å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>

            <!-- ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
            <button id="back-to-home-from-result-btn" class="w-full mt-6 text-indigo-600 border border-indigo-200 py-3 rounded-xl hover:bg-indigo-50 transition duration-150">
                ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹
            </button>
        </div>

        <!-- 4. ç®¡ç†è€…ç”»é¢ (èªè¨¼) -->
        <div id="admin-auth-screen" class="screen p-6 pt-10 gap-6 justify-center items-center">
            <div class="w-full bg-white p-8 rounded-xl shadow-lg max-w-sm">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</h2>
                <input type="password" id="admin-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                <p id="auth-error-message" class="text-red-500 text-sm mt-2" style="display: none;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç•°ãªã‚Šã¾ã™ã€‚</p>
                <button id="admin-login-btn" class="w-full bg-indigo-600 text-white py-3 mt-6 text-lg font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150">
                    å…¥å®¤
                </button>
                <button id="back-to-home-from-auth-btn" class="w-full mt-4 text-gray-500 border border-gray-200 py-3 rounded-xl hover:bg-gray-50 transition duration-150">
                    ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹
                </button>
            </div>
        </div>

        <!-- 5. ç®¡ç†è€…ç”»é¢ (ãƒ¡ã‚¤ãƒ³) -->
        <div id="admin-screen" class="screen p-6 pt-10 gap-6">
            <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">ç®¡ç†è€…ãƒ‘ãƒãƒ«</h2>

            <div class="space-y-6">
                <!-- CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">CSVä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (è¿½åŠ )</h3>
                    <p class="text-sm text-gray-500 mb-3">å½¢å¼: ã‚­ãƒ£ãƒ©å,ã‚«ãƒ¼ãƒ‰å,ã‚·ãƒªãƒ¼ã‚º,å±æ€§(èµ¤|é’|ç·‘),ç”»åƒURL</p>
                    <input type="file" id="csv-file-input" accept=".csv" class="w-full mb-3 text-gray-700">
                    <button id="import-csv-btn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-150">
                        <i class="fas fa-file-import mr-2"></i> ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹
                    </button>
                    <p id="import-status" class="text-sm mt-2"></p>
                </div>

                <!-- CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
                    <button id="export-csv-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-150">
                        <i class="fas fa-download mr-2"></i> ç™»éŒ²æ¸ˆã¿ä¸€è¦§ã‚’CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                </div>

                <!-- æ–°è¦ã‚«ãƒ¼ãƒ‰ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="bg-indigo-50 p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-indigo-700 mb-4">æ–°è¦ã‚«ãƒ¼ãƒ‰ç™»éŒ² (å˜ä½“)</h3>
                    <form id="add-card-form" class="space-y-3">
                        <input type="text" id="add-char-name" placeholder="ã‚­ãƒ£ãƒ©å" required class="w-full p-2 border rounded-lg">
                        <input type="text" id="add-card-name" placeholder="ã‚«ãƒ¼ãƒ‰å" required class="w-full p-2 border rounded-lg">
                        <input type="text" id="add-series" placeholder="ã‚·ãƒªãƒ¼ã‚ºå" required class="w-full p-2 border rounded-lg">
                        <select id="add-attribute" required class="w-full p-2 border rounded-lg">
                            <option value="">å±æ€§ã‚’é¸æŠ</option>
                            <option value="èµ¤">èµ¤</option>
                            <option value="é’">é’</option>
                            <option value="ç·‘">ç·‘</option>
                        </select>
                        <input type="url" id="add-image-url" placeholder="ç”»åƒURL" required class="w-full p-2 border rounded-lg">
                        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition duration-150">
                            <i class="fas fa-plus-circle mr-2"></i> ç™»éŒ²
                        </button>
                        <p id="add-status" class="text-sm mt-2 text-center"></p>
                    </form>
                </div>

                <!-- ç™»éŒ²æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
                <h3 class="text-xl font-semibold text-gray-700 mt-8 mb-4 border-b pb-2">ç™»éŒ²æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ä¸€è¦§ (<span id="admin-card-count">0</span>ä»¶)</h3>
                <div id="card-list-container" class="space-y-3">
                    <!-- ã‚«ãƒ¼ãƒ‰ä¸€è¦§ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                </div>

                <button id="back-to-home-from-admin-btn" class="w-full mt-6 text-gray-500 border border-gray-200 py-3 rounded-xl hover:bg-gray-50 transition duration-150">
                    ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹
                </button>
            </div>
        </div>

        <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" style="display: none;">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-2xl font-bold mb-4">ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’ç·¨é›†</h3>
                <form id="edit-card-form" class="space-y-3">
                    <input type="hidden" id="edit-card-id">
                    <input type="text" id="edit-char-name" placeholder="ã‚­ãƒ£ãƒ©å" required class="w-full p-2 border rounded-lg">
                    <input type="text" id="edit-card-name" placeholder="ã‚«ãƒ¼ãƒ‰å" required class="w-full p-2 border rounded-lg">
                    <input type="text" id="edit-series" placeholder="ã‚·ãƒªãƒ¼ã‚ºå" required class="w-full p-2 border rounded-lg">
                    <select id="edit-attribute" required class="w-full p-2 border rounded-lg">
                        <option value="èµ¤">èµ¤</option>
                        <option value="é’">é’</option>
                        <option value="ç·‘">ç·‘</option>
                    </select>
                    <input type="url" id="edit-image-url" placeholder="ç”»åƒURL" required class="w-full p-2 border rounded-lg">

                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition duration-150">
                        <i class="fas fa-save mr-2"></i> ä¿å­˜
                    </button>
                    <button type="button" id="close-edit-modal-btn" class="w-full mt-2 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition duration-150">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </form>
            </div>
        </div>

    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="bg-gray-800 text-white text-center p-3 fixed bottom-0 w-full max-w-md mx-auto shadow-t-xl z-20">
        <p class="text-sm">é–‹ç™º: <a href="https://twitter.com/nek0n0tem0" target="_blank" class="hover:text-indigo-400 transition duration-150">x: @nek0n0tem0</a></p>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDocs, 
            setDoc, 
            addDoc, 
            deleteDoc, 
            query, 
            orderBy, 
            limit, 
            onSnapshot, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestoreã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š (ãƒ‡ãƒãƒƒã‚°ç”¨)
        setLogLevel('debug');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®å®šç¾©ã¨åˆæœŸåŒ–
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // __firebase_config ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ä½¿ç”¨ã™ã‚‹
        let firebaseConfig = {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®å„ªå…ˆè¨­å®š
            apiKey: "AIzaSyCF2mISZbPAAnajQKUsb6Bx-09skAkYaJs",
            authDomain: "ssrproject1208.firebaseapp.com",
            projectId: "ssrproject1208",
            storageBucket: "ssrproject1208.firebasestorage.app",
            messagingSenderId: "693929077122",
            appId: "1:693929077122:web:010621739e9ece7be1479b",
            measurementId: "G-XQB6ZWQ3NL"
        };
        
        // ğŸš¨ ä¿®æ­£ç‚¹: å¸¸ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰è¨­å®šã‚’å„ªå…ˆã™ã‚‹ãŸã‚ã€__firebase_configã®ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã€
        // Canvasç’°å¢ƒã§ã‚ã‚Œã°ã€__firebase_configã®ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã«å¤‰æ›´ã€‚
        // ã“ã‚Œã«ã‚ˆã‚Šã€Canvasç’°å¢ƒã§ã¯ Canvas ã®ãƒ‡ãƒ¼ã‚¿ãŒå„ªå…ˆã•ã‚Œã€Github Pagesã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒä½¿ã‚ã‚Œã‚‹ã€‚
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                // Canvasç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆã€Canvasæä¾›ã®Configã§ä¸Šæ›¸ã
                firebaseConfig = JSON.parse(__firebase_config);
                console.log("Using Canvas provided Firebase Config.");
            } else {
                console.log("Using User specified hardcoded Firebase Config.");
            }
        } catch (e) {
            console.error("Failed to process Firebase config:", e);
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Firestoreã®ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹
        const CARDS_COLLECTION_PATH = `/artifacts/${appId}/public/data/cards`;
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ç®¡ç†
        let allCards = [];
        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let quizHistory = [];
        let totalQuestionCount = 3;
        const ADMIN_PASSWORD = "252";

        // DOMè¦ç´ ã®å–å¾—
        const screens = {
            home: document.getElementById('home-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen'),
            adminAuth: document.getElementById('admin-auth-screen'),
            admin: document.getElementById('admin-screen')
        };
        const quizCountInput = document.getElementById('quiz-count');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const totalQuestionsSpan = document.getElementById('total-questions');
        const loadingMessage = document.getElementById('loading-message');
        const newsContainer = document.getElementById('news-container');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminPasswordInput = document.getElementById('admin-password');
        const authErrorMessage = document.getElementById('auth-error-message');
        const adminCardCountSpan = document.getElementById('admin-card-count');
        const cardListContainer = document.getElementById('card-list-container');
        const answerButtons = document.getElementById('answer-buttons');
        const quizFeedback = document.getElementById('quiz-feedback');
        const editModal = document.getElementById('edit-modal');
        const editCardForm = document.getElementById('edit-card-form');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');

        // ç”»é¢é·ç§»é–¢æ•°
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
            }
        }

        // --- FirebaseåˆæœŸåŒ–ã¨èªè¨¼ ---
        async function initializeFirebase() {
            // firebaseConfig ãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰åˆæœŸåŒ–
            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase config is empty. Cannot initialize.");
                 return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth successful. User ID:", userId);
                    } else {
                        // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯åŒ¿åèªè¨¼ã‚’è©¦ã¿ã‚‹
                        if (!initialAuthToken) {
                            await signInAnonymously(auth);
                        }
                    }
                    isAuthReady = true;
                    // èªè¨¼å®Œäº†å¾Œã€Firestoreã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                    if (db) {
                        setupFirestoreListeners();
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
            }
        }

        // --- Firestoreãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
        function setupFirestoreListeners() {
            if (!isAuthReady || !db) return;

            const cardsRef = collection(db, CARDS_COLLECTION_PATH);

            // 1. å…¨ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ (ç®¡ç†è€…ç”»é¢ç”¨)
            onSnapshot(cardsRef, (snapshot) => {
                allCards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // ç™»éŒ²æ—¥é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„ã‚‚ã®ãŒä¸Šï¼‰
                // orderByã‚’ä½¿ã‚ãšJavaScriptã§ã‚½ãƒ¼ãƒˆ
                allCards.sort((a, b) => {
                    const timeA = b.createdAt?.toDate()?.getTime() || 0;
                    const timeB = a.createdAt?.toDate()?.getTime() || 0;
                    return timeA - timeB;
                });

                updateHomeUI();
                renderAdminCardList();
                
            }, (error) => {
                // æ¨©é™ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã—ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§é€šçŸ¥ã™ã‚‹
                console.error("Error listening to cards collection:", error);
                if (error.code === "permission-denied") {
                     console.error("Firestore Permissions Error: 'cards'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®èª­ã¿å–ã‚Šæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Firebase Security Rulesã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                     showCustomMessage(
                         'æ¨©é™ã‚¨ãƒ©ãƒ¼', 
                         'ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã®æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\nFirebase Security Rulesã®è¨­å®šï¼ˆç‰¹ã« public/data/cards ã¸ã® read æ¨©é™ï¼‰ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 
                         true
                     );
                }
            });
        }

        // --- UIæ›´æ–°é–¢æ•° ---

        // ãƒ›ãƒ¼ãƒ ç”»é¢ã®UIæ›´æ–° (å…¨å•é¡Œæ•°ã€ãŠçŸ¥ã‚‰ã›)
        function updateHomeUI() {
            totalQuestionsSpan.textContent = allCards.length;
            const currentCount = parseInt(quizCountInput.value, 10);
            const displayCount = Math.min(currentCount, allCards.length);
            startQuizBtn.textContent = `ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆ (å…¨${displayCount}å•)`;
            startQuizBtn.disabled = allCards.length === 0;

            // æ–°ç€æƒ…å ± (æœ€æ–°3ä»¶)
            renderNews(allCards.slice(0, 3));
        }

        function renderNews(newCards) {
            newsContainer.innerHTML = '';
            if (newCards.length === 0) {
                newsContainer.innerHTML = '<p class="text-gray-500 italic">æ–°ç€æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            newCards.forEach(card => {
                const date = card.createdAt?.toDate() ? card.createdAt.toDate().toLocaleDateString('ja-JP') : 'æ—¥ä»˜ä¸æ˜';
                const div = document.createElement('div');
                div.className = 'p-2 bg-white rounded-lg border border-gray-100 shadow-sm';
                div.innerHTML = `
                    <p class="text-xs text-indigo-500">${date}</p>
                    <p class="text-sm text-gray-800 font-medium">${card.cardName} (${card.series})</p>
                `;
                newsContainer.appendChild(div);
            });
        }

        // ç®¡ç†è€…ç”»é¢ã®ã‚«ãƒ¼ãƒ‰ä¸€è¦§æç”»
        function renderAdminCardList() {
            adminCardCountSpan.textContent = allCards.length;
            cardListContainer.innerHTML = '';

            if (allCards.length === 0) {
                cardListContainer.innerHTML = '<p class="text-gray-500 text-center italic mt-4">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            allCards.forEach(card => {
                const div = document.createElement('div');
                div.className = 'bg-white p-3 rounded-xl shadow-md border border-gray-100 flex items-center space-x-4';
                
                div.innerHTML = `
                    <img src="${card.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/60x90/cccccc/333333?text=No+Image';" alt="${card.cardName}" class="w-12 h-18 object-cover rounded-md shadow">
                    <div class="flex-grow">
                        <p class="text-sm font-bold text-gray-800">${card.cardName} (${card.attribute})</p>
                        <p class="text-xs text-gray-600">${card.series} / ${card.name}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button data-id="${card.id}" class="edit-btn text-blue-500 hover:text-blue-700 p-2 transition duration-150 rounded-full">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button data-id="${card.id}" class="delete-btn text-red-500 hover:text-red-700 p-2 transition duration-150 rounded-full">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                cardListContainer.appendChild(div);
            });
        }

        // --- ã‚¯ã‚¤ã‚ºæ©Ÿèƒ½ ---

        // é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ã‚¯ã‚¤ã‚ºé–‹å§‹
        async function startQuiz() {
            if (!isAuthReady) {
                showCustomMessage('æº–å‚™ä¸­', 'èªè¨¼æº–å‚™ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
                return;
            }

            loadingMessage.style.display = 'block';
            startQuizBtn.disabled = true;

            const count = parseInt(quizCountInput.value, 10);
            totalQuestionCount = Math.min(count, allCards.length);

            if (totalQuestionCount === 0) {
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º: å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“
                showCustomMessage('ã‚¨ãƒ©ãƒ¼', 'ã‚¯ã‚¤ã‚ºã®å•é¡ŒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ç”»é¢ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
                loadingMessage.style.display = 'none';
                startQuizBtn.disabled = false;
                return;
            }

            // å…¨ã‚«ãƒ¼ãƒ‰ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã€æŒ‡å®šã•ã‚ŒãŸå•é¡Œæ•°åˆ†ã ã‘é¸æŠ
            currentQuiz = shuffle([...allCards]).slice(0, totalQuestionCount);
            currentQuestionIndex = 0;
            quizHistory = [];
            
            showScreen('quiz');
            loadQuestion(currentQuestionIndex);

            loadingMessage.style.display = 'none';
            startQuizBtn.disabled = false;
        }

        // å•é¡Œã®èª­ã¿è¾¼ã¿ã¨è¡¨ç¤º
        function loadQuestion(index) {
            const card = currentQuiz[index];
            if (!card) return;

            document.getElementById('current-q-num').textContent = index + 1;
            document.getElementById('total-q-num').textContent = totalQuestionCount;
            
            const imageEl = document.getElementById('quiz-card-image');
            imageEl.style.opacity = '0'; // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
            
            setTimeout(() => {
                imageEl.src = card.imageUrl;
                imageEl.onerror = () => {
                    imageEl.src = 'https://placehold.co/300x450/cccccc/333333?text=No+Image'; // ç”»åƒã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                };
                document.getElementById('card-name-text').textContent = card.cardName;
                document.getElementById('card-series-text').textContent = card.series;
                
                // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                document.querySelectorAll('#answer-buttons button').forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('ring-4', 'ring-green-400', 'ring-red-400', 'opacity-70');
                });
                quizFeedback.style.display = 'none';
                imageEl.style.opacity = '1'; // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
            }, 300); // 300mså¾Œã«ç”»åƒã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        }

        // å›ç­”å‡¦ç†
        function handleAnswer(selectedAttr) {
            const card = currentQuiz[currentQuestionIndex];
            if (!card) return;

            const isCorrect = selectedAttr === card.attribute;
            const feedbackText = isCorrect ? 'æ­£è§£ï¼' : `ä¸æ­£è§£ï¼ æ­£è§£ã¯ã€Œ${card.attribute}ã€ã§ã—ãŸã€‚`;
            const feedbackColor = isCorrect ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
            quizFeedback.textContent = feedbackText;
            quizFeedback.className = `mt-4 text-center p-3 rounded-lg font-extrabold text-xl ${feedbackColor}`;
            quizFeedback.style.display = 'block';

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã€æ­£è§£ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll('#answer-buttons button').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-70');
                if (btn.dataset.attr === card.attribute) {
                    btn.classList.add('ring-4', 'ring-green-400');
                } else if (!isCorrect && btn.dataset.attr === selectedAttr) {
                    btn.classList.add('ring-4', 'ring-red-400');
                }
            });

            // å±¥æ­´ã«è¿½åŠ 
            quizHistory.push({
                question: card,
                userAnswer: selectedAttr,
                isCorrect: isCorrect
            });

            // æ¬¡ã®å•é¡Œã¸
            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < totalQuestionCount) {
                    loadQuestion(currentQuestionIndex);
                } else {
                    showResults();
                }
            }, 1500); // 1.5ç§’å¾Œã«æ¬¡ã¸
        }

        // çµæœç”»é¢è¡¨ç¤º
        function showResults() {
            const correctCount = quizHistory.filter(h => h.isCorrect).length;
            
            document.getElementById('result-summary').textContent = 
                `å…¨éƒ¨ã§${totalQuestionCount}å•ä¸­${correctCount}å•æ­£è§£ã§ã—ãŸã€‚`;

            // å›ç­”å±¥æ­´ã®æç”»
            const historyContainer = document.getElementById('history-container');
            historyContainer.innerHTML = '';
            
            quizHistory.forEach((h, index) => {
                const resultClass = h.isCorrect ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
                const icon = h.isCorrect ? '<i class="fas fa-check-circle mr-2"></i>' : '<i class="fas fa-times-circle mr-2"></i>';

                const div = document.createElement('div');
                div.className = `result-item p-3 border-b border-gray-100 flex justify-between items-center ${resultClass}`;
                div.innerHTML = `
                    <div class="flex items-center">
                        ${icon}
                        <span class="font-medium">${index + 1}. ${h.question.cardName}</span>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold">${h.isCorrect ? 'æ­£è§£' : 'ä¸æ­£è§£'}</p>
                        <p class="text-xs text-gray-500">ã‚ãªãŸã®ç­”ãˆ: ${h.userAnswer}</p>
                        ${!h.isCorrect ? `<p class="text-xs text-red-400">æ­£è§£: ${h.question.attribute}</p>` : ''}
                    </div>
                `;
                historyContainer.appendChild(div);
            });

            // Xã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã®è¨­å®š
            const correctText = correctCount === totalQuestionCount ? 'å…¨å•æ­£è§£ï¼ğŸ‰' : `${correctCount}å•æ­£è§£ï¼`;
            const shareText = `å±æ€§ã‚¯ã‚¤ã‚ºã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼\nå…¨éƒ¨ã§${totalQuestionCount}å•ä¸­${correctText}\nã‚ãªãŸã‚‚æŒ‘æˆ¦ã—ã¦ã¿ã‚ˆã†ï¼`;
            const shareUrl = `https://nek0-tkdb.github.io/tools/quiz_attr.html`;
            document.getElementById('share-x-btn').onclick = () => {
                const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}&hashtags=ã‚«ãƒ¼ãƒ‰å±æ€§ã‚¯ã‚¤ã‚º`;
                window.open(url, '_blank');
            };

            showScreen('result');
        }

        // --- ç®¡ç†è€…æ©Ÿèƒ½ (CRUD & Import/Export) ---

        // å˜ä½“ç™»éŒ²
        document.getElementById('add-card-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const statusEl = document.getElementById('add-status');
            statusEl.textContent = 'ç™»éŒ²ä¸­...';
            statusEl.className = 'text-sm mt-2 text-center text-blue-500';

            const newCard = {
                name: document.getElementById('add-char-name').value.trim(),
                cardName: document.getElementById('add-card-name').value.trim(),
                series: document.getElementById('add-series').value.trim(),
                attribute: document.getElementById('add-attribute').value,
                imageUrl: document.getElementById('add-image-url').value.trim(),
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, CARDS_COLLECTION_PATH), newCard);
                statusEl.textContent = 'ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼';
                statusEl.className = 'text-sm mt-2 text-center text-green-500';
                e.target.reset();
            } catch (error) {
                console.error("Error adding document:", error);
                statusEl.textContent = 'ç™»éŒ²ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                statusEl.className = 'text-sm mt-2 text-center text-red-500';
                // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                if (error.code === "permission-denied") {
                    showCustomMessage(
                        'æ¨©é™ã‚¨ãƒ©ãƒ¼', 
                        'ç®¡ç†è€…ã¨ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã™ã‚‹ãŸã‚ã®æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nFirebase Security Rulesã® `write` æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 
                        true
                    );
                }
            }
        });

        // ç·¨é›†ä¿å­˜
        editCardForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const cardId = document.getElementById('edit-card-id').value;
            const updatedCard = {
                name: document.getElementById('edit-char-name').value.trim(),
                cardName: document.getElementById('edit-card-name').value.trim(),
                series: document.getElementById('edit-series').value.trim(),
                attribute: document.getElementById('edit-attribute').value,
                imageUrl: document.getElementById('edit-image-url').value.trim(),
                // createdAtã¯ç¶­æŒã•ã‚Œã‚‹
            };

            try {
                await setDoc(doc(db, CARDS_COLLECTION_PATH, cardId), updatedCard, { merge: true });
                showCustomMessage('æˆåŠŸ', 'ã‚«ãƒ¼ãƒ‰æƒ…å ±ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚');
                editModal.style.display = 'none';
            } catch (error) {
                console.error("Error updating document:", error);
                showCustomMessage('ã‚¨ãƒ©ãƒ¼', 'ã‚«ãƒ¼ãƒ‰æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true);
                // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                if (error.code === "permission-denied") {
                    showCustomMessage(
                        'æ¨©é™ã‚¨ãƒ©ãƒ¼', 
                        'ç®¡ç†è€…ã¨ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã®æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nFirebase Security Rulesã® `write` æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 
                        true
                    );
                }
            }
        });

        // ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²
        cardListContainer.addEventListener('click', (e) => {
            const id = e.target.closest('button')?.dataset.id;
            if (!id) return;

            if (e.target.closest('.edit-btn')) {
                const card = allCards.find(c => c.id === id);
                if (card) {
                    document.getElementById('edit-card-id').value = card.id;
                    document.getElementById('edit-char-name').value = card.name;
                    document.getElementById('edit-card-name').value = card.cardName;
                    document.getElementById('edit-series').value = card.series;
                    document.getElementById('edit-attribute').value = card.attribute;
                    document.getElementById('edit-image-url').value = card.imageUrl;
                    editModal.style.display = 'flex';
                }
            } else if (e.target.closest('.delete-btn')) {
                showConfirmModal('ç¢ºèª', 'ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', () => deleteCard(id));
            }
        });

        // ã‚«ãƒ¼ãƒ‰å‰Šé™¤
        async function deleteCard(id) {
            try {
                await deleteDoc(doc(db, CARDS_COLLECTION_PATH, id));
                showCustomMessage('æˆåŠŸ', 'ã‚«ãƒ¼ãƒ‰ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
            } catch (error) {
                console.error("Error deleting document:", error);
                showCustomMessage('ã‚¨ãƒ©ãƒ¼', 'ã‚«ãƒ¼ãƒ‰ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true);
                // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                if (error.code === "permission-denied") {
                    showCustomMessage(
                        'æ¨©é™ã‚¨ãƒ©ãƒ¼', 
                        'ç®¡ç†è€…ã¨ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã®æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nFirebase Security Rulesã® `write` æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 
                        true
                    );
                }
            }
        });

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        document.getElementById('import-csv-btn').addEventListener('click', () => {
            const fileInput = document.getElementById('csv-file-input');
            const file = fileInput.files[0];
            const statusEl = document.getElementById('import-status');
            
            if (!file) {
                statusEl.textContent = 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
                statusEl.className = 'text-sm mt-2 text-red-500';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.trim().split('\n').filter(line => line.trim() !== '');
                
                if (lines.length === 0) {
                    statusEl.textContent = 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                    statusEl.className = 'text-sm mt-2 text-red-500';
                    return;
                }

                statusEl.textContent = `0 / ${lines.length} ä»¶ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...`;
                statusEl.className = 'text-sm mt-2 text-blue-500';

                const batchSize = 500; // ãƒãƒƒãƒå‡¦ç†ã®ã‚µã‚¤ã‚º
                const errors = [];
                let importedCount = 0;

                try {
                    for (let i = 0; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        
                        // å½¢å¼: ã‚­ãƒ£ãƒ©å,ã‚«ãƒ¼ãƒ‰å,ã‚·ãƒªãƒ¼ã‚º,å±æ€§(èµ¤|é’|ç·‘),ç”»åƒURL
                        if (values.length !== 5) {
                            errors.push(`è¡Œ ${i + 1}: åˆ—æ•°ãŒä¸æ­£ã§ã™ (${values.length}åˆ—)`);
                            continue;
                        }

                        const [name, cardName, series, attribute, imageUrl] = values;

                        if (!['èµ¤', 'é’', 'ç·‘'].includes(attribute)) {
                            errors.push(`è¡Œ ${i + 1}: å±æ€§å€¤ãŒä¸æ­£ã§ã™ ("${attribute}")`);
                            continue;
                        }

                        const newCard = {
                            name,
                            cardName,
                            series,
                            attribute,
                            imageUrl,
                            createdAt: serverTimestamp()
                        };

                        // Firestoreã®æ›¸ãè¾¼ã¿
                        await addDoc(collection(db, CARDS_COLLECTION_PATH), newCard);
                        importedCount++;
                        statusEl.textContent = `${importedCount} / ${lines.length} ä»¶ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...`;
                    }
                    
                    if (errors.length > 0) {
                        statusEl.textContent = `ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ã€‚${importedCount}ä»¶æˆåŠŸã€${errors.length}ä»¶ã‚¨ãƒ©ãƒ¼ã€‚`;
                        statusEl.className = 'text-sm mt-2 text-orange-500';
                        console.error("CSV Import Errors:", errors);
                        showCustomMessage('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼ˆä¸€éƒ¨ã‚¨ãƒ©ãƒ¼ã‚ã‚Šï¼‰', `æˆåŠŸ: ${importedCount}ä»¶\nã‚¨ãƒ©ãƒ¼: ${errors.length}ä»¶ã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                    } else {
                        statusEl.textContent = `${importedCount}ä»¶ã®ã‚«ãƒ¼ãƒ‰ã‚’æ­£å¸¸ã«è¿½åŠ ã—ã¾ã—ãŸï¼`;
                        statusEl.className = 'text-sm mt-2 text-green-500';
                        showCustomMessage('æˆåŠŸ', `${importedCount}ä»¶ã®ã‚«ãƒ¼ãƒ‰ã‚’æ­£å¸¸ã«è¿½åŠ ã—ã¾ã—ãŸï¼`);
                    }

                } catch (error) {
                    console.error("Batch import error:", error);
                    statusEl.textContent = `è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                    statusEl.className = 'text-sm mt-2 text-red-500';
                     // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                    if (error.code === "permission-denied") {
                        showCustomMessage(
                            'æ¨©é™ã‚¨ãƒ©ãƒ¼', 
                            'ç®¡ç†è€…ã¨ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’ä¸€æ‹¬ç™»éŒ²ã™ã‚‹ãŸã‚ã®æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nFirebase Security Rulesã® `write` æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 
                            true
                        );
                    }
                }
            };
            reader.readAsText(file);
        });

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        document.getElementById('export-csv-btn').addEventListener('click', () => {
            if (allCards.length === 0) {
                showCustomMessage('æƒ…å ±', 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const header = "ã‚­ãƒ£ãƒ©å,ã‚«ãƒ¼ãƒ‰å,ã‚·ãƒªãƒ¼ã‚º,å±æ€§,ç”»åƒURL,ç™»éŒ²æ—¥æ™‚\n";
            const csvContent = allCards.map(card => {
                const date = card.createdAt?.toDate() ? card.createdAt.toDate().toISOString() : '';
                return `"${card.name}", "${card.cardName}", "${card.series}", "${card.attribute}", "${card.imageUrl}", "${date}"`;
            }).join('\n');

            const csvData = header + csvContent;
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `card_data_export_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showCustomMessage('æˆåŠŸ', 'ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚');
        });

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
        
        // ã‚¯ã‚¤ã‚ºå‡ºé¡Œæ•°å¤‰æ›´
        quizCountInput.addEventListener('input', () => {
            const count = parseInt(quizCountInput.value, 10);
            const validCount = Math.max(1, isNaN(count) ? 3 : count);
            quizCountInput.value = validCount;
            const displayCount = Math.min(validCount, allCards.length);
            startQuizBtn.textContent = `ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆ (å…¨${displayCount}å•)`;
        });

        // ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆ
        startQuizBtn.addEventListener('click', startQuiz);

        // ã‚¯ã‚¤ã‚ºä¸­æ–­
        document.getElementById('abort-quiz-btn').addEventListener('click', () => {
            showConfirmModal('ä¸­æ–­ç¢ºèª', 'ã‚¯ã‚¤ã‚ºã‚’ä¸­æ–­ã—ã¦ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ', () => {
                showScreen('home');
            });
        });

        // çµæœç”»é¢ã‹ã‚‰ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹
        document.getElementById('back-to-home-from-result-btn').addEventListener('click', () => {
            showScreen('home');
        });

        // å±æ€§ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã‚’å§”è­²
        answerButtons.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (btn && btn.dataset.attr) {
                handleAnswer(btn.dataset.attr);
            }
        });

        // ç®¡ç†è€…ç”»é¢ã¸ã®é·ç§»ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ï¼‰
        document.getElementById('go-to-admin-btn').addEventListener('click', () => {
            showScreen('adminAuth');
            adminPasswordInput.value = '';
            authErrorMessage.style.display = 'none';
        });

        // ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
        adminLoginBtn.addEventListener('click', () => {
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                authErrorMessage.style.display = 'none';
                showScreen('admin');
            } else {
                authErrorMessage.style.display = 'block';
                adminPasswordInput.value = '';
            }
        });

        // ç®¡ç†è€…ç”»é¢ãƒ»èªè¨¼ç”»é¢ã‹ã‚‰ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹
        document.getElementById('back-to-home-from-admin-btn').addEventListener('click', () => showScreen('home'));
        document.getElementById('back-to-home-from-auth-btn').addEventListener('click', () => showScreen('home'));
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closeEditModalBtn.addEventListener('click', () => {
            editModal.style.display = 'none';
        });

        // å‰ã®ç”»é¢ï¼ˆindex.htmlï¼‰ã«é·ç§»
        document.getElementById('back-to-index-btn').addEventListener('click', () => {
             // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã«åŸºã¥ãã€æŒ‡å®šã•ã‚ŒãŸãƒ‘ã‚¹ã«é·ç§»
            window.location.href = 'index.html';
        });

        // --- ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆ/ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•° (alert/confirmã®ä»£æ›¿) ---

        /**
         * ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆä»£æ›¿ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹
         * @param {string} title - ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«
         * @param {string} message - ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         */
        function showCustomMessage(title, message, isError = false) {
            const modalId = 'custom-message-modal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs transform scale-95 transition-transform duration-300">
                        <h3 id="custom-message-title" class="text-xl font-bold mb-4 text-gray-800"></h3>
                        <p id="custom-message-text" class="mb-6 text-gray-600 whitespace-pre-wrap"></p>
                        <button id="custom-message-close-btn" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-150">é–‰ã˜ã‚‹</button>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('custom-message-close-btn').addEventListener('click', () => {
                    modal.classList.add('opacity-0');
                    setTimeout(() => modal.style.display = 'none', 300);
                });
            }

            document.getElementById('custom-message-title').textContent = title;
            document.getElementById('custom-message-text').textContent = message;
            
            const titleEl = document.getElementById('custom-message-title');
            titleEl.className = `text-xl font-bold mb-4 ${isError ? 'text-red-600' : 'text-gray-800'}`;

            modal.style.display = 'flex';
            modal.classList.remove('opacity-0');
            modal.querySelector('div').classList.remove('scale-95');
            modal.querySelector('div').classList.add('scale-100');
        }

        /**
         * ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªï¼ˆconfirmä»£æ›¿ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹
         * @param {string} title - ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«
         * @param {string} message - ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         * @param {Function} onConfirm - ã€Œã¯ã„ã€ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
         */
        function showConfirmModal(title, message, onConfirm) {
            const modalId = 'custom-confirm-modal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs transform scale-95 transition-transform duration-300">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">${title}</h3>
                        <p id="confirm-message-text" class="mb-6 text-gray-600"></p>
                        <div class="flex space-x-3">
                            <button id="confirm-cancel-btn" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-150">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button id="confirm-ok-btn" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition duration-150">ã¯ã„</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('confirm-message-text').textContent = message;

            const closeModal = () => {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.style.display = 'none', 300);
            };

            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');

            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            newOkBtn.addEventListener('click', () => {
                onConfirm();
                closeModal();
            });
            newCancelBtn.addEventListener('click', closeModal);


            modal.style.display = 'flex';
            modal.classList.remove('opacity-0');
            modal.querySelector('div').classList.remove('scale-95');
            modal.querySelector('div').classList.add('scale-100');
        }

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹ ---
        initializeFirebase();

    </script>
</body>
</html>
