<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁîªÂÉèÂ±ûÊÄß3Êäû„ÇØ„Ç§„Ç∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding-bottom: 30px;
            min-height: 100vh;
        }
        .app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            text-align: center;
            padding: 5px;
            font-size: 10px;
            color: #6b7280;
            background-color: #e5e7eb;
            z-index: 999;
        }
        img {
            pointer-events: none;
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
    <script type="module">
        // Âè≥„ÇØ„É™„ÉÉ„ÇØ„Éª„Éâ„É©„ÉÉ„Ç∞Á¶ÅÊ≠¢
        document.addEventListener('contextmenu', e => e.target.tagName === 'IMG' && e.preventDefault());
        document.addEventListener('dragstart', e => e.target.tagName === 'IMG' && e.preventDefault());

        const CSV_FILE_PATH = 'quiz_data.csv';
        const SHARE_URL = window.location.href;

        window.QuizApp = {
            questions: [],
            selectedCharacters: [],
            currentScreen: 'home',
            quizSettings: { totalQuestions: 10 },
            currentQuiz: {
                active: false,
                currentQuestionIndex: 0,
                score: 0,
                quizQuestions: [],
                answerHistory: []
            },
            ATTRIBUTES: {
                fire: { name: 'Ëµ§', color: 'bg-red-500 hover:bg-red-600 border-red-700' },
                water: { name: 'Èùí', color: 'bg-blue-500 hover:bg-blue-600 border-blue-700' },
                grass: { name: 'Á∑ë', color: 'bg-green-500 hover:bg-green-600 border-green-700' }
            },
            ATTRIBUTE_MAP: { 'Ëµ§': 'fire', 'Èùí': 'water', 'Á∑ë': 'grass' },

            async init() {
                this.loadSettings();
                await this.loadCsvData();
                this.renderApp();
            },

            loadSettings() {
                const stored = localStorage.getItem('quizSettings');
                if (stored) this.quizSettings = JSON.parse(stored);
            },

            async loadCsvData() {
                try {
                    // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂõûÈÅø„Åô„Çã„Åü„ÇÅ„Å´„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Çí‰ªò‰∏é
                    const response = await fetch(`${CSV_FILE_PATH}?t=${Date.now()}`);
                    if (!response.ok) throw new Error('CSV„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    const text = await response.text();
                    this.questions = this.parseCsv(text);
                } catch (error) {
                    console.error("Data load failed:", error);
                    this.showMessage("„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇquiz_data.csv„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", 'error');
                }
            },

            parseCsv(text) {
                // ÊîπË°å„ÅßÂàÜÂâ≤„Åó„ÄÅÁ©∫Ë°å„ÇíÈô§Âéª
                const lines = text.trim().split(/\r?\n/).filter(line => line.trim() !== '');
                
                // 1Ë°åÁõÆ(„Éò„ÉÉ„ÉÄ„Éº)„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶Ëß£Êûê
                return lines.slice(1).map((line, index) => {
                    const parts = line.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
                    if (parts.length < 5) return null;
                    
                    return {
                        id: `csv-${index}`,
                        charName: parts[0],
                        cardName: parts[1],
                        series: parts[2],
                        correctAttribute: this.ATTRIBUTE_MAP[parts[3]] || 'fire',
                        imageUrl: parts[4]
                    };
                }).filter(q => q !== null);
            },

            setScreen(screen) {
                this.currentScreen = screen;
                this.renderApp();
            },

            showMessage(text, type = 'info') {
                const alertDiv = document.getElementById('message-alert');
                if (!alertDiv) return;
                alertDiv.textContent = text;
                alertDiv.className = `p-3 mb-4 rounded-xl text-white font-bold transition-opacity duration-300 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} opacity-100 fixed top-0 left-1/2 -translate-x-1/2 mt-4 z-50 text-sm sm:text-base`;
                setTimeout(() => alertDiv.classList.add('opacity-0'), 3000);
            },

            startQuiz() {
                let available = [...this.questions];
                if (this.selectedCharacters.length > 0) {
                    available = available.filter(q => this.selectedCharacters.includes(q.charName));
                }
                if (available.length === 0) {
                    this.showMessage("Âá∫È°åÂèØËÉΩ„Å™ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ", 'error');
                    return;
                }
                
                const shuffled = available.sort(() => Math.random() - 0.5);
                const count = Math.min(this.quizSettings.totalQuestions, shuffled.length);
                
                this.currentQuiz = {
                    active: true,
                    currentQuestionIndex: 0,
                    score: 0,
                    quizQuestions: shuffled.slice(0, count),
                    answerHistory: []
                };
                this.setScreen('quiz');
            },

            submitAnswer(selected) {
                const quiz = this.currentQuiz;
                if (!quiz.active) return;
                
                const currentQ = quiz.quizQuestions[quiz.currentQuestionIndex];
                const isCorrect = currentQ.correctAttribute === selected;
                
                quiz.answerHistory.push({ question: currentQ, selected, correct: isCorrect });
                
                if (isCorrect) {
                    quiz.score++;
                    this.showMessage("Ê≠£Ëß£ÔºÅ", 'success');
                } else {
                    this.showMessage(`ÊÆãÂøµÔºÅÊ≠£Ëß£„ÅØ ${this.ATTRIBUTES[currentQ.correctAttribute].name}`, 'error');
                }

                setTimeout(() => {
                    quiz.currentQuestionIndex++;
                    if (quiz.currentQuestionIndex >= quiz.quizQuestions.length) {
                        quiz.active = false;
                        this.setScreen('results');
                    } else {
                        this.renderApp();
                    }
                }, 1000);
            },

            renderApp() {
                const container = document.getElementById('app-container');
                let content = '';
                switch (this.currentScreen) {
                    case 'home': content = this.renderHome(); break;
                    case 'quiz': content = this.renderQuiz(); break;
                    case 'cardList': content = this.renderCardList(); break;
                    case 'charSelect': content = this.renderCharSelect(); break;
                    case 'results': content = this.renderResults(); break;
                }
                container.innerHTML = `<div class="max-w-4xl mx-auto w-full p-4 sm:p-8">${content}</div>`;
                this.attachEvents();
            },

            renderHome() {
                const qCount = this.questions.length;
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6 sm:p-10 text-center">
                        <h1 class="text-3xl font-extrabold text-gray-900 mb-8">Â±ûÊÄßÂΩì„Å¶„ÇØ„Ç§„Ç∫</h1>
                        <div class="mb-6 space-y-4">
                            <div class="flex items-center justify-center gap-4 bg-gray-50 p-4 rounded-xl border">
                                <label class="text-sm font-medium">Âá∫È°åÊï∞:</label>
                                <input type="number" id="total-q-input" value="${this.quizSettings.totalQuestions}" min="1" max="${qCount}" class="w-20 p-2 border rounded-lg text-center font-bold">
                                <button id="save-settings-btn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm hover:bg-indigo-600">‰øùÂ≠ò</button>
                            </div>
                            <button id="nav-char-select-btn" class="w-full py-4 border-2 rounded-xl hover:bg-gray-50 transition font-medium text-gray-700">
                                üéØ Âá∫È°å„Ç≠„É£„É©„ÇíÈÅ∏Êäû (${this.selectedCharacters.length === 0 ? '„Åô„Åπ„Å¶' : this.selectedCharacters.length + '‰∫∫ÈÅ∏Êäû‰∏≠'})
                            </button>
                            <button id="start-quiz-btn" class="w-full py-5 bg-indigo-600 text-white text-2xl font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition transform active:scale-95">
                                „ÇØ„Ç§„Ç∫„Çπ„Çø„Éº„Éà
                            </button>
                            <div class="grid grid-cols-2 gap-4">
                                <button id="nav-card-list-btn" class="py-3 border rounded-xl text-gray-600 hover:bg-gray-50 text-sm">„Ç´„Éº„Éâ‰∏ÄË¶ß</button>
                                <button onclick="window.location.reload()" class="py-3 border rounded-xl text-gray-600 hover:bg-gray-50 text-sm">„Éá„Éº„ÇøÊõ¥Êñ∞</button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400">ÁôªÈå≤Ê∏à„Åø: ${qCount}‰ª∂</p>
                    </div>
                `;
            },

            renderQuiz() {
                const quiz = this.currentQuiz;
                const q = quiz.quizQuestions[quiz.currentQuestionIndex];
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <span class="font-bold text-gray-500 text-sm">Q ${quiz.currentQuestionIndex + 1} / ${quiz.quizQuestions.length}</span>
                            <span class="text-indigo-600 font-bold">Ê≠£Ëß£Êï∞: ${quiz.score}</span>
                        </div>
                        <div class="text-center mb-4">
                            <p class="text-lg font-bold text-gray-800">${q.cardName}</p>
                            <p class="text-xs text-gray-500">${q.charName || '---'} / ${q.series || '---'}</p>
                        </div>
                        <div class="relative aspect-square bg-gray-100 rounded-xl overflow-hidden mb-6 shadow-inner">
                            <img src="${q.imageUrl}" class="w-full h-full object-contain mx-auto" onerror="this.src='https://placehold.co/600x600/ccc/999?text=No+Image'">
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            ${Object.entries(this.ATTRIBUTES).map(([id, data]) => `
                                <button data-attr="${id}" class="choice-btn py-4 ${data.color} text-white text-xl font-bold rounded-xl shadow-md transition-transform active:scale-95 border-b-4">
                                    ${data.name}
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="QuizApp.setScreen('home')" class="w-full mt-6 py-2 text-gray-400 text-sm
