<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒå±æ€§3æŠã‚¯ã‚¤ã‚º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; min-height: 100vh; }
        .app-footer { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; padding: 5px; font-size: 10px; color: #6b7280; background-color: #e5e7eb; z-index: 999; }
        img { pointer-events: none; user-select: none; }
    </style>
</head>
<body>
    <div id="message-alert" class="fixed top-0 left-1/2 -translate-x-1/2 mt-4 p-3 rounded-xl text-white font-bold opacity-0 transition-opacity duration-300 z-50 shadow-2xl"></div>
    
    <div id="app-container" class="min-h-screen flex items-center justify-center">
        <div id="loading-view" class="text-center p-4">
            <div class="animate-spin h-10 w-10 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>
            <p id="loading-text" class="mt-4 text-gray-600 font-medium">CSVãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            <div id="error-display" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-lg text-sm"></div>
        </div>
    </div>

    <div class="app-footer">X: nek0n0tem0</div>

    <script type="module">
        const CSV_FILE_PATH = 'quiz_data.csv';
        const ATTRIBUTE_MAP = { 'èµ¤': 'fire', 'é’': 'water', 'ç·‘': 'grass' };
        const ATTRIBUTES = {
            fire: { name: 'èµ¤', color: 'bg-red-500 hover:bg-red-600 border-red-700' },
            water: { name: 'é’', color: 'bg-blue-500 hover:bg-blue-600 border-blue-700' },
            grass: { name: 'ç·‘', color: 'bg-green-500 hover:bg-green-600 border-green-700' }
        };

        window.QuizApp = {
            questions: [],
            selectedCharacters: [],
            currentScreen: 'home',
            quizSettings: { totalQuestions: 10 },
            currentQuiz: { active: false, currentQuestionIndex: 0, score: 0, quizQuestions: [], answerHistory: [] },

            async init() {
                try {
                    const response = await fetch(`${CSV_FILE_PATH}?t=${Date.now()}`);
                    if (!response.ok) throw new Error(`CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«åãŒ '${CSV_FILE_PATH}' ã§ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                    
                    const text = await response.text();
                    if (!text.trim()) throw new Error("CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™ã€‚");

                    this.questions = this.parseCsv(text);
                    if (this.questions.length === 0) throw new Error("æœ‰åŠ¹ãªå•é¡Œãƒ‡ãƒ¼ã‚¿ãŒ1ä»¶ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");

                    const stored = localStorage.getItem('quizSettings');
                    if (stored) this.quizSettings = JSON.parse(stored);

                    this.renderApp();
                } catch (error) {
                    this.showFatalError(error.message);
                }
            },

            parseCsv(text) {
                const lines = text.trim().split(/\r?\n/).filter(line => line.trim() !== '');
                if (lines.length <= 1) return []; // ãƒ˜ãƒƒãƒ€ãƒ¼ã—ã‹ãªã„å ´åˆ

                return lines.slice(1).map((line, index) => {
                    const parts = line.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
                    if (parts.length < 5) return null;
                    
                    return {
                        id: `csv-${index}`,
                        charName: parts[0],
                        cardName: parts[1],
                        series: parts[2],
                        correctAttribute: ATTRIBUTE_MAP[parts[3]] || 'fire',
                        imageUrl: parts[4]
                    };
                }).filter(q => q !== null);
            },

            showFatalError(msg) {
                document.getElementById('loading-view').classList.add('hidden');
                const errDisp = document.getElementById('error-display');
                errDisp.classList.remove('hidden');
                errDisp.innerHTML = `<strong>ã‚¨ãƒ©ãƒ¼:</strong><br>${msg}<br><br><small>GitHubã¸ã®åæ˜ ã«ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</small>`;
                document.getElementById('app-container').appendChild(errDisp);
            },

            showMessage(text, type = 'info') {
                const alertDiv = document.getElementById('message-alert');
                alertDiv.textContent = text;
                alertDiv.className = `p-3 mb-4 rounded-xl text-white font-bold transition-opacity duration-300 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} opacity-100 fixed top-0 left-1/2 -translate-x-1/2 mt-4 z-50 text-sm`;
                setTimeout(() => alertDiv.classList.add('opacity-0'), 2500);
            },

            renderApp() {
                const container = document.getElementById('app-container');
                let html = '';
                switch (this.currentScreen) {
                    case 'home': html = this.renderHome(); break;
                    case 'quiz': html = this.renderQuiz(); break;
                    case 'cardList': html = this.renderCardList(); break;
                    case 'charSelect': html = this.renderCharSelect(); break;
                    case 'results': html = this.renderResults(); break;
                }
                container.innerHTML = `<div class="max-w-4xl mx-auto w-full p-4">${html}</div>`;
                this.attachEvents();
            },

            renderHome() {
                return `
                    <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                        <h1 class="text-3xl font-extrabold text-gray-900 mb-8">å±æ€§å½“ã¦ã‚¯ã‚¤ã‚º</h1>
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-4 rounded-xl border flex items-center justify-center gap-4">
                                <span class="text-sm">å‡ºé¡Œæ•°:</span>
                                <input type="number" id="total-q-input" value="${this.quizSettings.totalQuestions}" class="w-16 p-1 border rounded text-center">
                                <button id="save-settings-btn" class="bg-indigo-500 text-white px-3 py-1 rounded text-sm">ä¿å­˜</button>
                            </div>
                            <button id="nav-char-select-btn" class="w-full py-4 border-2 rounded-xl text-gray-700">ğŸ¯ ã‚­ãƒ£ãƒ©é¸æŠ (${this.selectedCharacters.length || 'ã™ã¹ã¦'})</button>
                            <button id="start-quiz-btn" class="w-full py-5 bg-indigo-600 text-white text-2xl font-bold rounded-xl shadow-lg">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                            <button id="nav-card-list-btn" class="w-full py-3 border rounded-xl text-gray-500 text-sm">ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã‚’è¡¨ç¤º</button>
                        </div>
                    </div>
                `;
            },

            renderQuiz() {
                const q = this.currentQuiz.quizQuestions[this.currentQuiz.currentQuestionIndex];
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between mb-4 text-sm font-bold text-gray-400">
                            <span>${this.currentQuiz.currentQuestionIndex + 1} / ${this.currentQuiz.quizQuestions.length}</span>
                            <span class="text-indigo-600">æ­£è§£: ${this.currentQuiz.score}</span>
                        </div>
                        <p class="text-center font-bold text-lg mb-4">${q.cardName}</p>
                        <div class="aspect-square bg-gray-50 rounded-xl overflow-hidden mb-6 border">
                            <img src="${q.imageUrl}" class="w-full h-full object-contain" onerror="this.src='https://placehold.co/400x400/ccc/999?text=Image+Error'">
                        </div>
                        <div class="grid gap-3">
                            ${Object.entries(ATTRIBUTES).map(([id, data]) => `
                                <button data-attr="${id}" class="choice-btn py-4 ${data.color} text-white font-bold rounded-xl border-b-4">${data.name}</button>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            renderResults() {
                const quiz = this.currentQuiz;
                return `
                    <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                        <h2 class="text-2xl font-bold mb-4">çµæœç™ºè¡¨</h2>
                        <p class="text-5xl font-black text-indigo-600 mb-6">${quiz.score} / ${quiz.quizQuestions.length}</p>
                        <button onclick="location.reload()" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-md">ã‚‚ã†ä¸€åº¦ã‚ãã¶</button>
                    </div>
                `;
            },

            renderCardList() {
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="font-bold mb-4 border-b">ã‚«ãƒ¼ãƒ‰ä¸€è¦§ (${this.questions.length})</h2>
                        <div class="max-h-96 overflow-y-auto space-y-2 mb-4">
                            ${this.questions.map(q => `<div class="flex items-center gap-2 p-2 border-b text-xs"><img src="${q.imageUrl}" class="w-10 h-10 object-cover rounded">${q.cardName}</div>`).join('')}
                        </div>
                        <button onclick="QuizApp.setScreen('home')" class="w-full py-2 bg-gray-100 rounded">æˆ»ã‚‹</button>
                    </div>
                `;
            },

            renderCharSelect() {
                const chars = [...new Set(this.questions.map(q => q.charName))].filter(Boolean).sort();
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="font-bold mb-4 border-b">ã‚­ãƒ£ãƒ©é¸æŠ</h2>
                        <div class="grid grid-cols-2 gap-2 max-h-80 overflow-y-auto mb-4">
                            ${chars.map(name => `<label class="flex items-center gap-2 p-2 border rounded text-sm"><input type="checkbox" value="${name}" class="char-cb" ${this.selectedCharacters.includes(name) ? 'checked' : ''}>${name}</label>`).join('')}
                        </div>
                        <button id="apply-char-btn" class="w-full py-3 bg-indigo-600 text-white rounded-xl">ç¢ºå®š</button>
                    </div>
                `;
            },

            attachEvents() {
                document.getElementById('start-quiz-btn')?.addEventListener('click', () => {
                    let av = this.selectedCharacters.length ? this.questions.filter(q => this.selectedCharacters.includes(q.charName)) : this.questions;
                    this.currentQuiz = { active: true, currentQuestionIndex: 0, score: 0, quizQuestions: av.sort(() => Math.random() - 0.5).slice(0, this.quizSettings.totalQuestions), answerHistory: [] };
                    this.setScreen('quiz');
                });
                document.getElementById('nav-card-list-btn')?.addEventListener('click', () => this.setScreen('cardList'));
                document.getElementById('nav-char-select-btn')?.addEventListener('click', () => this.setScreen('charSelect'));
                document.getElementById('save-settings-btn')?.addEventListener('click', () => {
                    this.quizSettings.totalQuestions = parseInt(document.getElementById('total-q-input').value) || 10;
                    localStorage.setItem('quizSettings', JSON.stringify(this.quizSettings));
                    this.showMessage("ä¿å­˜ã—ã¾ã—ãŸ");
                });
                document.querySelectorAll('.choice-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const isCorrect = this.currentQuiz.quizQuestions[this.currentQuiz.currentQuestionIndex].correctAttribute === btn.dataset.attr;
                        if (isCorrect) this.currentQuiz.score++;
                        this.showMessage(isCorrect ? "æ­£è§£ï¼" : "ä¸æ­£è§£...", isCorrect ? 'success' : 'error');
                        setTimeout(() => {
                            this.currentQuiz.currentQuestionIndex++;
                            if (this.currentQuiz.currentQuestionIndex >= this.currentQuiz.quizQuestions.length) this.setScreen('results');
                            else this.renderApp();
                        }, 1000);
                    });
                });
                document.getElementById('apply-char-btn')?.addEventListener('click', () => {
                    this.selectedCharacters = Array.from(document.querySelectorAll('.char-cb:checked')).map(cb => cb.value);
                    this.setScreen('home');
                });
            },

            setScreen(s) { this.currentScreen = s; this.renderApp(); }
        };

        window.QuizApp.init();
    </script>
</body>
</html>
