<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒå±æ€§3æŠã‚¯ã‚¤ã‚º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .quiz-button {
            transition: all 0.3s ease;
        }
        .quiz-button:hover {
            transform: scale(1.05);
        }
        .correct {
            background-color: #10b981 !important;
            color: white !important;
        }
        .incorrect {
            background-color: #ef4444 !important;
            color: white !important;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
        <div id="homeScreen" class="fade-in">
            <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">ç”»åƒå±æ€§3æŠã‚¯ã‚¤ã‚º</h1>
            
            <!-- ãŠçŸ¥ã‚‰ã›ã‚¨ãƒªã‚¢ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">ğŸ“¢ ãŠçŸ¥ã‚‰ã›ï¼ˆæ–°ç€ã‚«ãƒ¼ãƒ‰ï¼‰</h2>
                <div id="newsArea" class="space-y-2 text-gray-600">
                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>

            <!-- å‡ºé¡Œæ•°è¨­å®š -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">å‡ºé¡Œè¨­å®š</h2>
                <div class="flex items-center gap-4">
                    <label for="questionCount" class="text-gray-700">å‡ºé¡Œæ•°:</label>
                    <input 
                        type="number" 
                        id="questionCount" 
                        min="1" 
                        value="10"
                        class="border border-gray-300 rounded px-4 py-2 w-24"
                    >
                    <span id="maxQuestions" class="text-gray-600"></span>
                </div>
            </div>

            <!-- ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
            <button 
                onclick="startQuiz()" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-xl quiz-button"
            >
                ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆ
            </button>
        </div>

        <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
        <div id="quizScreen" class="hidden fade-in">
            <div class="text-center mb-6">
                <span id="questionNumber" class="text-xl font-semibold text-gray-700"></span>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <!-- ã‚«ãƒ¼ãƒ‰ç”»åƒ -->
                <div class="mb-6">
                    <img 
                        id="cardImage" 
                        src="" 
                        alt="ã‚«ãƒ¼ãƒ‰ç”»åƒ" 
                        class="w-full max-w-md mx-auto rounded-lg shadow-md"
                    >
                </div>

                <!-- ã‚«ãƒ¼ãƒ‰æƒ…å ± -->
                <div class="text-center mb-6">
                    <p class="text-lg font-semibold text-gray-800" id="cardInfo"></p>
                </div>

                <!-- é¸æŠè‚¢ãƒœã‚¿ãƒ³ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <button 
                        onclick="selectAnswer('fire')" 
                        id="btn-fire"
                        class="quiz-button bg-red-500 hover:bg-red-600 text-white font-bold py-6 px-4 rounded-lg text-xl"
                    >
                        ğŸ”¥ èµ¤/ç«
                    </button>
                    <button 
                        onclick="selectAnswer('water')" 
                        id="btn-water"
                        class="quiz-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-6 px-4 rounded-lg text-xl"
                    >
                        ğŸ’§ é’/æ°´
                    </button>
                    <button 
                        onclick="selectAnswer('grass')" 
                        id="btn-grass"
                        class="quiz-button bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-4 rounded-lg text-xl"
                    >
                        ğŸŒ¿ ç·‘/è‰
                    </button>
                </div>

                <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¨ãƒªã‚¢ -->
                <div id="feedback" class="text-center text-xl font-bold mb-4 min-h-8"></div>
            </div>

            <!-- ä¸­æ–­ãƒœã‚¿ãƒ³ -->
            <button 
                onclick="abortQuiz()" 
                class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg"
            >
                ã‚¯ã‚¤ã‚ºã‚’ä¸­æ–­
            </button>
        </div>

        <!-- çµæœç”»é¢ -->
        <div id="resultScreen" class="hidden fade-in">
            <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">ã‚¯ã‚¤ã‚ºçµæœ</h1>
            
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <div class="text-center mb-6">
                    <p class="text-6xl font-bold mb-4" id="scoreDisplay"></p>
                    <p class="text-2xl text-gray-700" id="accuracyDisplay"></p>
                </div>

                <!-- å›ç­”å±¥æ­´ -->
                <div class="mt-8">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">å›ç­”å±¥æ­´</h2>
                    <div id="answerHistory" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button 
                    onclick="shareToX()" 
                    class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-4 px-6 rounded-lg quiz-button"
                >
                    ğ• ã§ã‚·ã‚§ã‚¢
                </button>
                <button 
                    onclick="backToHome()" 
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 px-6 rounded-lg quiz-button"
                >
                    ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let quizData = [];
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let answerHistory = [];

        // å±æ€§ãƒ©ãƒ™ãƒ«å¤‰æ›
        const attributeLabels = {
            'fire': 'ğŸ”¥ èµ¤/ç«',
            'water': 'ğŸ’§ é’/æ°´',
            'grass': 'ğŸŒ¿ ç·‘/è‰'
        };

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆåŒã˜éšå±¤ï¼‰
        const CSV_FILE_PATH = './quiz_data.csv';

        // åˆæœŸåŒ–å‡¦ç†
        async function init() {
            await loadCSVData();
            updateNews();
            updateMaxQuestions();
            showScreen('homeScreen');
        }

        // CSVãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadCSVData() {
            try {
                const response = await fetch(CSV_FILE_PATH);
                if (!response.ok) {
                    throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                const csvText = await response.text();
                quizData = parseCSV(csvText);
                console.log(`${quizData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            } catch (error) {
                console.error('CSVãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚quiz_data.csvãƒ•ã‚¡ã‚¤ãƒ«ãŒåŒã˜éšå±¤ã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                quizData = [];
            }
        }

        // CSVè§£æ
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const data = [];
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            const startIndex = lines[0].includes('ã‚­ãƒ£ãƒ©å') || lines[0].includes('charName') ? 1 : 0;
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // CSVè¡Œã‚’è§£æï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’è€ƒæ…®ï¼‰
                const columns = parseCSVLine(line);
                
                if (columns.length >= 5) {
                    const attribute = normalizeAttribute(columns[3]);
                    if (attribute) {
                        data.push({
                            id: i,
                            charName: columns[0].trim(),
                            cardName: columns[1].trim(),
                            series: columns[2].trim(),
                            correctAttribute: attribute,
                            imageUrl: columns[4].trim(),
                            createdAt: columns[5] ? columns[5].trim() : new Date().toISOString().split('T')[0].replace(/-/g, '/')
                        });
                    }
                }
            }
            
            return data;
        }

        // CSVè¡Œã‚’è§£æï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
        function parseCSVLine(line) {
            const columns = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    columns.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            columns.push(current);
            
            return columns.map(col => col.replace(/^"|"$/g, ''));
        }

        // å±æ€§ã‚’æ­£è¦åŒ–
        function normalizeAttribute(attr) {
            const normalized = attr.toLowerCase().trim();
            if (normalized === 'èµ¤' || normalized === 'ç«' || normalized === 'fire' || normalized === 'red') {
                return 'fire';
            } else if (normalized === 'é’' || normalized === 'æ°´' || normalized === 'water' || normalized === 'blue') {
                return 'water';
            } else if (normalized === 'ç·‘' || normalized === 'è‰' || normalized === 'grass' || normalized === 'green') {
                return 'grass';
            }
            return null;
        }

        // ãŠçŸ¥ã‚‰ã›æ›´æ–°
        function updateNews() {
            const newsArea = document.getElementById('newsArea');
            if (quizData.length === 0) {
                newsArea.innerHTML = '<p class="text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // ç™»éŒ²æ—¥ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            const sorted = [...quizData].sort((a, b) => {
                return new Date(b.createdAt) - new Date(a.createdAt);
            });

            const latest = sorted.slice(0, 3);
            newsArea.innerHTML = latest.map(card => 
                `<p>ãƒ»${card.createdAt} - ${card.charName}ã€Œ${card.cardName}ã€ï¼ˆ${card.series}ï¼‰ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ</p>`
            ).join('');
        }

        // æœ€å¤§å‡ºé¡Œæ•°è¡¨ç¤º
        function updateMaxQuestions() {
            const maxQuestions = document.getElementById('maxQuestions');
            const questionCount = document.getElementById('questionCount');
            maxQuestions.textContent = `ï¼ˆæœ€å¤§: ${quizData.length}å•ï¼‰`;
            questionCount.max = quizData.length;
            questionCount.value = Math.min(10, quizData.length);
        }

        // ã‚¯ã‚¤ã‚ºé–‹å§‹
        function startQuiz() {
            if (quizData.length === 0) {
                alert('ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const questionCount = parseInt(document.getElementById('questionCount').value);
            if (questionCount < 1 || questionCount > quizData.length) {
                alert(`å‡ºé¡Œæ•°ã¯1ã€œ${quizData.length}ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚`);
                return;
            }

            // åˆæœŸåŒ–
            currentQuestionIndex = 0;
            correctCount = 0;
            answerHistory = [];

            // ãƒ©ãƒ³ãƒ€ãƒ ã«å•é¡Œã‚’é¸æŠ
            currentQuestions = shuffleArray([...quizData]).slice(0, questionCount);

            showScreen('quizScreen');
            showQuestion();
        }

        // å•é¡Œè¡¨ç¤º
        function showQuestion() {
            const question = currentQuestions[currentQuestionIndex];
            
            document.getElementById('questionNumber').textContent = 
                `ç¬¬${currentQuestionIndex + 1}å• / ${currentQuestions.length}å•`;
            document.getElementById('cardImage').src = question.imageUrl;
            document.getElementById('cardInfo').textContent = 
                `${question.charName} -ã€Œ${question.cardName}ã€- ${question.series}`;
            document.getElementById('feedback').textContent = '';

            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            ['fire', 'water', 'grass'].forEach(attr => {
                const btn = document.getElementById(`btn-${attr}`);
                btn.disabled = false;
                btn.className = btn.className.replace(/ (correct|incorrect)/g, '');
            });
        }

        // å›ç­”é¸æŠ
        function selectAnswer(selectedAttribute) {
            const question = currentQuestions[currentQuestionIndex];
            const isCorrect = selectedAttribute === question.correctAttribute;

            // ãƒœã‚¿ãƒ³ã®è‰²ã‚’å¤‰æ›´
            const selectedBtn = document.getElementById(`btn-${selectedAttribute}`);
            const correctBtn = document.getElementById(`btn-${question.correctAttribute}`);

            selectedBtn.classList.add(isCorrect ? 'correct' : 'incorrect');
            if (!isCorrect) {
                correctBtn.classList.add('correct');
            }

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
            const feedback = document.getElementById('feedback');
            feedback.textContent = isCorrect ? 'â­• æ­£è§£ï¼' : 'âŒ ä¸æ­£è§£';
            feedback.className = `text-center text-2xl font-bold mb-4 ${isCorrect ? 'text-green-600' : 'text-red-600'}`;

            // å±¥æ­´ã«è¨˜éŒ²
            if (isCorrect) correctCount++;
            answerHistory.push({
                question: question,
                isCorrect: isCorrect,
                selectedAttribute: selectedAttribute
            });

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            ['fire', 'water', 'grass'].forEach(attr => {
                document.getElementById(`btn-${attr}`).disabled = true;
            });

            // æ¬¡ã®å•é¡Œã¸
            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < currentQuestions.length) {
                    showQuestion();
                } else {
                    showResult();
                }
            }, 1500);
        }

        // çµæœè¡¨ç¤º
        function showResult() {
            const totalQuestions = currentQuestions.length;
            const accuracy = Math.round((correctCount / totalQuestions) * 100);

            document.getElementById('scoreDisplay').textContent = 
                `${correctCount} / ${totalQuestions} å•æ­£è§£`;
            document.getElementById('accuracyDisplay').textContent = 
                `æ­£ç­”ç‡: ${accuracy}%`;

            // å›ç­”å±¥æ­´è¡¨ç¤º
            const historyArea = document.getElementById('answerHistory');
            historyArea.innerHTML = answerHistory.map((item, index) => {
                const icon = item.isCorrect ? 'â­•' : 'âŒ';
                const colorClass = item.isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                return `
                    <div class="p-3 border rounded ${colorClass}">
                        <span class="font-semibold">${icon} ç¬¬${index + 1}å•:</span>
                        ${item.question.charName} -ã€Œ${item.question.cardName}ã€-
                        <span class="text-sm text-gray-600">
                            ï¼ˆæ­£è§£: ${attributeLabels[item.question.correctAttribute]}ï¼‰
                        </span>
                    </div>
                `;
            }).join('');

            showScreen('resultScreen');
        }

        // X (Twitter) ã«ã‚·ã‚§ã‚¢
        function shareToX() {
            const totalQuestions = currentQuestions.length;
            const accuracy = Math.round((correctCount / totalQuestions) * 100);
            const text = `ç”»åƒå±æ€§3æŠã‚¯ã‚¤ã‚ºã§${totalQuestions}å•ä¸­${correctCount}å•æ­£è§£ï¼ï¼ˆæ­£ç­”ç‡${accuracy}%ï¼‰`;
            const url = window.location.href;
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
            window.open(twitterUrl, '_blank');
        }

        // ã‚¯ã‚¤ã‚ºä¸­æ–­
        function abortQuiz() {
            if (confirm('ã‚¯ã‚¤ã‚ºã‚’ä¸­æ–­ã—ã¦ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
                backToHome();
            }
        }

        // ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
        function backToHome() {
            showScreen('homeScreen');
        }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function showScreen(screenId) {
            ['homeScreen', 'quizScreen', 'resultScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        // é…åˆ—ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
