<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚«ãƒ¼ãƒ‰å¾©åˆ»äºˆæ¸¬ | Nek0 Projects</title>
  <link rel="stylesheet" href="../style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* ---- å¾©åˆ»äºˆæ¸¬ å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« ---- */

    /* å±æ€§ãƒãƒƒã‚¸ */
    .attr-badge {
      display: inline-block;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 6px;
      border: 1px solid;
    }

    .attr-ç« {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.4);
      color: #f87171;
    }

    .attr-æ°´ {
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.4);
      color: #60a5fa;
    }

    .attr-è‰ {
      background: rgba(34, 197, 94, 0.15);
      border-color: rgba(34, 197, 94, 0.4);
      color: #4ade80;
    }

    .attr-èµ¤ {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.4);
      color: #f87171;
    }

    .attr-é’ {
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.4);
      color: #60a5fa;
    }

    .attr-ç·‘ {
      background: rgba(34, 197, 94, 0.15);
      border-color: rgba(34, 197, 94, 0.4);
      color: #4ade80;
    }

    /* ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã‚¢ã‚¤ãƒ†ãƒ  */
    .card-item {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .card-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--accent-color);
      transform: translateX(3px);
    }

    .card-img {
      width: 52px;
      height: 52px;
      object-fit: cover;
      object-position: top;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      flex-shrink: 0;
    }

    .card-img-large {
      width: 100px;
      height: 100px;
      object-fit: cover;
      object-position: top;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      flex-shrink: 0;
    }

    .card-info {
      flex: 1;
      min-width: 0;
    }

    .card-name {
      font-size: 0.85rem;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-char {
      font-size: 0.72rem;
      color: var(--text-secondary);
    }

    .card-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .card-right {
      text-align: right;
      flex-shrink: 0;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* æ¬¡å›äºˆæ¸¬ã‚«ãƒ¼ãƒ‰ */
    .prediction-highlight {
      background: rgba(167, 139, 250, 0.08);
      border: 1px solid rgba(167, 139, 250, 0.3);
      border-radius: 14px;
      padding: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .prediction-highlight:hover {
      background: rgba(167, 139, 250, 0.14);
      border-color: var(--accent-color);
      transform: translateY(-2px);
    }

    .next-date-box {
      background: rgba(167, 139, 250, 0.07);
      border: 1px solid rgba(167, 139, 250, 0.2);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 12px;
    }

    /* æœˆé–“äºˆæ¸¬ãƒªã‚¹ãƒˆ */
    .monthly-group {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .monthly-group-header {
      background: rgba(255, 255, 255, 0.04);
      padding: 8px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
    }

    .monthly-date {
      color: var(--accent-color);
      font-weight: 700;
    }

    .monthly-group-body {
      padding: 8px;
    }

    .monthly-card {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      padding: 8px 10px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 4px;
    }

    .monthly-card:last-child {
      margin-bottom: 0;
    }

    .monthly-card:hover {
      background: rgba(255, 255, 255, 0.07);
    }

    .monthly-card img {
      width: 36px;
      height: 36px;
      object-fit: cover;
      object-position: top;
      border-radius: 6px;
    }

    /* ä¿¡é ¼åº¦ãƒãƒƒã‚¸ */
    .conf-high {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.35);
      color: #6ee7b7;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 0.65rem;
      font-weight: 700;
    }

    .conf-medium {
      background: rgba(245, 158, 11, 0.15);
      border: 1px solid rgba(245, 158, 11, 0.35);
      color: #fcd34d;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 0.65rem;
      font-weight: 700;
    }

    .conf-low {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.35);
      color: #fca5a5;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 0.65rem;
      font-weight: 700;
    }

    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
    }

    .cal-header-cell {
      text-align: center;
      font-size: 0.65rem;
      padding: 4px 0;
      color: var(--text-secondary);
    }

    .cal-header-cell.reprint-day {
      color: var(--accent-color);
      font-weight: 700;
    }

    .cal-cell {
      min-height: 60px;
      padding: 4px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(0, 0, 0, 0.15);
      font-size: 0.7rem;
      transition: all 0.15s;
    }

    .cal-cell.is-today {
      background: rgba(167, 139, 250, 0.12);
      border-color: var(--accent-color);
    }

    .cal-cell.is-past {
      opacity: 0.35;
    }

    .cal-cell.has-pred {
      background: rgba(167, 139, 250, 0.07);
      border-color: rgba(167, 139, 250, 0.25);
      cursor: pointer;
    }

    .cal-cell.has-pred:hover {
      background: rgba(167, 139, 250, 0.15);
    }

    .cal-cell.reprint-day {
      border-color: rgba(167, 139, 250, 0.12);
    }

    .cal-date {
      color: var(--text-secondary);
      margin-bottom: 3px;
    }

    .cal-date.today-text {
      color: var(--accent-color);
      font-weight: 700;
    }

    .cal-date.reprint-text {
      color: rgba(167, 139, 250, 0.7);
    }

    .cal-chips {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .cal-chip {
      font-size: 0.55rem;
      background: rgba(167, 139, 250, 0.2);
      color: #ddd6fe;
      border-radius: 3px;
      padding: 1px 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ãƒœã‚¿ãƒ³ */
    .view-tab {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 6px 14px;
      font-size: 0.78rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .view-tab.active {
      background: rgba(167, 139, 250, 0.15);
      border-color: var(--accent-color);
      color: var(--accent-color);
      font-weight: 700;
    }

    /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
    .search-box {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 0.85rem;
      padding: 10px 14px;
      outline: none;
      transition: all 0.2s;
      box-sizing: border-box;
      font-family: inherit;
    }

    .search-box:focus {
      border-color: var(--accent-color);
    }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
    .scroll-area {
      max-height: 500px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .scroll-area::-webkit-scrollbar {
      width: 4px;
    }

    .scroll-area::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.04);
      border-radius: 4px;
    }

    .scroll-area::-webkit-scrollbar-thumb {
      background: var(--accent-color);
      border-radius: 4px;
      opacity: 0.6;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .pred-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(6px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .pred-modal-overlay.open {
      display: flex;
    }

    .pred-modal-content {
      background: var(--bg-dark);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      width: 100%;
      max-width: 480px;
      max-height: 88vh;
      overflow-y: auto;
      position: relative;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    /* çµ±è¨ˆã‚°ãƒªãƒƒãƒ‰ */
    .stat-mini-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin: 12px 0;
    }

    .stat-mini {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
    }

    .stat-mini-label {
      font-size: 0.65rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .stat-mini-val {
      font-size: 1rem;
      font-weight: 700;
    }

    /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¢ã‚¤ã‚³ãƒ³ */
    .rank-badge {
      font-size: 1.3rem;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« */
    .section-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading-spin {
      width: 44px;
      height: 44px;
      border: 3px solid var(--accent-color);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @media (max-width: 600px) {
      .cal-cell {
        min-height: 44px;
      }

      .cal-chip {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div class="background-animation"></div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading"
    style="position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center;">
    <div class="loading-spin"></div>
    <p style="color: var(--text-secondary); font-size: 0.85rem;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>

  <div id="mainContent" class="hidden">
    <div class="container">

      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <header class="site-header">
        <div class="logo">ğŸ”® ã‚«ãƒ¼ãƒ‰å¾©åˆ»äºˆæ¸¬</div>
        <p class="subtitle">æ¯é€±ç«æ›œãƒ»é‡‘æ›œã«2æšãšã¤å¾©åˆ»ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰äºˆæ¸¬</p>
      </header>

      <main>

        <!-- æ¬¡å›å¾©åˆ»äºˆæ¸¬ -->
        <div class="content-card">
          <div class="section-label"><i class="fa-solid fa-star" style="color:var(--accent-color);"></i> æ¬¡å›å¾©åˆ»ã™ã‚‹ã‚«ãƒ¼ãƒ‰äºˆæ¸¬
          </div>
          <div id="nextReprintPrediction"></div>
        </div>

        <!-- ä»Šå¾Œ1ã‹æœˆã®å¾©åˆ»äºˆæ¸¬ -->
        <div class="content-card">
          <div class="section-label"><i class="fa-solid fa-calendar-days" style="color:var(--accent-color);"></i>
            ä»Šå¾Œ1ã‹æœˆã®å¾©åˆ»äºˆæ¸¬</div>
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 10px;"><span
              id="dateRange"></span></div>
          <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <button id="viewList" class="view-tab active">ãƒªã‚¹ãƒˆè¡¨ç¤º</button>
            <button id="viewCalendar" class="view-tab">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º</button>
          </div>
          <div id="monthlyListView" class="scroll-area"></div>
          <div id="monthlyCalendarView" class="hidden"></div>
        </div>

        <!-- ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã‹ã‚‰é¸æŠ -->
        <div class="content-card">
          <div class="section-label"><i class="fa-solid fa-list" style="color:var(--accent-color);"></i> ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã‹ã‚‰é¸æŠ</div>
          <div style="margin-bottom: 12px;">
            <input type="text" id="searchInput" placeholder="ã‚«ãƒ¼ãƒ‰åãƒ»ã‚­ãƒ£ãƒ©åã§æ¤œç´¢..." class="search-box">
          </div>
          <div id="cardList" class="scroll-area"></div>
        </div>

        <div style="text-align: center; margin-top: 10px; margin-bottom: 20px;">
          <a href="../index.html" class="btn-back" style="border: none; opacity: 0.6;">â† ãƒ„ãƒ¼ãƒ«ä¸€è¦§ã«æˆ»ã‚‹</a>
        </div>
      </main>

      <footer class="site-footer">
        <p>&copy; 2024 Nek0 Project. Unofficial Tool.</p>
      </footer>
    </div>
  </div>

  <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="detailModal" class="pred-modal-overlay">
    <div class="pred-modal-content">
      <button id="closeModal"
        style="position: absolute; top: 14px; right: 14px; background: none; border: none; color: var(--text-secondary); font-size: 1.4rem; cursor: pointer;">
        <i class="fa-solid fa-xmark"></i>
      </button>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    let cardMap = null;
    let today = new Date();
    let allReprintDates = [];
    const attrConfig = { 'ç«': { emoji: 'ğŸ”¥' }, 'æ°´': { emoji: 'ğŸ’§' }, 'è‰': { emoji: 'ğŸŒ¿' }, 'èµ¤': { emoji: 'ğŸ”´' }, 'é’': { emoji: 'ğŸ”µ' }, 'ç·‘': { emoji: 'ğŸŸ¢' } };

    async function loadCSV(filename) {
      try {
        const response = await fetch(filename);
        if (!response.ok) throw new Error('CSVèª­ã¿è¾¼ã¿å¤±æ•—');
        const buffer = await response.arrayBuffer();
        return new TextDecoder('shift-jis').decode(buffer);
      } catch (error) {
        console.error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    }

    function parseCSV(csv) {
      return csv.trim().split('\n').slice(1).map(line => {
        const v = line.split(',');
        return { charName: v[1], cardName: v[2], series: v[3], attr: v[4], startDate: parseDate(v[5]), endDate: parseDate(v[6]), reprintCount: parseInt(v[7]), imageUrl: v[8] };
      });
    }
    function parseDate(s) { const [y, m, d] = s.split('/').map(Number); return new Date(y, m - 1, d); }
    function formatDate(d) { return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`; }

    function aggregateCards(data) {
      const map = new Map();
      data.forEach(e => {
        const key = `${e.charName}_${e.cardName}`;
        if (!map.has(key)) map.set(key, { charName: e.charName, cardName: e.cardName, series: e.series, attr: e.attr, imageUrl: e.imageUrl, appearances: [], maxReprintCount: 0 });
        const c = map.get(key);
        c.appearances.push({ startDate: e.startDate, endDate: e.endDate, reprintCount: e.reprintCount });
        c.maxReprintCount = Math.max(c.maxReprintCount, e.reprintCount);
      });
      map.forEach(c => c.appearances.sort((a, b) => a.startDate - b.startDate));
      return map;
    }

    function calculateIntervals(appearances) {
      const intervals = [];
      for (let i = 1; i < appearances.length; i++) intervals.push(Math.round((appearances[i].startDate - appearances[i - 1].startDate) / 864e5));
      return intervals;
    }

    function getNextReprintDates(from, count = 200) {
      const dates = []; const cur = new Date(from);
      while (dates.length < count) { if (cur.getDay() === 2 || cur.getDay() === 5) dates.push(new Date(cur)); cur.setDate(cur.getDate() + 1); }
      return dates;
    }

    // æœŸå¾…é–“éš”ã‚’åŠ é‡å¹³å‡ã§è¨ˆç®—ï¼ˆç›´è¿‘ã®é–“éš”ã‚’é‡è¦– + å¾©åˆ»å›æ•°è£œæ­£ï¼‰
    function calcExpectedInterval(card) {
      const intervals = calculateIntervals(card.appearances);
      let expectedInterval = 60;
      if (intervals.length >= 2) {
        // ç›´è¿‘ã®é–“éš”ã»ã©é‡ã¿ã‚’å¤§ããã—ãŸåŠ é‡å¹³å‡
        let weightedSum = 0, weightTotal = 0;
        intervals.forEach((iv, i) => {
          const weight = i + 1;
          weightedSum += iv * weight;
          weightTotal += weight;
        });
        expectedInterval = Math.round(weightedSum / weightTotal);
      } else if (intervals.length === 1) {
        expectedInterval = intervals[0];
      }
      // å¾©åˆ»å›æ•°ãŒ3å›ä»¥ä¸Šã®ã‚«ãƒ¼ãƒ‰ã¯é–“éš”ãŒä¼¸ã³ã‚‹å‚¾å‘ã‚’è£œæ­£
      const reprintCount = card.maxReprintCount;
      if (reprintCount >= 3) {
        expectedInterval = Math.round(expectedInterval * (1 + (reprintCount - 2) * 0.15));
      }
      return expectedInterval;
    }

    function calculateReprintScore(card) {
      const last = card.appearances[card.appearances.length - 1].startDate;
      const days = Math.round((today - last) / 864e5);
      const expectedInterval = calcExpectedInterval(card);
      const intervals = calculateIntervals(card.appearances);
      const avgInterval = intervals.length > 0 ? Math.round(intervals.reduce((a, b) => a + b, 0) / intervals.length) : 60;
      return { score: days / expectedInterval, daysSinceLast: days, avgInterval: avgInterval, expectedInterval: expectedInterval, lastAppearance: last, reprintCount: card.maxReprintCount };
    }

    let cachedRankings = null;
    function getRankings() {
      if (cachedRankings) return cachedRankings;
      const allScores = [];
      cardMap.forEach((c, k) => allScores.push({ key: k, score: calculateReprintScore(c).score }));
      allScores.sort((a, b) => b.score - a.score);
      cachedRankings = allScores;
      return cachedRankings;
    }

    function predictNextReprintCandidates() {
      const rankings = getRankings();
      const nextDate = allReprintDates[0];
      return rankings.slice(0, 2).map((r, i) => {
        const c = cardMap.get(r.key);
        const score = calculateReprintScore(c);
        return {
          key: r.key, charName: c.charName, cardName: c.cardName, imageUrl: c.imageUrl, attr: c.attr, series: c.series,
          prediction: { predictedDate: nextDate, confidence: r.score > 1.2 ? 'high' : r.score > 0.8 ? 'medium' : 'low', averageInterval: score.avgInterval, lastAppearance: score.lastAppearance },
          daysUntil: Math.round((nextDate - today) / 864e5), daysSinceLast: score.daysSinceLast, score: r.score, reprintCount: score.reprintCount
        };
      });
    }

    function getMonthlyPredictions() {
      const end = new Date(today); end.setDate(end.getDate() + 30);
      const reprintDates = allReprintDates.filter(d => d <= end);
      const predictions = [];
      // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨: ä»®æƒ³çš„ãªæœ€çµ‚å¾©åˆ»æ—¥ã‚’ä¿æŒ
      const virtualLastDate = new Map();
      cardMap.forEach((c, k) => {
        virtualLastDate.set(k, c.appearances[c.appearances.length - 1].startDate);
      });
      reprintDates.forEach(date => {
        // å„å¾©åˆ»æ—¥ã”ã¨ã«ã‚¹ã‚³ã‚¢ã‚’ä»®æƒ³æœ€çµ‚å¾©åˆ»æ—¥ã§å†è¨ˆç®—
        const scores = [];
        cardMap.forEach((c, k) => {
          const lastDate = virtualLastDate.get(k);
          const days = Math.round((date - lastDate) / 864e5);
          if (days <= 0) return;
          const expectedInterval = calcExpectedInterval(c);
          scores.push({ key: k, score: days / expectedInterval, days, expectedInterval });
        });
        scores.sort((a, b) => b.score - a.score);
        let assigned = 0;
        for (const s of scores) {
          if (assigned >= 2) break;
          const c = cardMap.get(s.key);
          const intervals = calculateIntervals(c.appearances);
          const avgInterval = intervals.length > 0 ? Math.round(intervals.reduce((a, b) => a + b, 0) / intervals.length) : 60;
          const conf = s.score > 1.2 ? 'high' : s.score > 0.8 ? 'medium' : 'low';
          predictions.push({ key: s.key, charName: c.charName, cardName: c.cardName, imageUrl: c.imageUrl, attr: c.attr, series: c.series, date, confidence: conf, averageInterval: avgInterval, reprintCount: c.maxReprintCount, daysSinceLast: s.days, score: s.score });
          virtualLastDate.set(s.key, date); // ä»®æƒ³å¾©åˆ»æ—¥ã‚’æ›´æ–°
          assigned++;
        }
      });
      return predictions.sort((a, b) => a.date - b.date);
    }

    function getAttrBadge(attr) {
      const c = attrConfig[attr] || { emoji: '' };
      return `<span class="attr-badge attr-${attr}">${c.emoji} ${attr}</span>`;
    }

    function getConfBadge(conf) {
      const labels = { high: 'ä¿¡é ¼åº¦ï¼šé«˜', medium: 'ä¿¡é ¼åº¦ï¼šä¸­', low: 'ä¿¡é ¼åº¦ï¼šä½' };
      return `<span class="conf-${conf}">${labels[conf]}</span>`;
    }

    function renderCardList(filter = '') {
      const list = document.getElementById('cardList');
      const cards = Array.from(cardMap.entries())
        .filter(([k, c]) => c.cardName.includes(filter) || c.charName.includes(filter))
        .sort((a, b) => a[1].charName.localeCompare(b[1].charName, 'ja'));
      if (cards.length === 0) { list.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--text-secondary);">ä¸€è‡´ã™ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
      list.innerHTML = cards.map(([k, c]) => {
        const last = c.appearances[c.appearances.length - 1].startDate;
        return `<div class="card-item" data-card="${k}">
      <img src="${c.imageUrl}" alt="${c.cardName}" class="card-img" loading="lazy" onerror="this.style.display='none'">
      <div class="card-info">
        <div class="card-name">${c.cardName}</div>
        <div class="card-char">${c.charName}</div>
        <div class="card-meta">${getAttrBadge(c.attr)}<span style="font-size: 0.65rem; color: var(--text-secondary);">${c.series || ''}</span></div>
      </div>
      <div class="card-right">${c.maxReprintCount}å›<br>${formatDate(last)}</div>
    </div>`;
      }).join('');
      list.querySelectorAll('.card-item').forEach(el => el.addEventListener('click', () => showCardDetail(el.dataset.card)));
    }

    function showCardDetail(key) {
      const card = cardMap.get(key);
      const score = calculateReprintScore(card);
      const rankings = getRankings();
      const rank = rankings.findIndex(r => r.key === key) + 1;
      const dateIndex = Math.floor((rank - 1) / 2);
      const predictedDate = allReprintDates[dateIndex] || allReprintDates[allReprintDates.length - 1];
      const confidence = score.score > 1.2 ? 'high' : score.score > 0.8 ? 'medium' : 'low';
      const intervals = card.appearances.length >= 2 ? calculateIntervals(card.appearances) : [];
      const daysUntil = Math.round((predictedDate - today) / 864e5);
      const weekday = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][predictedDate.getDay()];
      const status = daysUntil === 0 ? 'ä»Šæ—¥ï¼' : daysUntil === 1 ? 'æ˜æ—¥ï¼' : `ã‚ã¨${daysUntil}æ—¥`;

      document.getElementById('modalContent').innerHTML = `
    <div style="display: flex; align-items: flex-start; gap: 14px; margin-bottom: 16px;">
      <img src="${card.imageUrl}" alt="${card.cardName}" class="card-img-large" onerror="this.style.display='none'">
      <div style="flex: 1; min-width: 0; padding-right: 32px;">
        <h3 style="font-size: 1rem; font-weight: 700; margin-bottom: 4px;">${card.cardName}</h3>
        <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 8px;">${card.charName}</div>
        <div style="display: flex; gap: 6px; flex-wrap: wrap;">${getAttrBadge(card.attr)}</div>
      </div>
    </div>
    <div style="background: rgba(167,139,250,0.07); border: 1px solid rgba(167,139,250,0.2); border-radius: 12px; padding: 12px 14px; margin-bottom: 12px;">
      <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 4px;">æ¬¡å›å¾©åˆ»äºˆæ¸¬</div>
      <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-color);">${formatDate(predictedDate)}ï¼ˆ${weekday}ï¼‰</div>
      <div style="font-size: 0.78rem; color: ${daysUntil <= 3 ? '#fcd34d' : 'var(--text-secondary)'}; margin-top: 2px;">${status} / å„ªå…ˆé †ä½ ${rank}ä½</div>
    </div>
    <div class="stat-mini-grid">
      <div class="stat-mini"><div class="stat-mini-label">æœ€çµ‚å¾©åˆ»ã‹ã‚‰</div><div class="stat-mini-val">${score.daysSinceLast}æ—¥</div></div>
      <div class="stat-mini"><div class="stat-mini-label">å¹³å‡é–“éš”</div><div class="stat-mini-val">${score.avgInterval}æ—¥</div></div>
      <div class="stat-mini"><div class="stat-mini-label">ä¿¡é ¼åº¦</div><div class="stat-mini-val" style="font-size: 0.85rem;">${getConfBadge(confidence)}</div></div>
    </div>
    <div style="margin-top: 12px;">
      <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 8px;">å¾©åˆ»å±¥æ­´ï¼ˆ${card.maxReprintCount}å›ï¼‰</div>
      <div style="max-height: 130px; overflow-y: auto;">
        ${card.appearances.map((a, i) => `<div style="font-size: 0.75rem; display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); border-radius: 6px; padding: 5px 10px; margin-bottom: 4px;"><span>${i + 1}å›ç›®</span><span style="color: var(--text-secondary);">${formatDate(a.startDate)}</span></div>`).join('')}
      </div>
      ${intervals.length > 0 ? `<div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 8px;">é–“éš”: ${intervals.join('æ—¥ / ')}æ—¥</div>` : ''}
    </div>
  `;
      document.getElementById('detailModal').classList.add('open');
    }

    function renderNextReprintPrediction() {
      const candidates = predictNextReprintCandidates();
      const container = document.getElementById('nextReprintPrediction');
      if (candidates.length === 0) { container.innerHTML = '<div style="color: var(--text-secondary);">äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
      const nextDate = candidates[0].prediction.predictedDate;
      const weekday = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][nextDate.getDay()];
      const daysUntil = candidates[0].daysUntil;
      const dayLabel = daysUntil === 0 ? 'ä»Šæ—¥' : daysUntil === 1 ? 'æ˜æ—¥' : `${daysUntil}æ—¥å¾Œ`;

      container.innerHTML = `
    <div class="next-date-box">
      <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 4px;">æ¬¡å›å¾©åˆ»æ—¥</div>
      <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-color);">${formatDate(nextDate)}ï¼ˆ${weekday}ï¼‰<span style="font-size: 0.8rem; color: ${daysUntil <= 1 ? '#fcd34d' : 'var(--text-secondary)'}; margin-left: 8px;">${dayLabel}</span></div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
      ${candidates.map((c, i) => `
        <div class="prediction-highlight" data-card="${c.key}">
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px;">
            <span class="rank-badge">${i === 0 ? 'ğŸ¥‡' : 'ğŸ¥ˆ'}</span>
            <span style="font-size: 0.65rem; background: rgba(167,139,250,0.2); border-radius: 999px; padding: 2px 8px; color: var(--accent-color);">äºˆæ¸¬${i + 1}æšç›®</span>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <img src="${c.imageUrl}" alt="${c.cardName}" class="card-img" loading="lazy" onerror="this.style.display='none'">
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 0.82rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.cardName}</div>
              <div style="font-size: 0.7rem; color: var(--text-secondary); margin: 2px 0;">${c.charName}</div>
              ${getAttrBadge(c.attr)}
            </div>
          </div>
          <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 10px;">
            æœ€çµ‚: ${c.daysSinceLast}æ—¥å‰ / å¹³å‡: ${c.prediction.averageInterval}æ—¥ / ${c.reprintCount}å›ç›®
          </div>
        </div>
      `).join('')}
    </div>
  `;
      container.querySelectorAll('.prediction-highlight').forEach(el => el.addEventListener('click', () => showCardDetail(el.dataset.card)));
    }

    function renderMonthlyList(predictions) {
      const container = document.getElementById('monthlyListView');
      if (predictions.length === 0) { container.innerHTML = '<div style="color: var(--text-secondary); padding: 20px;">äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
      const grouped = {};
      predictions.forEach(p => { const k = formatDate(p.date); if (!grouped[k]) grouped[k] = []; grouped[k].push(p); });
      container.innerHTML = Object.entries(grouped).map(([date, cards]) => {
        const d = new Date(date.replace(/\//g, '-'));
        const daysUntil = Math.round((d - today) / 864e5);
        const dayLabel = daysUntil === 0 ? 'ä»Šæ—¥' : daysUntil === 1 ? 'æ˜æ—¥' : `${daysUntil}æ—¥å¾Œ`;
        const weekday = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][d.getDay()];
        return `<div class="monthly-group">
      <div class="monthly-group-header">
        <div><span class="monthly-date">${date}</span><span style="color: var(--text-secondary); font-size: 0.75rem; margin-left: 6px;">ï¼ˆ${weekday}ï¼‰</span></div>
        <span style="font-size: 0.72rem; color: ${daysUntil <= 3 ? '#fcd34d' : 'var(--text-secondary)'};">${dayLabel}</span>
      </div>
      <div class="monthly-group-body">
        ${cards.map(c => `<div class="monthly-card" data-card="${c.key}">
          <img src="${c.imageUrl}" alt="${c.cardName}" loading="lazy" onerror="this.style.display='none'">
          <div style="flex: 1; min-width: 0;">
            <div style="font-size: 0.8rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.cardName}</div>
            <div style="font-size: 0.68rem; color: var(--text-secondary);">${c.charName}</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
            ${getConfBadge(c.confidence)}
            <span style="font-size: 0.65rem; color: var(--text-secondary);">${c.reprintCount}å›ç›®</span>
          </div>
        </div>`).join('')}
      </div>
    </div>`;
      }).join('');
      container.querySelectorAll('[data-card]').forEach(el => el.addEventListener('click', () => showCardDetail(el.dataset.card)));
    }

    function renderMonthlyCalendar(predictions) {
      const container = document.getElementById('monthlyCalendarView');
      const predMap = {}; predictions.forEach(p => { const k = formatDate(p.date); if (!predMap[k]) predMap[k] = []; predMap[k].push(p); });
      const start = new Date(today); start.setDate(start.getDate() - start.getDay());
      const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      let html = `<div class="cal-grid">`;
      html += weekdays.map((w, i) => `<div class="cal-header-cell ${i === 2 || i === 5 ? 'reprint-day' : ''}">${w}</div>`).join('');
      for (let i = 0; i < 35; i++) {
        const cur = new Date(start); cur.setDate(start.getDate() + i);
        const k = formatDate(cur);
        const isToday = formatDate(today) === k;
        const isPast = cur < today && !isToday;
        const isReprintDay = cur.getDay() === 2 || cur.getDay() === 5;
        const cards = predMap[k] || [];
        let cls = 'cal-cell';
        if (isToday) cls += ' is-today';
        if (isPast) cls += ' is-past';
        if (cards.length > 0) cls += ' has-pred';
        else if (isReprintDay) cls += ' reprint-day';
        html += `<div class="${cls}" data-date="${k}">
      <div class="cal-date ${isToday ? 'today-text' : isReprintDay ? 'reprint-text' : ''}">${cur.getDate()}${isReprintDay && !isPast && cards.length === 0 ? ' ğŸ“…' : ''}</div>
      ${cards.length > 0 ? `<div class="cal-chips">${cards.slice(0, 2).map(c => `<div class="cal-chip" title="${c.charName}: ${c.cardName}">${c.charName.length > 6 ? c.charName.substring(0, 6) + '..' : c.charName}</div>`).join('')}</div>` : ''}
    </div>`;
      }
      html += '</div>';
      container.innerHTML = html;
      container.querySelectorAll('[data-date]').forEach(cell => {
        const cards = predMap[cell.dataset.date];
        if (cards && cards.length > 0) cell.addEventListener('click', () => cards.length === 1 ? showCardDetail(cards[0].key) : showDateDetail(cell.dataset.date, cards));
      });
    }

    function showDateDetail(dateKey, cards) {
      const d = new Date(dateKey.replace(/\//g, '-'));
      const weekday = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][d.getDay()];
      document.getElementById('modalContent').innerHTML = `
    <h3 style="font-size: 1rem; font-weight: 700; margin-bottom: 4px; padding-right: 32px;">${dateKey}ï¼ˆ${weekday}ï¼‰</h3>
    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 12px;">${cards.length}æšã®ã‚«ãƒ¼ãƒ‰ãŒå¾©åˆ»äºˆæ¸¬</div>
    <div style="max-height: 320px; overflow-y: auto;">
      ${cards.map(c => `<div class="monthly-card" data-card="${c.key}">
        <img src="${c.imageUrl}" alt="${c.cardName}" style="width:44px;height:44px;object-fit:cover;object-position:top;border-radius:8px;" onerror="this.style.display='none'">
        <div style="flex:1;min-width:0;">
          <div style="font-size:0.82rem;font-weight:700;">${c.cardName}</div>
          <div style="font-size:0.7rem;color:var(--text-secondary);">${c.charName}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
          ${getConfBadge(c.confidence)}
          <span style="font-size:0.65rem;color:var(--text-secondary);">${c.reprintCount}å›ç›®</span>
        </div>
      </div>`).join('')}
    </div>
  `;
      document.getElementById('modalContent').querySelectorAll('[data-card]').forEach(el => el.addEventListener('click', () => showCardDetail(el.dataset.card)));
      document.getElementById('detailModal').classList.add('open');
    }

    function renderMonthlyPredictions() {
      const predictions = getMonthlyPredictions();
      const end = new Date(today); end.setDate(end.getDate() + 30);
      document.getElementById('dateRange').textContent = `${formatDate(today)} ã€œ ${formatDate(end)}ï¼ˆ${predictions.length}æšäºˆæ¸¬ï¼‰`;
      renderMonthlyList(predictions);
      renderMonthlyCalendar(predictions);
    }

    function setupEventListeners() {
      document.getElementById('searchInput').addEventListener('input', e => renderCardList(e.target.value));
      document.getElementById('closeModal').addEventListener('click', () => document.getElementById('detailModal').classList.remove('open'));
      document.getElementById('detailModal').addEventListener('click', e => { if (e.target === e.currentTarget) document.getElementById('detailModal').classList.remove('open'); });
      document.getElementById('viewList').addEventListener('click', () => {
        document.getElementById('viewList').classList.add('active');
        document.getElementById('viewCalendar').classList.remove('active');
        document.getElementById('monthlyListView').classList.remove('hidden');
        document.getElementById('monthlyCalendarView').classList.add('hidden');
      });
      document.getElementById('viewCalendar').addEventListener('click', () => {
        document.getElementById('viewCalendar').classList.add('active');
        document.getElementById('viewList').classList.remove('active');
        document.getElementById('monthlyCalendarView').classList.remove('hidden');
        document.getElementById('monthlyListView').classList.add('hidden');
      });
    }

    async function init() {
      const csvData = await loadCSV('../card_release.csv');
      if (!csvData) {
        document.getElementById('loading').innerHTML = `<div style="text-align:center;padding:30px;"><div style="font-size:2.5rem;margin-bottom:12px;">âš ï¸</div><h1 style="font-weight:700;margin-bottom:8px;">CSV ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h1><p style="color:var(--text-secondary);font-size:0.85rem;">card_release.csv ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚</p></div>`;
        return;
      }
      const data = parseCSV(csvData);
      cardMap = aggregateCards(data);
      allReprintDates = getNextReprintDates(today, 200);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('mainContent').classList.remove('hidden');
      renderCardList();
      renderNextReprintPrediction();
      renderMonthlyPredictions();
      setupEventListeners();
    }

    init();
  </script>
</body>

</html>
