<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚«ãƒ¼ãƒ‰å¾©åˆ»äºˆæ¸¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
    body { font-family: 'Noto Sans JP', sans-serif; }
    .card-item:hover { transform: translateX(4px); }
    .prediction-card { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%); }
    .glow { box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
    .card-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
    .card-img-large { width: 120px; height: 120px; object-fit: cover; border-radius: 12px; }
    .attr-ç« { background-color: rgba(239, 68, 68, 0.3); border-color: rgba(239, 68, 68, 0.5); }
    .attr-æ°´ { background-color: rgba(59, 130, 246, 0.3); border-color: rgba(59, 130, 246, 0.5); }
    .attr-è‰ { background-color: rgba(34, 197, 94, 0.3); border-color: rgba(34, 197, 94, 0.5); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-950 to-slate-900 text-white">
  <div id="loading" class="min-h-screen flex items-center justify-center">
    <div class="text-center">
      <div class="text-4xl mb-4 animate-pulse">ğŸ”®</div>
      <p class="text-slate-400">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>
  <div id="mainContent" class="hidden">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <header class="text-center mb-10">
        <h1 class="text-3xl font-bold bg-gradient-to-r from-violet-400 to-fuchsia-400 bg-clip-text text-transparent mb-2">ğŸ”® ã‚«ãƒ¼ãƒ‰å¾©åˆ»äºˆæ¸¬</h1>
        <p class="text-slate-400 text-sm">æ¯é€±ç«æ›œãƒ»é‡‘æ›œã«2æšãšã¤å¾©åˆ»ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰äºˆæ¸¬</p>
      </header>
      <section class="mb-10">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span class="text-2xl">âœ¨</span>æ¬¡å›å¾©åˆ»ã™ã‚‹ã‚«ãƒ¼ãƒ‰äºˆæ¸¬</h2>
        <div id="nextReprintPrediction" class="grid md:grid-cols-2 gap-4"></div>
      </section>
      <section class="mb-10">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span class="text-2xl">ğŸ“…</span>ä»Šå¾Œ1ã‹æœˆã®å¾©åˆ»äºˆæ¸¬</h2>
        <div class="text-sm text-slate-400 mb-3"><span id="dateRange"></span></div>
        <div class="flex gap-2 mb-4">
          <button id="viewList" class="px-4 py-2 rounded-lg bg-violet-600 text-white text-sm transition-all">ãƒªã‚¹ãƒˆè¡¨ç¤º</button>
          <button id="viewCalendar" class="px-4 py-2 rounded-lg bg-slate-700 text-slate-300 text-sm hover:bg-slate-600 transition-all">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º</button>
        </div>
        <div id="monthlyListView" class="space-y-2 max-h-[500px] overflow-y-auto pr-2"></div>
        <div id="monthlyCalendarView" class="hidden"><div id="calendarGrid" class="grid grid-cols-7 gap-1"></div></div>
      </section>
      <section>
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span class="text-2xl">ğŸ“‹</span>ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã‹ã‚‰é¸æŠ</h2>
        <div class="mb-4"><input type="text" id="searchInput" placeholder="ã‚«ãƒ¼ãƒ‰åãƒ»ã‚­ãƒ£ãƒ©åã§æ¤œç´¢..." class="w-full px-4 py-3 rounded-xl bg-slate-800/50 border border-slate-700 focus:border-violet-500 focus:outline-none focus:ring-2 focus:ring-violet-500/30 transition-all"></div>
        <div id="cardList" class="space-y-2 max-h-[500px] overflow-y-auto pr-2"></div>
      </section>
      <div id="detailModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <div class="prediction-card rounded-2xl p-6 max-w-md w-full glow relative max-h-[90vh] overflow-y-auto">
          <button id="closeModal" class="absolute top-4 right-4 text-slate-400 hover:text-white text-2xl">&times;</button>
          <div id="modalContent"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
let cardMap = null;
let today = new Date();
let allReprintDates = [];
const attrConfig = { 'ç«': { emoji: 'ğŸ”¥' }, 'æ°´': { emoji: 'ğŸ’§' }, 'è‰': { emoji: 'ğŸŒ¿' } };

async function loadCSV(filename) {
  try {
    const response = await fetch(filename);
    if (!response.ok) throw new Error('CSVèª­ã¿è¾¼ã¿å¤±æ•—');
    return await response.text();
  } catch (error) {
    console.error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    return null;
  }
}

function parseCSV(csv) {
  return csv.trim().split('\n').slice(1).map(line => {
    const v = line.split(',');
    return { charName: v[1], cardName: v[2], series: v[3], attr: v[4], startDate: parseDate(v[5]), endDate: parseDate(v[6]), reprintCount: parseInt(v[7]), imageUrl: v[8] };
  });
}
function parseDate(s) { const [y,m,d] = s.split('/').map(Number); return new Date(y, m-1, d); }
function formatDate(d) { return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; }

function aggregateCards(data) {
  const map = new Map();
  data.forEach(e => {
    const key = `${e.charName}_${e.cardName}`;
    if (!map.has(key)) map.set(key, { charName: e.charName, cardName: e.cardName, series: e.series, attr: e.attr, imageUrl: e.imageUrl, appearances: [], maxReprintCount: 0 });
    const c = map.get(key);
    c.appearances.push({ startDate: e.startDate, endDate: e.endDate, reprintCount: e.reprintCount });
    c.maxReprintCount = Math.max(c.maxReprintCount, e.reprintCount);
  });
  map.forEach(c => c.appearances.sort((a,b) => a.startDate - b.startDate));
  return map;
}

function calculateIntervals(appearances) {
  const intervals = [];
  for (let i = 1; i < appearances.length; i++) intervals.push(Math.round((appearances[i].startDate - appearances[i-1].startDate) / 864e5));
  return intervals;
}

function getNextReprintDates(from, count = 200) {
  const dates = []; const cur = new Date(from);
  while (dates.length < count) { if (cur.getDay() === 2 || cur.getDay() === 5) dates.push(new Date(cur)); cur.setDate(cur.getDate() + 1); }
  return dates;
}

function calculateReprintScore(card) {
  const last = card.appearances[card.appearances.length - 1].startDate;
  const days = Math.round((today - last) / 864e5);
  let avg = 60;
  if (card.appearances.length >= 2) { const iv = calculateIntervals(card.appearances); avg = Math.round(iv.reduce((a,b)=>a+b,0) / iv.length); }
  return { score: days / avg, daysSinceLast: days, avgInterval: avg, lastAppearance: last, reprintCount: card.maxReprintCount };
}

let cachedRankings = null;
function getRankings() {
  if (cachedRankings) return cachedRankings;
  const allScores = [];
  cardMap.forEach((c, k) => allScores.push({ key: k, score: calculateReprintScore(c).score }));
  allScores.sort((a,b) => b.score - a.score);
  cachedRankings = allScores;
  return cachedRankings;
}

function predictNextReprintCandidates() {
  const rankings = getRankings();
  const nextDate = allReprintDates[0];
  return rankings.slice(0, 2).map((r, i) => {
    const c = cardMap.get(r.key);
    const score = calculateReprintScore(c);
    return {
      key: r.key, charName: c.charName, cardName: c.cardName, imageUrl: c.imageUrl, attr: c.attr, series: c.series,
      prediction: { predictedDate: nextDate, confidence: r.score > 1.2 ? 'high' : r.score > 0.8 ? 'medium' : 'low', averageInterval: score.avgInterval, lastAppearance: score.lastAppearance },
      daysUntil: Math.round((nextDate - today) / 864e5), daysSinceLast: score.daysSinceLast, score: r.score, reprintCount: score.reprintCount
    };
  });
}

function getMonthlyPredictions() {
  const end = new Date(today); end.setDate(end.getDate() + 30);
  const reprintDates = allReprintDates.filter(d => d <= end);
  const rankings = getRankings();
  const predictions = [], used = new Set();
  reprintDates.forEach(date => {
    let assigned = 0;
    for (const r of rankings) {
      if (assigned >= 2 || used.has(r.key)) continue;
      const c = cardMap.get(r.key);
      const score = calculateReprintScore(c);
      predictions.push({ key: r.key, charName: c.charName, cardName: c.cardName, imageUrl: c.imageUrl, attr: c.attr, series: c.series, date, confidence: r.score > 1.2 ? 'high' : r.score > 0.8 ? 'medium' : 'low', averageInterval: score.avgInterval, reprintCount: score.reprintCount, daysSinceLast: score.daysSinceLast, score: r.score });
      used.add(r.key); assigned++;
    }
  });
  return predictions.sort((a,b) => a.date - b.date);
}

function getAttrBadge(attr) { const c = attrConfig[attr] || { emoji: '' }; return `<span class="text-xs px-2 py-0.5 rounded border attr-${attr}">${c.emoji} ${attr}</span>`; }

function renderCardList(filter = '') {
  const list = document.getElementById('cardList');
  const cards = Array.from(cardMap.entries()).filter(([k, c]) => c.cardName.includes(filter) || c.charName.includes(filter)).sort((a,b) => a[1].charName.localeCompare(b[1].charName, 'ja'));
  list.innerHTML = cards.map(([k, c]) => {
    const last = c.appearances[c.appearances.length - 1].startDate;
    return `<div class="card-item bg-slate-800/40 hover:bg-slate-700/50 rounded-xl p-3 cursor-pointer transition-all border border-slate-700/50" data-card="${k}"><div class="flex items-center gap-3"><img src="${c.imageUrl}" alt="${c.cardName}" class="card-img" loading="lazy" onerror="this.style.display='none'"><div class="flex-1 min-w-0"><div class="font-medium text-sm truncate">${c.cardName}</div><div class="text-xs text-slate-400">${c.charName}</div><div class="flex items-center gap-2 mt-1">${getAttrBadge(c.attr)}<span class="text-xs text-slate-500">${c.series}</span></div></div><div class="text-right"><div class="text-violet-400 text-sm">${c.maxReprintCount}å›</div><div class="text-xs text-slate-500">${formatDate(last)}</div></div></div></div>`;
  }).join('');
  list.querySelectorAll('.card-item').forEach(el => el.addEventListener('click', () => showCardDetail(el.dataset.card)));
}

function showCardDetail(key) {
  const card = cardMap.get(key);
  const score = calculateReprintScore(card);
  const rankings = getRankings();
  const rank = rankings.findIndex(r => r.key === key) + 1;
  const dateIndex = Math.floor((rank - 1) / 2);
  const predictedDate = allReprintDates[dateIndex] || allReprintDates[allReprintDates.length - 1];
  const confidence = score.score > 1.2 ? 'high' : score.score > 0.8 ? 'medium' : 'low';
  const intervals = card.appearances.length >= 2 ? calculateIntervals(card.appearances) : [];
  const daysUntil = Math.round((predictedDate - today) / 864e5);
  const weekday = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][predictedDate.getDay()];
  const status = daysUntil === 0 ? '(ä»Šæ—¥!)' : daysUntil === 1 ? '(æ˜æ—¥!)' : `(ã‚ã¨${daysUntil}æ—¥)`;
  const confColors = { high: 'text-green-400', medium: 'text-yellow-400', low: 'text-red-400' };
  const confLabels = { high: 'é«˜', medium: 'ä¸­', low: 'ä½' };
  document.getElementById('modalContent').innerHTML = `
    <div class="flex items-start gap-4 mb-4"><img src="${card.imageUrl}" alt="${card.cardName}" class="card-img-large" onerror="this.style.display='none'"><div class="flex-1 min-w-0 pr-8"><h3 class="text-lg font-bold mb-1">${card.cardName}</h3><div class="text-slate-300 mb-2">${card.charName}</div><div class="flex items-center gap-2">${getAttrBadge(card.attr)}<span class="text-xs text-slate-400">${card.series}</span></div></div></div>
    <div class="bg-slate-800/50 rounded-xl p-4 mb-4"><div class="text-sm text-slate-400 mb-1">æ¬¡å›å¾©åˆ»äºˆæ¸¬</div><div class="text-2xl font-bold text-violet-300">${formatDate(predictedDate)} (${weekday})</div><div class="text-sm ${daysUntil <= 3 ? 'text-yellow-400' : 'text-slate-400'}">${status}</div><div class="text-xs text-slate-500 mt-2">å¾©åˆ»å„ªå…ˆé †ä½: ${rank}ä½ / ${rankings.length}æšä¸­</div></div>
    <div class="grid grid-cols-3 gap-3 mb-4"><div class="bg-slate-800/30 rounded-lg p-3"><div class="text-xs text-slate-400">æœ€çµ‚å¾©åˆ»ã‹ã‚‰</div><div class="text-lg font-bold">${score.daysSinceLast}æ—¥</div></div><div class="bg-slate-800/30 rounded-lg p-3"><div class="text-xs text-slate-400">å¹³å‡é–“éš”</div><div class="text-lg font-bold">${score.avgInterval}æ—¥</div></div><div class="bg-slate-800/30 rounded-lg p-3"><div class="text-xs text-slate-400">äºˆæ¸¬ä¿¡é ¼åº¦</div><div class="text-lg font-bold ${confColors[confidence]}">${confLabels[confidence]}</div></div></div>
    <div class="mb-4"><div class="text-sm text-slate-400 mb-2">å¾©åˆ»å±¥æ­´ (${card.maxReprintCount}å›)</div><div class="space-y-1 max-h-32 overflow-y-auto">${card.appearances.map((a,i) => `<div class="text-sm flex justify-between bg-slate-800/30 rounded px-3 py-1"><span>${i+1}å›ç›®</span><span class="text-slate-300">${formatDate(a.startDate)}</span></div>`).join('')}</div></div>
    ${intervals.length > 0 ? `<div class="text-xs text-slate-500">å¾©åˆ»é–“éš”: ${intervals.join('æ—¥, ')}æ—¥</div>` : ''}`;
  document.getElementById('detailModal').classList.remove('hidden');
  document.getElementById('detailModal').classList.add('flex');
}

function renderNextReprintPrediction() {
  const candidates = predictNextReprintCandidates();
  const container = document.getElementById('nextReprintPrediction');
  if (candidates.length === 0) { container.innerHTML = '<div class="text-slate-400">äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  const nextDate = candidates[0].prediction.predictedDate;
  const weekday = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][nextDate.getDay()];
  const daysUntil = candidates[0].daysUntil;
  const dayLabel = daysUntil === 0 ? 'ä»Šæ—¥' : daysUntil === 1 ? 'æ˜æ—¥' : `${daysUntil}æ—¥å¾Œ`;
  container.innerHTML = `<div class="md:col-span-2 bg-slate-800/40 rounded-xl p-4 mb-2 border border-violet-500/30"><div class="text-sm text-slate-400 mb-1">æ¬¡å›å¾©åˆ»æ—¥</div><div class="text-xl font-bold text-violet-300">${formatDate(nextDate)} (${weekday}) <span class="text-sm ${daysUntil <= 1 ? 'text-yellow-400' : 'text-slate-400'}">${dayLabel}</span></div></div>` +
    candidates.map((c, i) => `<div class="prediction-card rounded-xl p-4 glow border border-violet-500/30 cursor-pointer hover:scale-[1.02] transition-transform" data-card="${c.key}"><div class="flex items-center gap-2 mb-3"><span class="text-2xl">${i === 0 ? 'ğŸ¥‡' : 'ğŸ¥ˆ'}</span><span class="text-xs bg-violet-500/30 px-2 py-0.5 rounded-full">äºˆæ¸¬${i+1}æšç›®</span></div><div class="flex items-center gap-3"><img src="${c.imageUrl}" alt="${c.cardName}" class="card-img" loading="lazy" onerror="this.style.display='none'"><div class="flex-1 min-w-0"><h3 class="font-bold text-sm truncate">${c.cardName}</h3><div class="text-xs text-slate-300 mb-1">${c.charName}</div><div class="flex items-center gap-2">${getAttrBadge(c.attr)}</div></div></div><div class="text-xs text-slate-400 mt-3 space-y-0.5"><div>æœ€çµ‚å¾©åˆ»: ${c.daysSinceLast}æ—¥å‰</div><div>å¹³å‡é–“éš”: ${c.prediction.averageInterval}æ—¥ | ${c.reprintCount}å›ç›®</div></div></div>`).join('');
  container.querySelectorAll('.prediction-card').forEach(el => el.addEventListener('click', () => showCardDetail(el.dataset.card)));
}

function renderMonthlyList(predictions) {
  const container = document.getElementById('monthlyListView');
  const confColors = { high: 'bg-green-500/20 text-green-400 border-green-500/30', medium: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30', low: 'bg-red-500/20 text-red-400 border-red-500/30' };
  const confLabels = { high: 'é«˜', medium: 'ä¸­', low: 'ä½' };
  if (predictions.length === 0) { container.innerHTML = '<div class="text-slate-400 p-4">äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  const grouped = {};
  predictions.forEach(p => { const k = formatDate(p.date); if (!grouped[k]) grouped[k] = []; grouped[k].push(p); });
  container.innerHTML = Object.entries(grouped).map(([date, cards]) => {
    const d = new Date(date.replace(/\//g, '-'));
    const daysUntil = Math.round((d - today) / 864e5);
    const dayLabel = daysUntil === 0 ? 'ä»Šæ—¥' : daysUntil === 1 ? 'æ˜æ—¥' : `${daysUntil}æ—¥å¾Œ`;
    const weekday = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
    return `<div class="bg-slate-800/40 rounded-xl overflow-hidden border border-slate-700/50"><div class="bg-slate-700/50 px-4 py-2 flex justify-between items-center"><div class="font-medium"><span class="text-violet-300">${date}</span><span class="text-slate-400 text-sm ml-2">(${weekday})</span></div><span class="text-xs ${daysUntil <= 3 ? 'text-yellow-400' : 'text-slate-400'}">${dayLabel}</span></div><div class="p-2 space-y-1">${cards.map(c => `<div class="flex items-center gap-3 bg-slate-800/50 rounded-lg px-3 py-2 cursor-pointer hover:bg-slate-700/50 transition-all" data-card="${c.key}"><img src="${c.imageUrl}" alt="${c.cardName}" class="w-10 h-10 rounded object-cover" loading="lazy" onerror="this.style.display='none'"><div class="flex-1 min-w-0"><div class="font-medium text-sm truncate">${c.cardName}</div><div class="text-xs text-slate-400">${c.charName}</div></div><div class="flex items-center gap-2"><span class="text-xs px-2 py-0.5 rounded border ${confColors[c.confidence]}">${confLabels[c.confidence]}</span><span class="text-xs text-slate-400">${c.reprintCount}å›ç›®</span></div></div>`).join('')}</div></div>`;
  }).join('');
  container.querySelectorAll('[data-card]').forEach(el => el.addEventListener('click', () => showCardDetail(el.dataset.card)));
}

function renderMonthlyCalendar(predictions) {
  const container = document.getElementById('calendarGrid');
  const predMap = {}; predictions.forEach(p => { const k = formatDate(p.date); if (!predMap[k]) predMap[k] = []; predMap[k].push(p); });
  const start = new Date(today); start.setDate(start.getDate() - start.getDay());
  const weekdays = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  let html = weekdays.map((w,i) => `<div class="text-center text-xs py-2 ${i === 2 || i === 5 ? 'text-violet-400 font-bold' : 'text-slate-400'}">${w}</div>`).join('');
  for (let i = 0; i < 35; i++) {
    const cur = new Date(start); cur.setDate(start.getDate() + i);
    const k = formatDate(cur);
    const isToday = formatDate(today) === k;
    const isPast = cur < today && !isToday;
    const isReprintDay = cur.getDay() === 2 || cur.getDay() === 5;
    const cards = predMap[k] || [];
    let bg = isToday ? 'bg-violet-600/30 border-violet-500' : cards.length > 0 ? 'bg-fuchsia-900/40 border-fuchsia-500/50 hover:bg-fuchsia-800/50 cursor-pointer' : isReprintDay && !isPast ? 'bg-slate-700/30 border-slate-600/50' : 'bg-slate-800/30 border-slate-700/30';
    html += `<div class="min-h-[80px] p-1 rounded-lg border ${bg} ${isPast ? 'opacity-40' : ''} transition-all" data-date="${k}"><div class="text-xs ${isToday ? 'text-violet-300 font-bold' : isReprintDay ? 'text-violet-400' : 'text-slate-400'} mb-1">${cur.getDate()}${isReprintDay && !isPast && cards.length === 0 ? ' ğŸ“…' : ''}</div>${cards.length > 0 ? `<div class="space-y-0.5">${cards.slice(0,2).map(c => `<div class="text-[10px] bg-violet-500/30 text-violet-200 rounded px-1 py-0.5 truncate" title="${c.charName}: ${c.cardName}">${c.charName.length > 6 ? c.charName.substring(0,6)+'..' : c.charName}</div>`).join('')}</div>` : ''}</div>`;
  }
  container.innerHTML = html;
  container.querySelectorAll('[data-date]').forEach(cell => {
    const cards = predMap[cell.dataset.date];
    if (cards && cards.length > 0) cell.addEventListener('click', () => cards.length === 1 ? showCardDetail(cards[0].key) : showDateDetail(cell.dataset.date, cards));
  });
}

function showDateDetail(dateKey, cards) {
  const d = new Date(dateKey.replace(/\//g, '-'));
  const weekday = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
  const confLabels = { high: 'é«˜', medium: 'ä¸­', low: 'ä½' };
  const confColors = { high: 'text-green-400', medium: 'text-yellow-400', low: 'text-red-400' };
  document.getElementById('modalContent').innerHTML = `<h3 class="text-xl font-bold mb-4 pr-8">${dateKey} (${weekday})</h3><div class="text-sm text-slate-400 mb-3">${cards.length}æšã®ã‚«ãƒ¼ãƒ‰ãŒå¾©åˆ»äºˆæ¸¬</div><div class="space-y-2 max-h-80 overflow-y-auto">${cards.map(c => `<div class="flex items-center gap-3 bg-slate-800/50 rounded-lg p-3 cursor-pointer hover:bg-slate-700/50 transition-all" data-card="${c.key}"><img src="${c.imageUrl}" alt="${c.cardName}" class="w-12 h-12 rounded object-cover" onerror="this.style.display='none'"><div class="flex-1 min-w-0"><div class="font-medium text-sm">${c.cardName}</div><div class="text-xs text-slate-400">${c.charName}</div><div class="flex items-center gap-3 text-xs text-slate-400 mt-1"><span>å¾©åˆ»${c.reprintCount}å›ç›®</span><span class="${confColors[c.confidence]}">ä¿¡é ¼åº¦: ${confLabels[c.confidence]}</span></div></div></div>`).join('')}</div>`;
  document.getElementById('modalContent').querySelectorAll('[data-card]').forEach(el => el.addEventListener('click', () => showCardDetail(el.dataset.card)));
  document.getElementById('detailModal').classList.remove('hidden');
  document.getElementById('detailModal').classList.add('flex');
}

function renderMonthlyPredictions() {
  const predictions = getMonthlyPredictions();
  const end = new Date(today); end.setDate(end.getDate() + 30);
  document.getElementById('dateRange').textContent = `${formatDate(today)} ã€œ ${formatDate(end)} ï¼ˆ${predictions.length}æšäºˆæ¸¬ï¼‰`;
  renderMonthlyList(predictions);
  renderMonthlyCalendar(predictions);
}

function setupEventListeners() {
  document.getElementById('searchInput').addEventListener('input', e => renderCardList(e.target.value));
  document.getElementById('closeModal').addEventListener('click', () => { document.getElementById('detailModal').classList.add('hidden'); document.getElementById('detailModal').classList.remove('flex'); });
  document.getElementById('detailModal').addEventListener('click', e => { if (e.target === e.currentTarget) { document.getElementById('detailModal').classList.add('hidden'); document.getElementById('detailModal').classList.remove('flex'); } });
  document.getElementById('viewList').addEventListener('click', () => { document.getElementById('viewList').className = 'px-4 py-2 rounded-lg bg-violet-600 text-white text-sm transition-all'; document.getElementById('viewCalendar').className = 'px-4 py-2 rounded-lg bg-slate-700 text-slate-300 text-sm hover:bg-slate-600 transition-all'; document.getElementById('monthlyListView').classList.remove('hidden'); document.getElementById('monthlyCalendarView').classList.add('hidden'); });
  document.getElementById('viewCalendar').addEventListener('click', () => { document.getElementById('viewCalendar').className = 'px-4 py-2 rounded-lg bg-violet-600 text-white text-sm transition-all'; document.getElementById('viewList').className = 'px-4 py-2 rounded-lg bg-slate-700 text-slate-300 text-sm hover:bg-slate-600 transition-all'; document.getElementById('monthlyCalendarView').classList.remove('hidden'); document.getElementById('monthlyListView').classList.add('hidden'); });
}

async function init() {
  const csvData = await loadCSV('card_release.csv');
  if (!csvData) {
    document.getElementById('loading').innerHTML = `<div class="text-center p-8"><div class="text-4xl mb-4">âš ï¸</div><h1 class="text-xl font-bold mb-2">CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h1><p class="text-slate-400">card_release.csv ã‚’HTMLã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã—ã¦ãã ã•ã„</p></div>`;
    return;
  }
  const data = parseCSV(csvData);
  cardMap = aggregateCards(data);
  allReprintDates = getNextReprintDates(today, 200);
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('mainContent').classList.remove('hidden');
  renderCardList();
  renderNextReprintPrediction();
  renderMonthlyPredictions();
  setupEventListeners();
}

init();
  </script>
</body>
</html>
