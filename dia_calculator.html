import React, { useState } from 'react';
import { Calculator } from 'lucide-react';

const DiamondCalculator = () => {
  const [currentDiamonds, setCurrentDiamonds] = useState('');
  const [isFirstPurchase, setIsFirstPurchase] = useState(false);
  const [purchases, setPurchases] = useState({
    80: 0,
    325: 0,
    500: 0,
    1100: 0,
    2100: 0,
    5000: 0
  });

  const products = [
    { name: 'æœ‰å„Ÿãƒ€ã‚¤ãƒ¤80å€‹', price: 160, diamonds: 80, bonus: 8 },
    { name: 'æœ‰å„Ÿãƒ€ã‚¤ãƒ¤325å€‹', price: 650, diamonds: 325, bonus: 38 },
    { name: 'æœ‰å„Ÿãƒ€ã‚¤ãƒ¤500å€‹', price: 1000, diamonds: 500, bonus: 68 },
    { name: 'æœ‰å„Ÿãƒ€ã‚¤ãƒ¤1100å€‹', price: 2200, diamonds: 1100, bonus: 188 },
    { name: 'æœ‰å„Ÿãƒ€ã‚¤ãƒ¤2100å€‹', price: 4200, diamonds: 2100, bonus: 388 },
    { name: 'æœ‰å„Ÿãƒ€ã‚¤ãƒ¤5000å€‹', price: 10000, diamonds: 5000, bonus: 1088 }
  ];

  const cumulativeRewards = [
    { threshold: 100, diamonds: 120, other: '' },
    { threshold: 500, diamonds: 480, other: '' },
    { threshold: 1000, diamonds: 600, other: '' },
    { threshold: 2000, diamonds: 1200, other: '' },
    { threshold: 10000, diamonds: 6000, other: '' },
    { threshold: 15000, diamonds: 3500, other: '10æ™‚é–“ãƒ‘ã‚¹ãƒã‚±ãƒƒãƒˆ2æš' },
    { threshold: 20000, diamonds: 4500, other: '10æ™‚é–“ãƒ‘ã‚¹ãƒã‚±ãƒƒãƒˆ3æš' },
    { threshold: 30000, diamonds: 9000, other: '10æ™‚é–“ãƒ‘ã‚¹ãƒã‚±ãƒƒãƒˆ3æš' }
  ];

  const purchaseRewards = [
    { type: 80, count: 1, diamonds: 80, other: '2æ™‚é–“ãƒ‘ã‚¹ãƒã‚±ãƒƒãƒˆ1æš' },
    { type: 325, count: 1, diamonds: 163, other: '2æ™‚é–“ãƒ‘ã‚¹ãƒã‚±ãƒƒãƒˆ1æšã€é³³å‡°ã®ç¾½æ ¹(é’)2æš' },
    { type: 500, count: 1, diamonds: 250, other: '2æ™‚é–“ãƒ‘ã‚¹ãƒã‚±ãƒƒãƒˆ1æšã€é³³å‡°ã®ç¾½æ ¹(é’)6æš' },
    { type: 1100, count: 1, diamonds: 550, other: '2æ™‚é–“ãƒ‘ã‚¹ãƒã‚±ãƒƒãƒˆ1æšã€é³³å‡°ã®ç¾½æ ¹(é’)6æš' },
    { type: 2100, count: 1, diamonds: 1050, other: '5æ™‚é–“ãƒ‘ã‚¹ãƒã‚±ãƒƒãƒˆ1æšã€é³³å‡°ã®ç¾½æ ¹(é’)12æš' },
    { type: 2100, count: 2, diamonds: 1050, other: '5æ™‚é–“ãƒ‘ã‚¹ãƒã‚±ãƒƒãƒˆ1æšã€é³³å‡°ã®ç¾½æ ¹(é’)30æš' },
    { type: 5000, count: 1, diamonds: 2500, other: '5æ™‚é–“ãƒ‘ã‚¹ãƒã‚±ãƒƒãƒˆ1æšã€é³³å‡°ã®ç¾½æ ¹(é’)30æš' },
    { type: 5000, count: 2, diamonds: 2500, other: '5æ™‚é–“ãƒ‘ã‚¹ãƒã‚±ãƒƒãƒˆ1æšã€é³³å‡°ã®ç¾½æ ¹(é’)80æš' },
    { type: 5000, count: 3, diamonds: 2500, other: '5æ™‚é–“ãƒ‘ã‚¹ãƒã‚±ãƒƒãƒˆ1æšã€é³³å‡°ã®ç¾½æ ¹(é’)80æš' }
  ];

  const calculate = () => {
    let totalPaidDiamonds = 0;
    let totalBonus = 0;
    let totalFirstPurchaseBonus = 0;
    let breakdown = [];
    let totalPrice = 0;

    // å•†å“ã”ã¨ã®è³¼å…¥è¨ˆç®—
    products.forEach((product) => {
      const count = purchases[product.diamonds] || 0;
      if (count > 0) {
        const baseDiamonds = product.diamonds * count;
        const bonus = product.bonus * count;
        
        totalPaidDiamonds += baseDiamonds;
        totalBonus += bonus;
        totalPrice += product.price * count;

        // åˆå›è³¼å…¥ãƒœãƒ¼ãƒŠã‚¹
        if (isFirstPurchase) {
          totalFirstPurchaseBonus += baseDiamonds;
          breakdown.push({
            label: 'åˆå›è³¼å…¥2å€ã‚µãƒ¼ãƒ“ã‚¹',
            amount: baseDiamonds.toLocaleString()
          });
        }

        breakdown.push({
          label: 'ãŠã¾ã‘',
          amount: bonus.toLocaleString()
        });
      }
    });

    // è³¼å…¥å›æ•°ç‰¹å…¸
    Object.entries(purchases).forEach(([diamonds, count]) => {
      if (count > 0) {
        const reward = purchaseRewards.find(
          r => r.type === parseInt(diamonds) && r.count === count
        );
        if (reward) {
          totalBonus += reward.diamonds;
          breakdown.push({
            label: `è³¼å…¥ç‰¹å…¸ï¼ˆæœ‰å„Ÿãƒ€ã‚¤ãƒ¤${diamonds}å€‹ã‚’${count}å›è³¼å…¥ï¼‰`,
            amount: reward.diamonds.toLocaleString(),
            other: reward.other
          });
        }
      }
    });

    // ç´¯è¨ˆè³¼å…¥ç‰¹å…¸
    const achievedRewards = [];
    cumulativeRewards.forEach((reward) => {
      if (totalPaidDiamonds >= reward.threshold) {
        totalBonus += reward.diamonds;
        achievedRewards.push(reward);
        breakdown.push({
          label: `è³¼å…¥ç‰¹å…¸ï¼ˆæœ‰å„Ÿãƒ€ã‚¤ãƒ¤ã‚’åˆè¨ˆ${reward.threshold.toLocaleString()}å€‹è³¼å…¥ï¼‰`,
          amount: reward.diamonds.toLocaleString(),
          other: reward.other
        });
      }
    });

    // æ¬¡ã®ç‰¹å…¸ã¾ã§ã®è¨ˆç®—
    const nextReward = cumulativeRewards.find(r => r.threshold > totalPaidDiamonds);
    const remaining = nextReward ? nextReward.threshold - totalPaidDiamonds : 0;

    const totalIncrease = totalPaidDiamonds + totalFirstPurchaseBonus + totalBonus;
    const finalTotal = (parseInt(currentDiamonds) || 0) + totalIncrease;

    return {
      totalIncrease,
      finalTotal,
      breakdown,
      totalPrice,
      nextReward,
      remaining
    };
  };

  const result = calculate();

  const handlePurchaseChange = (diamonds, value) => {
    const count = Math.max(0, Math.min(3, parseInt(value) || 0));
    setPurchases({ ...purchases, [diamonds]: count });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 p-6">
      <div className="max-w-4xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
          <div className="flex items-center gap-3 mb-6">
            <Calculator className="text-purple-600" size={32} />
            <h1 className="text-3xl font-bold text-gray-800">ãƒ€ã‚¤ãƒ¤ç²å¾—è¨ˆç®—ã‚¢ãƒ—ãƒª</h1>
          </div>

          {/* ç¾åœ¨ã®ãƒ€ã‚¤ãƒ¤æ•° */}
          <div className="mb-6">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              ç¾åœ¨ã®ãƒ€ã‚¤ãƒ¤æ•°ï¼ˆä»»æ„ï¼‰
            </label>
            <input
              type="number"
              value={currentDiamonds}
              onChange={(e) => setCurrentDiamonds(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
              placeholder="0"
            />
          </div>

          {/* åˆå›è³¼å…¥ãƒã‚§ãƒƒã‚¯ */}
          <div className="mb-6">
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={isFirstPurchase}
                onChange={(e) => setIsFirstPurchase(e.target.checked)}
                className="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500"
              />
              <span className="text-sm font-medium text-gray-700">
                åˆå›è³¼å…¥ï¼ˆãƒ€ã‚¤ãƒ¤2å€ãƒœãƒ¼ãƒŠã‚¹é©ç”¨ï¼‰
              </span>
            </label>
          </div>

          {/* å•†å“é¸æŠ */}
          <div className="mb-8">
            <h2 className="text-xl font-bold text-gray-800 mb-4">è³¼å…¥ã™ã‚‹å•†å“ï¼ˆå„3ã¤ã¾ã§ï¼‰</h2>
            <div className="space-y-3">
              {products.map((product) => (
                <div key={product.diamonds} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                  <div className="flex-1">
                    <div className="font-semibold text-gray-800">{product.name}</div>
                    <div className="text-sm text-gray-600">
                      Â¥{product.price.toLocaleString()} / ãƒ€ã‚¤ãƒ¤{product.diamonds}å€‹ + ãŠã¾ã‘{product.bonus}å€‹
                    </div>
                  </div>
                  <input
                    type="number"
                    min="0"
                    max="3"
                    value={purchases[product.diamonds]}
                    onChange={(e) => handlePurchaseChange(product.diamonds, e.target.value)}
                    className="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  />
                </div>
              ))}
            </div>
          </div>

          {/* çµæœè¡¨ç¤º */}
          {result.totalIncrease > 0 && (
            <div className="bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">è¨ˆç®—çµæœ</h2>
              
              <div className="bg-white rounded-lg p-4 mb-4">
                <div className="flex justify-between items-center mb-2">
                  <span className="text-lg font-semibold text-gray-700">æ”¯æ‰•é‡‘é¡</span>
                  <span className="text-2xl font-bold text-red-600">Â¥{result.totalPrice.toLocaleString()}</span>
                </div>
                <div className="flex justify-between items-center mb-2">
                  <span className="text-lg font-semibold text-gray-700">å¢—ãˆãŸãƒ€ã‚¤ãƒ¤</span>
                  <span className="text-2xl font-bold text-purple-600">{result.totalIncrease.toLocaleString()}å€‹</span>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-lg font-semibold text-gray-700">åˆè¨ˆãƒ€ã‚¤ãƒ¤</span>
                  <span className="text-3xl font-bold text-pink-600">{result.finalTotal.toLocaleString()}å€‹</span>
                </div>
              </div>

              {/* å†…è¨³ */}
              <div className="bg-white rounded-lg p-4">
                <h3 className="font-bold text-gray-800 mb-3">å†…è¨³</h3>
                <div className="space-y-2">
                  {result.breakdown.map((item, index) => (
                    <div key={index} className="flex justify-between items-start text-sm">
                      <span className="text-gray-700">{item.label}</span>
                      <div className="text-right">
                        <span className="font-semibold text-gray-800">{item.amount}å€‹</span>
                        {item.other && (
                          <div className="text-xs text-gray-500">{item.other}</div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* æ¬¡ã®ç‰¹å…¸ã¾ã§ */}
              {result.nextReward && result.remaining > 0 && (
                <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-4 rounded">
                  <p className="text-sm font-semibold text-yellow-800">
                    ã‚ã¨<span className="text-lg mx-1">{result.remaining.toLocaleString()}</span>å€‹è³¼å…¥ã§
                    <span className="text-lg mx-1">{result.nextReward.diamonds.toLocaleString()}</span>å€‹ã®ç‰¹å…¸ç²å¾—ï¼
                    {result.nextReward.other && ` (${result.nextReward.other})`}
                  </p>
                </div>
              )}
            </div>
          )}
        </div>

        {/* æ³¨æ„äº‹é … */}
        <div className="bg-white rounded-lg p-4 text-sm text-gray-600">
          <p className="font-semibold mb-2">ğŸ’¡ ã”æ³¨æ„</p>
          <ul className="list-disc list-inside space-y-1">
            <li>è³¼è²·ç‰¹å…¸ã¯æ¯æ—¥0æ™‚ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</li>
            <li>åˆå›è³¼å…¥ãƒœãƒ¼ãƒŠã‚¹ã¯æœˆã«1å›ã®ã¿é©ç”¨ã•ã‚Œã¾ã™</li>
            <li>å„å•†å“ã¯æœ€å¤§3ã¤ã¾ã§é¸æŠå¯èƒ½ã§ã™</li>
          </ul>
        </div>
      </div>
    </div>
  );
};

export default DiamondCalculator;
